<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="light">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Carregando Loja...</title>
    
    <!-- SEO & Compartilhamento -->
    <meta name="description" id="meta-desc" content="Confira nossa vitrine online!">
    <meta property="og:title" id="og-title" content="Loja Online">
    <meta property="og:description" id="og-desc" content="Qualidade e confian√ßa em cada detalhe.">
    <meta property="og:image" id="og-img" content="">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { primary: 'var(--color-primary)', primaryDark: 'var(--color-primary-dark)' },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out', 
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'bounce-short': 'bounceShort 0.5s ease-in-out 1',
                        'zoom-in': 'zoomIn 0.3s ease-out forwards',
                        'heart-beat': 'heartBeat 0.3s ease-in-out'
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        slideUp: { from: { opacity: 0, transform: 'translateY(20px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        bounceShort: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' } },
                        heartBeat: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.3)' }, '100%': { transform: 'scale(1)' } },
                        zoomIn: { from: { transform: 'scale(0.95)', opacity: 0 }, to: { transform: 'scale(1)', opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --color-primary: #EA1D2C; --color-primary-dark: #b91c29; }
        body { background-color: #F3F4F6; color: #334155; -webkit-font-smoothing: antialiased; }
        .glass-header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .chip-common { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; user-select: none; }
        .active-scale:active { transform: scale(0.95); }
        .product-card { 
            background: white; border-radius: 12px; overflow: hidden; transition: all 0.3s ease; border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: var(--color-primary); }
        .heart-active { fill: var(--color-primary); color: var(--color-primary); animation: heartBeat 0.4s forwards; }
        .thumb-active { border-color: var(--color-primary); opacity: 1; }
        .thumb-inactive { border-color: transparent; opacity: 0.6; }
        .chip-disabled { opacity: 0.25; pointer-events: none; background: #f1f5f9; border-color: #e2e8f0; text-decoration: line-through; color: #94a3b8; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
         /* Localize o final do seu <style> e cole isto: */

#modalImageZoom {
    touch-action: none; /* Bloqueia o arrastar da p√°gina para focar no swipe */
    user-select: none;
    -webkit-user-select: none;
}

#zoomedImg {
    transition: opacity 0.2s ease-in-out, transform 0.3s ease-out;
}
/* For√ßa o esquema de cores para claro */
:root {
    color-scheme: light !important;
}

/* Bloqueia a invers√£o de cores em navegadores que ignoram o sistema */
@media (prefers-color-scheme: dark) {
    body {
        background-color: #F3F4F6 !important; /* Seu fundo cinza claro */
        color: #334155 !important;           /* Seu texto slate */
    }

    /* For√ßa os elementos brancos a continuarem brancos */
    .glass-header, 
    .product-card, 
    footer, 
    #modalDetails .bg-white,
    #modalCart .bg-white,
    #filterDrawer,
    #modalDelivery .bg-white {
        background-color: #FFFFFF !important;
        color: #334155 !important;
    }

    /* Impede que o navegador mude as cores das imagens/logos */
    img {
        filter: none !important;
    }

    /* Garante que os inputs n√£o fiquem com fundo preto e texto branco */
    input, select, textarea {
        background-color: #FFFFFF !important;
        color: #334155 !important;
    }
}

    </style>
</head>
<body class="flex flex-col min-h-screen relative bg-[#F3F4F6] text-[#334155]">

    <!-- ERROR SCREEN -->
    <div id="errorScreen" class="fixed inset-0 z-[10000] bg-slate-900 hidden flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-slate-800 p-6 rounded-full mb-6 shadow-2xl">
            <i data-lucide="store" class="w-16 h-16 text-slate-400"></i>
        </div>
        <h1 id="errorTitle" class="text-3xl font-bold text-white mb-3">Loja Indispon√≠vel</h1>
        <p id="errorMsg" class="text-slate-400 max-w-md">N√£o foi poss√≠vel carregar as informa√ß√µes.</p>
        <button onclick="window.location.reload()" class="mt-8 px-6 py-2 bg-primary text-white rounded-full font-bold">Tentar novamente</button>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed bottom-6 left-0 right-0 z-[9999] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

    <!-- INITIAL LOADER -->
    <div id="initialLoader" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-primary rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-bold text-slate-400 animate-pulse uppercase tracking-widest">Sincronizando Vitrine...</p>
    </div>

    <!-- STATUS BAR -->
    <div id="topStatusBar" class="bg-slate-900 text-white text-[10px] py-1.5 transition-colors duration-300">
        <div class="container mx-auto px-4 max-w-7xl flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="flex h-2 w-2 relative">
                    <span id="statusPing" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span id="statusDot" class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span id="storeStatusText" class="font-bold tracking-wide uppercase">Verificando...</span>
            </div>
            <div class="hidden md:block opacity-70">Atendimento Digital</div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 glass-header">
    <div class="container mx-auto px-4 lg:px-8 max-w-7xl h-16 md:h-20 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3 cursor-pointer active-scale shrink-0" onclick="resetAllFilters(); window.scrollTo({top:0, behavior:'smooth'})">
            <div id="logoContainer" class="hidden w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden bg-white border border-slate-200 shadow-sm flex-shrink-0">
                <img id="storeLogoImg" src="" class="w-full h-full object-cover" alt="Logo">
            </div>
            <h1 id="storeNameDisplay" class="font-display font-bold text-xl md:text-2xl text-slate-800 leading-none truncate max-w-[120px] md:max-w-xs">Carregando...</h1>
        </div>

        <div class="flex-1 max-w-2xl hidden md:flex items-center bg-slate-100 rounded-full px-1 border border-transparent focus-within:border-primary/20 focus-within:bg-white focus-within:ring-1 focus-within:ring-primary/50 transition-all">
            <div class="relative flex-grow">
                <input type="text" id="desktopSearch" oninput="handleSearchInput(this.value)" placeholder="O que voc√™ procura?" class="w-full bg-transparent border-none py-2.5 pl-10 pr-2 text-sm focus:ring-0">
                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
            </div>
            <button onclick="openFilterDrawer()" class="p-2 m-1 rounded-full hover:bg-slate-200 bg-white shadow-sm border border-slate-200 text-slate-600">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="flex items-center gap-1 md:gap-3 shrink-0">
            <button onclick="toggleFavoritesView()" id="headerFavBtn" class="flex items-center justify-center p-2.5 rounded-full hover:bg-slate-50 active-scale bg-white border border-slate-200 relative transition-colors">
                <i data-lucide="heart" class="w-5 h-5 text-slate-700" id="headerHeartIcon"></i>
                <span id="favBadgeDesktop" class="absolute -top-1 -right-1 bg-primary text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
            </button>
            <button onclick="openCartModal()" class="flex items-center gap-2 p-2.5 rounded-full hover:bg-slate-50 active-scale group relative bg-white border border-slate-200 shadow-sm">
                <i data-lucide="shopping-cart" class="w-5 h-5 text-slate-700 group-hover:text-primary transition-colors"></i>
                <span id="cartBadge" class="absolute -top-1 -right-1 bg-primary text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
            </button>
        </div>
    </div>
    
    <div class="md:hidden px-4 pb-3">
        <div class="flex items-center w-full bg-slate-100 rounded-lg pr-1 border border-transparent focus-within:bg-white focus-within:border-primary/20 transition-all">
            <div class="relative flex-1">
                <input type="text" id="mobileSearch" oninput="handleSearchInput(this.value)" placeholder="Buscar produtos..." class="w-full bg-transparent border-none py-3 pl-10 pr-2 text-sm focus:ring-0">
                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
            </div>
            <button onclick="openFilterDrawer()" class="p-2 m-1 rounded-lg bg-white shadow-sm border border-slate-200 text-slate-600">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
            </button>
        </div>
    </div>
</header>

    <!-- MAIN APP -->
    <main id="app" class="flex-grow container mx-auto px-2 md:px-8 max-w-7xl pt-4 hidden opacity-0 transition-opacity duration-700">
        
        <!-- BANNERS -->
        <div id="heroGridContainer" class="flex overflow-x-auto snap-x snap-mandatory gap-3 mb-6 pb-2 hide-scroll -mx-2 px-2 md:mx-0 md:px-0"></div>

        <!-- CATEGORIES -->
        <nav class="sticky top-[115px] md:top-[80px] z-30 mb-6 -mx-2 px-2 md:mx-0 md:px-0 bg-transparent">
            <div id="categoryContainer" class="flex items-center gap-2 overflow-x-auto hide-scroll py-2 pl-1"></div>
        </nav>

        <!-- CATALOGO -->
        <div id="catalogContainer" class="pb-20 space-y-10 min-h-[50vh]"></div>
        
        <!-- EMPTY STATES -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center animate-fade-in">
            <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-slate-400"><i data-lucide="search-x" class="w-8 h-8"></i></div>
            <h3 class="font-bold text-slate-800">Nenhum produto encontrado</h3>
            <button onclick="resetAllFilters()" class="mt-4 text-primary text-sm font-bold">Limpar filtros</button>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-slate-200 py-10 mt-auto">
        <div class="container mx-auto px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <h5 class="font-display font-bold text-xl text-slate-900 mb-1" id="footerStoreName">Loja</h5>
                <p id="footerDescription" class="text-slate-500 text-sm">Qualidade e confian√ßa.</p>
            </div>
            <div class="flex gap-4 text-sm font-semibold text-slate-600">
                <button onclick="openDeliveryModal()" class="hover:text-primary flex items-center gap-1"><i data-lucide="truck" class="w-4 h-4"></i> Entrega</button>
                <a id="footerWaLink" href="#" target="_blank" class="hover:text-primary flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp</a>
            </div>
        </div>
    </footer>

    <!-- MODAL: DETALHES -->
    <div id="modalDetails" class="fixed inset-0 z-[60] hidden flex items-end md:items-center justify-center pointer-events-none p-0 md:p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm pointer-events-auto" onclick="closeModalDetails()"></div>
    
    <div class="bg-white w-full max-w-2xl md:rounded-2xl rounded-t-[2.5rem] shadow-2xl pointer-events-auto relative flex flex-col max-h-[92vh] md:max-h-[85vh] overflow-hidden animate-slide-up">
        
        <div class="sticky top-0 right-0 z-50 flex justify-end gap-2 p-4 h-0 overflow-visible">
            <button onclick="shareProduct()" class="bg-white/90 hover:bg-white p-2 rounded-full shadow-lg backdrop-blur-sm border border-slate-100 active-scale">
                <i data-lucide="share-2" class="w-5 h-5 text-slate-700"></i>
            </button>
            <button onclick="closeModalDetails()" class="bg-white/90 hover:bg-white p-2 rounded-full shadow-lg backdrop-blur-sm border border-slate-100 active-scale">
                <i data-lucide="x" class="w-5 h-5 text-slate-700"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar pt-2">
            <div class="relative bg-white pb-4">
                <div id="mainImageContainer" style="touch-action: pan-y;" class="h-72 md:h-96 w-full flex items-center justify-center p-4 relative group cursor-zoom-in overflow-hidden touch-pan-y" onclick="openImageZoom()">
                    <img id="detailImg" class="max-w-full max-h-full object-contain transition-all duration-300 select-none" src="">
                    <div id="imageCounter" class="absolute bottom-4 left-4 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full font-bold">1 / 1</div>
                </div>
                <div id="detailThumbnails" class="flex gap-2 px-4 overflow-x-auto justify-center min-h-[50px] items-center hide-scroll"></div>
            </div>

            <div class="px-6 pb-32"> <div class="flex justify-between items-start mb-2">
                     <span id="detailCat" class="text-[10px] font-extrabold text-primary uppercase tracking-widest pt-1"></span>
                     <button id="modalHeartBtn" onclick="toggleFavoriteCurrentDetail()" class="p-2 -mr-2 -mt-2 rounded-full hover:bg-slate-50 active-scale">
                        <i data-lucide="heart" class="w-6 h-6 text-slate-300"></i>
                     </button>
                </div>
                
                <h2 id="detailName" class="font-display text-2xl md:text-3xl font-bold text-slate-900 mb-1"></h2>
                
                <div id="detailSkuContainer" class="mb-4">
                    <span class="text-[10px] font-mono bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase tracking-wider">SKU: <span id="detailSku"></span></span>
                </div>
                
                <p id="detailDesc" class="text-slate-500 text-sm leading-relaxed mb-8"></p>
                
                <div class="space-y-6 border-t border-slate-100 pt-6">
                    <div id="sizesWrapper" class="hidden">
                        <span class="text-xs font-bold text-slate-800 uppercase mb-3 block">Tamanho</span>
                        <div id="detailSizesContainer" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="colorsWrapper" class="hidden">
                        <span class="text-xs font-bold text-slate-800 uppercase mb-3 block">Cor</span>
                        <div id="detailColorsContainer" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div id="relatedProductsSection" class="mt-10 pt-8 border-t border-slate-100 hidden">
                    <h4 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wide">Relacionados</h4>
                    <div id="relatedGrid" class="flex overflow-x-auto gap-3 pb-4 hide-scroll -mx-2 px-2"></div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t flex items-center justify-between bg-white/95 backdrop-blur-md z-20 absolute bottom-0 w-full shadow-[0_-4px_10px_-1px_rgba(0,0,0,0.08)]">
            <div class="flex flex-col">
                <span id="detailOldPrice" class="text-xs text-slate-400 line-through"></span>
                <span id="detailPrice" class="text-2xl md:text-3xl font-display font-black text-slate-900 tracking-tight"></span>
            </div>
            <div class="flex gap-2">
                <div class="flex items-center bg-slate-100 rounded-xl px-1 h-12">
                    <button onclick="adjustDetailQty(-1)" class="w-8 h-full font-bold text-lg text-slate-500">-</button>
                    <span id="detailQtyDisplay" class="font-bold w-6 text-center text-sm">1</span>
                    <button onclick="adjustDetailQty(1)" class="w-8 h-full font-bold text-lg text-slate-500">+</button>
                </div>
                <button id="detailAddBtn" class="bg-primary hover:bg-primaryDark text-white font-bold px-4 md:px-8 h-12 rounded-xl active-scale shadow-lg disabled:opacity-40 transition-all text-sm md:text-base">
                    Adicionar
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- MODAL: ZOOM -->
    <div id="modalImageZoom" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-md opacity-0 transition-opacity duration-300 cursor-zoom-out" onclick="closeImageZoom()">
        <button class="absolute top-4 right-4 text-white/80 p-3"><i data-lucide="x" class="w-10 h-10"></i></button>
        <img id="zoomedImg" class="max-w-full max-h-full object-contain transform scale-95 transition-transform duration-300">
    </div>

    <!-- MODAL: CARRINHO -->
            <div id="modalCart" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeCartModal()"></div>
        <div id="cartDrawer" class="absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="p-5 border-b flex justify-between items-center"><h3 class="font-bold text-lg">Minha Sacola</h3><button onclick="closeCartModal()"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div id="cartList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"></div>
            <div class="p-5 border-t bg-white space-y-4">
                <div id="cartEmptyMsg" class="hidden text-center text-slate-400 py-6">Sua sacola est√° vazia.</div>
                <div id="cartSummary" class="space-y-4">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Dados para Entrega</h4>
                        <input type="text" id="checkName" placeholder="Seu Nome Completo" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                        <div class="flex gap-2">
                            <select id="checkPayment" class="flex-1 bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none">
                                <option value="" disabled selected>Pagamento</option>
                                <option value="Pix">Pix</option>
                                <option value="Cart√£o">Cart√£o</option>
                                <option value="Dinheiro">Dinheiro</option>
                            </select>
                            <select id="cartDeliverySelect" onchange="updateCartTotals()" class="flex-1 bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none"></select>
                        </div>
                        <textarea id="checkAddress" rows="2" placeholder="Endere√ßo completo (Rua, N¬∫, Bairro)" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20"></textarea>
                    </div>
                    <div class="px-2">
                        <div class="flex justify-between text-xl font-display font-black text-slate-900 pt-2">
                            <span>Total</span>
                            <span id="cartFinalTotal">R$ 0,00</span>
                        </div>
                        <button onclick="checkoutWhatsApp()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-4 rounded-2xl shadow-lg mt-4 active-scale flex justify-center items-center gap-3 transition-all">
                            Finalizar Pedido <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeFilterDrawer()"></div>
        <div id="filterDrawer" class="absolute inset-y-0 right-0 max-w-xs w-full bg-white flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="p-5 border-b flex justify-between items-center"><h3 class="font-bold">Filtrar</h3><button onclick="closeFilterDrawer()"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-5 space-y-8 flex-1 overflow-y-auto">
                <div><label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Pre√ßo M√°ximo</label><input id="filterMaxPrice" type="number" placeholder="At√© R$..." oninput="renderCatalog()" class="w-full border rounded-lg p-2.5 text-sm"></div>
                <div><label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Tamanhos</label><div id="filterSizesContainer" class="flex flex-wrap gap-2"></div></div>
                <div><label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Cores</label><div id="filterColorsContainer" class="flex flex-wrap gap-2"></div></div>
            </div>
            <div class="p-5 border-t bg-slate-50 flex flex-col gap-2">
                <button onclick="closeFilterDrawer()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl">Ver Resultados</button>
                <button onclick="resetAllFilters()" class="w-full text-slate-500 font-bold py-2 text-sm">Limpar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: TAXAS -->
    <div id="modalDelivery" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="document.getElementById('modalDelivery').classList.add('hidden')"></div>
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-lg mb-4 text-slate-900">Taxas de Entrega</h3>
            <div id="deliveryList" class="space-y-2 max-h-[50vh] overflow-y-auto mb-6"></div>
            <button onclick="document.getElementById('modalDelivery').classList.add('hidden')" class="w-full py-3 bg-slate-100 font-bold text-slate-600 rounded-xl font-display">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { 
    initializeFirestore, 
    persistentLocalCache, 
    persistentMultipleTabManager, 
    doc, 
    getDoc, 
    getDocFromServer,
    getDocs, 
    getDocsFromCache,
    getDocsFromServer,
    collection, 
    query, 
    where, 
    increment, 
    setDoc, 
    updateDoc, 
    Timestamp,
    writeBatch // <--- ADICIONE ESTE
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
                // --- CONFIGURA√á√ÉO & ESTADO ---
        const FIREBASE_CONFIG = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.firebasestorage.app", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };
        const app = initializeApp(FIREBASE_CONFIG);
        const db = initializeFirestore(app, { localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() }) });
        const auth = getAuth(app);
        
        let STORE_ID = null;
        let FAV_KEY = ""; 
        let favorites = []; // Declarado apenas uma vez aqui
        let allProducts=[], categories=[], cart=[], whatsappNumber="", storeOpen=true;
        let deliveryAreas=[], currentDetailId=null, currentDetailQty=1, currentDetailSelection = { size: null, color: null };
        let currentDetailImages = [], currentDetailImageIndex = 0;
        let filters = { search: "", category: null, maxPrice: null, sizes: [], colors: [] };
        let isFavoritesView = false;

                // --- DATA SERVICE ---
        const DataService = {
            async getStoreConfig() {
                const configRef = doc(db, `stores/${STORE_ID}/config/store`);
                // Sempre buscamos do servidor para validar o carimbo de tempo real
                const snap = await getDocFromServer(configRef);
                return snap.data();
            },

            async getProducts(forceServer = false) {
                const colRef = collection(db, `stores/${STORE_ID}/products`);
                try {
                    // MUDAN√áA AQUI: Se for forceServer, usamos getDocsFromServer
                    const snap = forceServer ? await getDocsFromServer(colRef) : await getDocs(colRef);
                    
                    // Fallback: se o cache estiver vazio e n√£o for force, tenta servidor
                    if (snap.empty && !forceServer) return this.getProducts(true);
                    
                    return snap.docs.map(d => ({id: d.id, ...d.data()})).filter(p => p.status === 'active');
                } catch (e) {
                    console.error("Erro ao buscar produtos:", e);
                    // Se falhar no cache, tenta no servidor como √∫ltima esperan√ßa
                    if (!forceServer) return this.getProducts(true);
                    return [];
                }
            },

            async getBanners(forceServer = false) {
                const colRef = collection(db, `stores/${STORE_ID}/hero_cards`);
                try {
                    const snap = forceServer ? await getDocsFromServer(colRef) : await getDocs(colRef);
                    if (snap.empty && !forceServer) return this.getBanners(true);
                    return snap.docs.map(d => ({id: d.id, ...d.data()}));
                } catch (e) {
                    if (!forceServer) return this.getBanners(true);
                    return [];
                }
            }
        };
        

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            STORE_ID = urlParams.get('id') || 'admin';
            
            // Define a chave √∫nica para esta loja
            FAV_KEY = `favs_v2_${STORE_ID}`;
            
            // Carrega os favoritos da loja espec√≠fica
            try {
                const saved = localStorage.getItem(FAV_KEY);
                favorites = saved ? JSON.parse(saved) : [];
            } catch (e) {
                favorites = [];
            }
            
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => { if(user) initFlow(); });
            setupSwipes();
        });

                async function initFlow() {
            try {
                // 1. BUSCA A CONFIGURA√á√ÉO DIRETO DO SERVIDOR
                const configRef = doc(db, `stores/${STORE_ID}/config/store`);
                const configSnap = await getDocFromServer(configRef); 
                
                if(!configSnap.exists()) {
                    showFatalError("Loja n√£o encontrada", "Verifique o ID da loja na URL.");
                    return;
                }

                const config = configSnap.data();

                if(config.subscriptionStatus === 'suspended') { 
                    showFatalError("Indispon√≠vel", "Assinatura suspensa."); 
                    return; 
                }
                
                applyStoreConfig(config);
                
                // 2. GERENCIAMENTO DE CACHE LOCAL
                const CACHE_KEY = `app_cache_v4_${STORE_ID}`;
                const cachedRaw = localStorage.getItem(CACHE_KEY);
                const cached = cachedRaw ? JSON.parse(cachedRaw) : null;
                
                // 3. COMPARA√á√ÉO DE SEGURAN√áA (Adicionado fallback para lastUpdate)
                const serverLastUpdate = config.lastUpdate || "initial";
                const needsUpdate = !cached || serverLastUpdate !== cached.lastUpdate;

                if (needsUpdate) {
                    console.log("üîÑ Sincronizando dados novos...");
                    
                    const [products, banners] = await Promise.all([
                        DataService.getProducts(true), 
                        DataService.getBanners(true)
                    ]);
                    
                    const cats = Array.from(new Set(products.map(p => p.category).filter(Boolean))).sort();
                    
                    allProducts = products;
                    categories = cats;
                    
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        products, 
                        banners: banners || [], 
                        categories: cats, 
                        lastUpdate: serverLastUpdate,
                        ts: Date.now()
                    }));
                    
                    renderHeroCarousel(banners || []);
                } else {
                    console.log("‚úÖ Carregado do cache.");
                    allProducts = cached.products;
                    categories = cached.categories;
                    renderHeroCarousel(cached.banners || []);
                }

                // Renderiza√ß√£o da UI
                renderCategoryTabs();
                renderCatalog();
                populateFilterOptions();
                registerVisit();
                updateFavoritesUI();
                
                // FINALIZA O LOADER
                hideLoader();

            } catch (error) {
                console.error("Erro cr√≠tico na sincroniza√ß√£o:", error);
                // For√ßa a sa√≠da do loader para mostrar a mensagem de erro ao usu√°rio
                hideLoader(); 
                showFatalError("Erro de Conex√£o", "N√£o foi poss√≠vel carregar os dados. Verifique sua internet ou as permiss√µes do Firebase.");
            }
                }
        
        
        // --- RENDERERS ---
        window.renderCatalog = () => {
    const container = document.getElementById('catalogContainer'), 
          empty = document.getElementById('emptyState');
          
        // 1. L√≥gica de filtragem dos produtos
    let filtered = allProducts.filter(p => {
        if(isFavoritesView) return favorites.includes(p.id);
        if(filters.search) {
            const searchLower = filters.search.toLowerCase();
            const nameMatch = p.name.toLowerCase().includes(searchLower);
            const skuMatch = p.sku && p.sku.toLowerCase().includes(searchLower);
            if (!nameMatch && !skuMatch) return false;
        }
        if(filters.category === 'offers') { 
            if(!(p.promoValue && p.promoValue < p.value)) return false; 
        } else if(filters.category && p.category !== filters.category) return false;
        const price = (p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value;
        if(filters.maxPrice && price > filters.maxPrice) return false;
        if(filters.sizes.length > 0 || filters.colors.length > 0) {
            if (p.variations && p.variations.length > 0) {
                const hasMatch = p.variations.some(v => {
                    if (!v.active) return false;
                    const sizeMatch = filters.sizes.length === 0 || filters.sizes.includes(v.size);
                    const colorMatch = filters.colors.length === 0 || filters.colors.includes(v.color);
                    return sizeMatch && colorMatch;
                });
                if (!hasMatch) return false;
            } else {
                const sizeMatchBase = filters.sizes.length === 0 || p.sizes?.some(s => filters.sizes.includes(s));
                const colorMatchBase = filters.colors.length === 0 || p.colors?.some(c => filters.colors.includes(c));
                if (!sizeMatchBase || !colorMatchBase) return false;
            }
        }
        return true;
    });

    // 2. RASTREADOR DE BUSCAS SEM RESULTADO
    if (filtered.length === 0 && filters.search.trim().length > 2) {
        const termoBusca = filters.search.toLowerCase().trim();
        clearTimeout(window.failedSearchTimer);
        window.failedSearchTimer = setTimeout(async () => {
            try {
                const searchRef = doc(db, `stores/${STORE_ID}/failed_searches`, termoBusca);
                await setDoc(searchRef, {
                    term: termoBusca,
                    count: increment(1),
                    lastDate: Timestamp.now()
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao registrar busca falha:", e);
            }
        }, 1500); 
    }
    // ---------------------------------------------------

    container.innerHTML = '';
    if(!filtered.length) { empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');

    // Agrupamento por Categoria (Mant√©m o teu c√≥digo)
    const groups = {};
    if(isFavoritesView || filters.search || (filters.category && filters.category !== 'offers') || filters.maxPrice) {
        groups['Resultados Encontrados'] = filtered;
    } else {
        filtered.forEach(p => { const k = p.category || 'Geral'; if(!groups[k]) groups[k]=[]; groups[k].push(p); });
    }

    Object.keys(groups).sort().forEach(key => {
        const section = document.createElement('section');
        section.className = "animate-fade-in mb-8";
        section.innerHTML = `<h3 class="font-bold text-slate-800 mb-4 px-1 text-lg flex items-center gap-2"><div class="w-1 h-5 bg-primary rounded-full"></div> ${key}</h3>`;
        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-5";
        groups[key].forEach(p => grid.innerHTML += mkProductCard(p));
        section.appendChild(grid); 
        container.appendChild(section);
    });
    lucide.createIcons();
        }


        function mkProductCard(p) {
            const hasPromo = p.promoValue && p.promoValue < p.value, price = hasPromo ? p.promoValue : p.value, img = p.images?.[0] || 'https://placehold.co/600?text=Sem+Imagem', isFav = favorites.includes(p.id);
            const disc = hasPromo ? `<span class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded-bl-lg z-10">-${Math.round(((p.value - p.promoValue) / p.value) * 100)}%</span>` : '';
            return `<div onclick="openProductModal('${p.id}')" class="product-card cursor-pointer group flex flex-col h-full relative">
                <div class="aspect-square bg-white relative overflow-hidden border-b border-slate-50">
                    <img src="${img}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy">
                    ${disc}
                    <button onclick="event.stopPropagation(); toggleFavorite('${p.id}')" class="absolute top-2 left-2 p-1.5 rounded-full bg-white/80 backdrop-blur-sm z-20">
                        <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'heart-active' : 'text-slate-400'}"></i>
                    </button>
                </div>
                <div class="p-3 md:p-4 flex flex-col flex-grow bg-white">
                    <h4 class="text-sm font-semibold text-slate-700 leading-snug line-clamp-2 mb-2 group-hover:text-primary transition-colors">${p.name}</h4>
                    <div class="mt-auto pt-1">
                        ${hasPromo ? `<span class="text-[11px] text-slate-400 line-through block mb-0.5">R$ ${p.value.toFixed(2).replace('.',',')}</span>` : '<span class="block h-4"></span>'}
                        <div class="flex items-center justify-between">
                            <span class="text-lg md:text-xl font-display font-black text-slate-900 tracking-tight">R$ ${price.toFixed(2).replace('.',',')}</span>
                            <button onclick="event.stopPropagation(); quickAdd('${p.id}')" class="w-8 h-8 rounded-full bg-primary/10 hover:bg-primary text-primary hover:text-white flex items-center justify-center transition-colors active-scale">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- CORE LOGIC ---
                // --- LOGICA DE DETALHES DO PRODUTO (ABRIR MODAL) ---
        window.openProductModal = (id) => { 
            const p = allProducts.find(x => x.id === id); 
            if(!p) return; 

            // GATILHO: Registra que o produto foi visto para o Analytics
            trackProductView(p.id, p.name);

            currentDetailId=id; currentDetailQty=1; currentDetailSelection={size:null,color:null}; 
            currentDetailImages = (p.images?.length) ? p.images : ['https://placehold.co/600?text=Sem+Imagem'];
            currentDetailImageIndex = 0;
            
            const thumbContainer = document.getElementById('detailThumbnails'); thumbContainer.innerHTML = '';
            if (currentDetailImages.length > 1) { 
                currentDetailImages.forEach((url, idx) => { 
                    const img = document.createElement('img'); 
                    img.src = url; 
                    img.className = "min-w-[50px] w-[50px] h-[50px] rounded-md border-2 object-cover cursor-pointer transition-all thumb-inactive";
                    img.onclick = () => setDetailImage(idx); 
                    thumbContainer.appendChild(img); 
                }); 
                thumbContainer.style.display = 'flex'; 
            } else thumbContainer.style.display = 'none';
            
            updateDetailImageDisplay();
            document.getElementById('detailCat').textContent=p.category; 
            document.getElementById('detailName').textContent=p.name; 
            document.getElementById('detailSku').textContent = p.sku || 'N/A';
            document.getElementById('detailDesc').textContent=p.description||''; 

            const renderVariationUI = () => {
                const matrix = p.variations || [];
                const hasS = p.sizes?.length > 0, hasC = p.colors?.length > 0;

                const updatePrices = () => {
                    let price = (p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value;
                    let oldP = (p.promoValue && p.promoValue < p.value) ? p.value : null;
                    let isComplete = (!hasS || currentDetailSelection.size) && (!hasC || currentDetailSelection.color);

                    if(isComplete && matrix.length) {
                        const comb = matrix.find(v => 
                            (!hasS || v.size.trim().toLowerCase() === (currentDetailSelection.size||"").trim().toLowerCase()) && 
                            (!hasC || v.color.trim().toLowerCase() === (currentDetailSelection.color||"").trim().toLowerCase())
                        );
                        if(comb && comb.active) { price = comb.price; oldP = null; } 
                        else if(hasS || hasC) isComplete = false;
                    }
                    document.getElementById('detailPrice').textContent = `R$ ${price.toFixed(2).replace('.',',')}`;
                    document.getElementById('detailOldPrice').textContent = oldP ? `R$ ${oldP.toFixed(2).replace('.',',')}` : '';
                    document.getElementById('detailAddBtn').disabled = !isComplete;
                    p.currentFinalPrice = price; 
                };

                const renderChips = (list, type, container, wrapper) => {
                    container.innerHTML = '';
                    if(!list?.length) { wrapper.classList.add('hidden'); return; }
                    wrapper.classList.remove('hidden');
                    const otherType = type === 'size' ? 'color' : 'size';
                    const otherVal = currentDetailSelection[otherType];

                    list.forEach(val => {
                        const chip = document.createElement('div');
                        const normVal = val.trim().toLowerCase();
                        const isSelected = currentDetailSelection[type] && currentDetailSelection[type].trim().toLowerCase() === normVal;
                        let isPossible = true;
                        if(matrix.length) {
                            if(otherVal) {
                                isPossible = matrix.some(v => v.active && v[type].trim().toLowerCase() === normVal && v[otherType].trim().toLowerCase() === otherVal.trim().toLowerCase());
                            } else {
                                isPossible = matrix.some(v => v.active && v[type].trim().toLowerCase() === normVal);
                            }
                        }
                        const CHIP_S = "border-primary bg-primary text-white font-bold ring-2 ring-primary/20 shadow-md";
                        const CHIP_D = "border-slate-200 bg-slate-50 text-slate-600 hover:bg-slate-100";
                        chip.className = `px-4 py-2 border rounded-lg text-xs chip-common ${isSelected ? CHIP_S : (isPossible ? CHIP_D : 'chip-disabled')}`;
                        chip.textContent = val;
                        chip.onclick = () => { if(!isPossible) return; currentDetailSelection[type] = isSelected ? null : val; renderVariationUI(); };
                        container.appendChild(chip);
                    });
                };

                renderChips(p.sizes, 'size', document.getElementById('detailSizesContainer'), document.getElementById('sizesWrapper'));
                renderChips(p.colors, 'color', document.getElementById('detailColorsContainer'), document.getElementById('colorsWrapper'));
                updatePrices();
            };

            renderVariationUI();
            document.getElementById('detailQtyDisplay').textContent="1"; 
            updateModalHeartBtn(); 
            document.getElementById('detailAddBtn').onclick=()=>{ addToCart(p,currentDetailQty,currentDetailSelection); closeModalDetails(); }; 
            renderRelatedProducts(p);
            document.getElementById('modalDetails').classList.remove('hidden'); 
            lucide.createIcons();
        };

        // --- SISTEMA DE CACHE E SINCRONIZA√á√ÉO DE ANALYTICS (PRODUTOS) ---

const VIEW_CACHE_KEY = `pending_views_${STORE_ID}`;

// 1. REGISTRA A VIEW NO CACHE LOCAL (CHAMADA NO MODAL)
async function trackProductView(productId, productName) {
    const sessionKey = `view_${productId}`;
    if (sessionStorage.getItem(sessionKey)) return;

    let cachedViews = JSON.parse(localStorage.getItem(VIEW_CACHE_KEY) || "{}");

    if (!cachedViews[productId]) {
        cachedViews[productId] = { name: productName, count: 0 };
    }
    
    cachedViews[productId].count += 1;
    
    localStorage.setItem(VIEW_CACHE_KEY, JSON.stringify(cachedViews));
    sessionStorage.setItem(sessionKey, "1");
}

// 2. ENVIA OS DADOS ACUMULADOS PARA O FIREBASE
async function syncViewsToFirebase() {
    const cachedRaw = localStorage.getItem(VIEW_CACHE_KEY);
    if (!cachedRaw) return;

    const cachedViews = JSON.parse(cachedRaw);
    const productIds = Object.keys(cachedViews);
    
    if (productIds.length === 0) return;

    const batch = writeBatch(db);

    productIds.forEach(id => {
        const data = cachedViews[id];
        const docRef = doc(db, "stores", STORE_ID, "product_analytics", id);
        
        batch.set(docRef, {
            name: data.name,
            views: increment(data.count),
            lastView: Timestamp.now()
        }, { merge: true });
    });

    try {
        await batch.commit();
        localStorage.removeItem(VIEW_CACHE_KEY);
        console.log("Analytics sincronizado.");
    } catch (e) {
        console.error("Erro na sincroniza√ß√£o:", e);
    }
}

// 3. AGENDAMENTO AUTOM√ÅTICO
setInterval(syncViewsToFirebase, 120000); // Executa a cada 2 minutos

window.addEventListener('load', () => {
    setTimeout(syncViewsToFirebase, 5000); // Tenta enviar pend√™ncias 5s ap√≥s abrir o site
});
        // --- UTILS ---
        window.handleSearchInput = (v) => { filters.search=v; renderCatalog(); };
        window.resetAllFilters = () => { filters={search:"",category:null,maxPrice:null,sizes:[],colors:[]}; isFavoritesView=false; document.querySelectorAll('input').forEach(i=>i.value=''); renderCategoryTabs(); renderCatalog(); };
        window.toggleFavorite = (id) => { 
    const idx = favorites.indexOf(id); 
    if(idx > -1) {
        favorites.splice(idx, 1); // Remove se j√° existir
    } else {
        favorites.push(id); // Adiciona se n√£o existir
    }
    
    // SALVA NA GAVETA DA LOJA ATUAL
    localStorage.setItem(FAV_KEY, JSON.stringify(favorites)); 
    
    renderCatalog(); 
    updateFavoritesUI(); 
    if(currentDetailId === id) updateModalHeartBtn(); 
};
        window.toggleFavoritesView = () => { isFavoritesView = !isFavoritesView; renderCategoryTabs(); renderCatalog(); window.scrollTo({top:0, behavior:'smooth'}); };
        window.updateFavoritesUI = () => {
    const count = favorites.length;
    const badge = document.getElementById('favBadgeDesktop');
    const heartIcon = document.getElementById('headerHeartIcon');
    const favBtn = document.getElementById('headerFavBtn');

    if (!badge || !heartIcon || !favBtn) return;

    // Atualiza o contador (Badge)
    badge.textContent = count;
    badge.classList.toggle('scale-0', count === 0);

    // L√≥gica de cores baseada no tema
    if (count > 0) {
        // Ativa a cor do tema
        heartIcon.style.fill = 'var(--color-primary)';
        heartIcon.style.color = 'var(--color-primary)';
        favBtn.style.borderColor = 'var(--color-primary)';
        // Nota: O fallback acima √© a cor padr√£o, mas o navegador usar√° a vari√°vel do tema.
    } else {
        // Volta ao estado neutro
        heartIcon.style.fill = 'none';
        heartIcon.style.color = '#334155'; // Slate 700
        favBtn.style.borderColor = '#e2e8f0'; // Slate 200
        favBtn.style.backgroundColor = '#ffffff';
    }
};

        function updateModalHeartBtn() { const b=document.querySelector('#modalHeartBtn svg'); if(favorites.includes(currentDetailId)){b.classList.add('heart-active');}else{b.classList.remove('heart-active');} }
        
        window.addToCart = (p, q, v) => {
    // 1. Criar uma chave √∫nica para o carrinho desta loja
    const CART_KEY = `cart_${STORE_ID}`;
    
    const price = p.currentFinalPrice || ((p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value);
    const uid = `${p.id}-${(v.size || '').trim()}-${(v.color || '').trim()}`;
    
    const ex = cart.find(x => x.uid === uid); 
    if(ex) {
        ex.q += q; 
    } else {
        cart.push({uid, id: p.id, sku: p.sku || 'N/A', name: p.name, price, q, img: p.images?.[0] || 'https://placehold.co/100', v: {...v}}); 
    }

    // 2. Salvar o carrinho apenas para esta loja no navegador
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    
    updateCartUI(); 
    showToast(`<b>${p.name}</b> na sacola!`); 
};


        window.updateCartUI = () => {
            const cnt=cart.reduce((a,b)=>a+b.q,0); 
            const b=document.getElementById('cartBadge'); b.textContent=cnt; b.classList.toggle('scale-0',cnt===0);
            const l=document.getElementById('cartList');
            if(!cart.length){ l.innerHTML=''; document.getElementById('cartEmptyMsg').classList.remove('hidden'); document.getElementById('cartSummary').classList.add('hidden'); }
            else {
                document.getElementById('cartEmptyMsg').classList.add('hidden'); document.getElementById('cartSummary').classList.remove('hidden'); 
                l.innerHTML=cart.map(i=>`<div class="flex gap-3 bg-white p-3 rounded-xl border border-slate-200"><img src="${i.img}" class="w-16 h-16 rounded-lg object-cover bg-slate-50"><div class="flex-1"><div class="flex justify-between font-bold text-xs"><span>${i.name}</span><span>R$ ${(i.price*i.q).toFixed(2).replace('.',',')}</span></div><div class="text-[10px] text-slate-400 mt-1 uppercase">${[i.v.size,i.v.color].filter(Boolean).join(' / ')}</div><div class="flex items-center gap-4 mt-2"><div class="flex items-center bg-slate-100 rounded h-6"><button onclick="modQty('${i.uid}',-1)" class="w-6">-</button><span class="w-6 text-center text-xs font-bold">${i.q}</span><button onclick="modQty('${i.uid}',1)" class="w-6">+</button></div><button onclick="modQty('${i.uid}',-${i.q})" class="text-[10px] text-red-500 font-bold uppercase">Remover</button></div></div></div>`).join('');
            }
            updateCartTotals();
        };

        window.modQty=(u,d)=>{const i=cart.find(x=>x.uid===u);if(i){i.q+=d;if(i.q<=0)cart=cart.filter(x=>x.uid!==u);updateCartUI();}};
        window.updateCartTotals = () => { const df=parseFloat(document.getElementById('cartDeliverySelect').value)||0; let sub=cart.reduce((a,b)=>a+(b.price*b.q),0); document.getElementById('cartFinalTotal').textContent=`R$ ${(sub+df).toFixed(2).replace('.',',')}`; };
        
        window.checkoutWhatsApp = async () => { 
    if(!cart.length) return; 

    // 1. Captura de Dados
    const nome = document.getElementById('checkName').value.trim();
    const pagamento = document.getElementById('checkPayment').value;
    const morada = document.getElementById('checkAddress').value.trim();
    const freteTexto = document.getElementById('cartDeliverySelect').options[document.getElementById('cartDeliverySelect').selectedIndex].text; 
    const total = document.getElementById('cartFinalTotal').textContent;

    // 2. Valida√ß√£o (Impede mensagens vazias)
    if(!nome || !pagamento || !morada) {
        showToast("‚ö†Ô∏è Por favor, preenche todos os dados de entrega.");
        return;
    }

    // 3. M√©trica de Convers√£o (Regista que o cliente tentou comprar)
    const todayId = new Date().toLocaleDateString('en-CA');
    const historyRef = doc(db, "stores", STORE_ID, "analytics_history", todayId);
    await setDoc(historyRef, { checkoutClicks: increment(1) }, { merge: true });

    // 4. Montagem da Mensagem Profissional
    const storeName = document.getElementById('storeNameDisplay').textContent.toUpperCase();
    let msg = `*üõçÔ∏è NOVO PEDIDO - ${storeName}*\n`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    msg += `üë§ *CLIENTE:* ${nome}\n`;
    msg += `üí≥ *PAGAMENTO:* ${pagamento}\n`;
    msg += `üìç *MORADA:* ${morada}\n`;
    msg += `üöö *ENTREGA:* ${freteTexto}\n\n`;
    
    msg += `üì¶ *ITENS DO PEDIDO:*\n`;
    cart.forEach((item, index) => {
        const sub = (item.price * item.q).toFixed(2).replace('.', ',');
        const vars = [item.v.size, item.v.color].filter(Boolean).join(' / ');
        msg += `${index + 1}. *${item.q}x ${item.name}*\n`;
        if(vars) msg += `   ‚îî _Var: ${vars}_\n`;
        msg += `   ‚îî Valor: R$ ${sub}\n\n`;
    });

    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    msg += `üí∞ *VALOR TOTAL: ${total}*\n`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    msg += `_Pedido gerado via Vitrine Pro_`;

    // 5. Redirecionamento
    window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`, '_blank'); 
};
                                            
        function applyStoreConfig(d) {
            whatsappNumber = (d.whatsappNumber||"").replace(/\D/g,"");
            if(d.primaryColor) { document.documentElement.style.setProperty('--color-primary', d.primaryColor); document.documentElement.style.setProperty('--color-primary-dark', d.primaryColor); }
            document.getElementById('storeNameDisplay').textContent = d.storeName;
            document.getElementById('footerStoreName').textContent = d.storeName;
            document.getElementById('footerDescription').textContent = d.footerText || "Qualidade e confian√ßa.";
            if (d.logoUrl) { document.getElementById('storeLogoImg').src = d.logoUrl; document.getElementById('logoContainer').classList.remove('hidden'); }
            
            deliveryAreas = d.deliveryAreas || [];
            document.getElementById('deliveryList').innerHTML = deliveryAreas.map(a => `<div class="flex justify-between p-3 bg-slate-50 rounded-lg text-sm"><span class="font-medium">${a.name}</span><span class="font-bold">R$ ${parseFloat(a.fee).toFixed(2).replace('.',',')}</span></div>`).join('');
            document.getElementById('cartDeliverySelect').innerHTML='<option value="0">Retirar na Loja</option>' + deliveryAreas.map(a=>`<option value="${a.fee}">${a.name} (R$ ${parseFloat(a.fee).toFixed(2).replace('.',',')})</option>`).join('');
            
            const isOpen = d.isStoreOpen !== false;
            const topBar = document.getElementById('topStatusBar');
            document.getElementById('storeStatusText').textContent = isOpen ? "Loja Aberta" : "Loja Fechada";
            topBar.className = isOpen ? "bg-slate-900 text-white text-[10px] py-1.5" : "bg-red-900 text-white text-[10px] py-1.5";
            if(!isOpen) document.getElementById('statusPing').classList.add('hidden');
        }

        async function registerVisit() {
    if (!STORE_ID || STORE_ID === 'admin') return;

    const sessionKey = `vst_${STORE_ID}`;
    if (sessionStorage.getItem(sessionKey)) return;

    try {
        const now = new Date();
        const todayId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        const hour = now.getHours();
        
        // --- DETEC√á√ÉO DE ORIGEM ---
        const ref = document.referrer.toLowerCase();
        let source = "Direto";
        if (ref.includes("instagram.com")) source = "Instagram";
        else if (ref.includes("facebook.com") || ref.includes("fb.me")) source = "Facebook";
        else if (ref.includes("google.com")) source = "Google";

        // 1. ATUALIZA O HIST√ìRICO DI√ÅRIO (O que alimenta o gr√°fico)
        const historyRef = doc(db, `stores/${STORE_ID}/analytics_history`, todayId);
        await setDoc(historyRef, {
            visits: increment(1),
            date: Timestamp.fromDate(now),
            [`hours.${hour}`]: increment(1),
            [`sources.${source}`]: increment(1)
        }, { merge: true });

        // 2. ATUALIZA O CONTADOR GLOBAL (O que alimenta o "Total de Visitas" no topo do painel)
        const globalRef = doc(db, `stores/${STORE_ID}/analytics`, "global");
        await setDoc(globalRef, { 
            totalVisits: increment(1),
            lastUpdate: Timestamp.fromDate(now)
        }, { merge: true });

        sessionStorage.setItem(sessionKey, "1");
        console.log("Visita registrada com sucesso!");
    } catch (err) {
        console.error("Erro ao registrar visita:", err);
    }
        }

        // --- HELPER UI ---
        window.showToast = (msg) => {
            const t=document.createElement('div');
            t.className="bg-slate-900/90 text-white text-sm px-6 py-3 rounded-full shadow-2xl backdrop-blur-md flex items-center gap-3 toast-enter pointer-events-auto transform transition-all duration-300";
            t.innerHTML=`<i data-lucide="shopping-bag" class="w-4 h-4 text-green-400"></i><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            lucide.createIcons();
            requestAnimationFrame(()=>{t.classList.add('toast-enter-active');});
            setTimeout(()=>{t.classList.add('toast-exit-active');setTimeout(()=>t.remove(),300);},3000);
        };

        function hideLoader() { document.getElementById('initialLoader').style.opacity = '0'; setTimeout(() => { document.getElementById('initialLoader').classList.add('hidden'); document.getElementById('app').classList.remove('hidden', 'opacity-0'); }, 500); }
        function showFatalError(title, msg) { document.getElementById('errorScreen').classList.remove('hidden'); document.getElementById('errorTitle').textContent = title; document.getElementById('errorMsg').textContent = msg; hideLoader(); }

        window.closeModalDetails = () => document.getElementById('modalDetails').classList.add('hidden');
        window.openCartModal = () => { document.getElementById('modalCart').classList.remove('hidden'); setTimeout(()=>document.getElementById('cartDrawer').classList.remove('translate-x-full'),10); };
        window.closeCartModal = () => { document.getElementById('cartDrawer').classList.add('translate-x-full'); setTimeout(()=>document.getElementById('modalCart').classList.add('hidden'),300); };
        window.openFilterDrawer = () => { document.getElementById('filterModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('filterDrawer').classList.remove('translate-x-full'),10); };
        window.closeFilterDrawer = () => { document.getElementById('filterDrawer').classList.add('translate-x-full'); setTimeout(()=>document.getElementById('filterModal').classList.add('hidden'),300); };
        window.adjustDetailQty = (d) => { currentDetailQty = Math.max(1, currentDetailQty + d); document.getElementById('detailQtyDisplay').textContent=currentDetailQty; };
        window.setDetailImage = (idx) => { currentDetailImageIndex = idx; updateDetailImageDisplay(); };
        window.updateDetailImageDisplay = () => {
            const img = document.getElementById('detailImg');
            img.src = currentDetailImages[currentDetailImageIndex];
            document.getElementById('imageCounter').textContent = `${currentDetailImageIndex + 1} / ${currentDetailImages.length}`;
            const thumbs = document.getElementById('detailThumbnails').children;
            Array.from(thumbs).forEach((t, i) => { t.classList.toggle('thumb-active', i === currentDetailImageIndex); t.classList.toggle('thumb-inactive', i !== currentDetailImageIndex); });
        };
        window.openImageZoom = () => {
    if(currentDetailImages[currentDetailImageIndex].includes('placehold')) return;
    
    const zoomedImg = document.getElementById('zoomedImg');
    zoomedImg.src = currentDetailImages[currentDetailImageIndex];
    
    const m = document.getElementById('modalImageZoom');
    m.classList.remove('hidden');
    
    // Anima√ß√£o de entrada
    requestAnimationFrame(() => { 
        m.classList.remove('opacity-0'); 
        zoomedImg.classList.replace('scale-95','scale-100'); 
    });

    // --- L√≥gica de Swipe para o Zoom ---
    let startX = 0;
    m.ontouchstart = (e) => startX = e.changedTouches[0].screenX;
    
    m.ontouchend = (e) => {
        let endX = e.changedTouches[0].screenX;
        let diff = startX - endX;

        if (Math.abs(diff) > 50) { // Sensibilidade do rastro
            const dir = diff > 0 ? 1 : -1;
            if (currentDetailImages.length > 1) {
                // Troca de imagem com efeito suave
                zoomedImg.style.opacity = '0.5';
                setTimeout(() => {
                    currentDetailImageIndex = (currentDetailImageIndex + dir + currentDetailImages.length) % currentDetailImages.length;
                    zoomedImg.src = currentDetailImages[currentDetailImageIndex];
                    zoomedImg.style.opacity = '1';
                    updateDetailImageDisplay(); // Sincroniza o modal de baixo
                }, 100);
            }
        }
    };
};

window.closeImageZoom = () => {
    const m = document.getElementById('modalImageZoom');
    m.classList.add('opacity-0');
    document.getElementById('zoomedImg').classList.replace('scale-100','scale-95');
    
    // Limpa os eventos ao fechar
    m.ontouchstart = null;
    m.ontouchend = null;
    
    setTimeout(() => m.classList.add('hidden'), 300);
};

        window.quickAdd = (id) => { const p=allProducts.find(x=>x.id===id); if(p.sizes?.length||p.colors?.length)openProductModal(id); else addToCart(p,1,{}); };
        
        function renderHeroCarousel(banners) {
            const c = document.getElementById('heroGridContainer'); c.innerHTML = '';
            if (!banners?.length) return;
            banners.forEach(b => {
                const div = document.createElement('div');
                div.className = "hero-card min-w-[85vw] md:min-w-[420px] h-36 md:h-44 rounded-2xl p-6 flex flex-col justify-center relative overflow-hidden snap-center cursor-pointer shrink-0 text-white shadow-sm";
                div.style.background = `linear-gradient(135deg, ${b.color1 || '#333'}, ${b.color2 || '#000'})`;
                div.onclick = () => { filters.category = b.target; renderCategoryTabs(); renderCatalog(); };
                div.innerHTML = `<div class="absolute inset-0 opacity-20" style="background-image:radial-gradient(white 2px, transparent 2px);background-size:20px 20px;"></div><div class="relative z-10"><span class="inline-block py-1 px-3 rounded-full bg-white/20 backdrop-blur-md border border-white/20 text-[10px] font-bold uppercase tracking-wider mb-2">${b.tag || 'Destaque'}</span><h3 class="font-display font-bold text-xl md:text-2xl leading-tight w-2/3">${b.title || 'Novidade'}</h3></div>`;
                c.appendChild(div);
            });
        }

        function renderCategoryTabs() {
            const c = document.getElementById('categoryContainer'); c.innerHTML = '';
            const mk = (id, l, icon) => {
                const active = filters.category === id && !isFavoritesView;
                const b = document.createElement('button');
                b.className = `px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${active ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-primary'}`;
                b.innerHTML = icon ? `${icon} ${l}` : l;
                b.onclick = () => { isFavoritesView = false; filters.category = id; renderCategoryTabs(); renderCatalog(); };
                return b;
            };
            c.appendChild(mk('offers', 'Ofertas', '<i data-lucide="flame" class="w-3.5 h-3.5"></i>'));
            c.appendChild(mk(null, 'Tudo'));
            categories.forEach(cat => c.appendChild(mk(cat, cat)));
            lucide.createIcons();
        }

        function populateFilterOptions() {
    const sizeCounts = {}, colorCounts = {};
    const ss = new Set(), cc = new Set();

    // Contabiliza quantos produtos ativos existem para cada cor e tamanho
    allProducts.forEach(p => {
        if (p.sizes) {
            p.sizes.forEach(s => {
                const val = s.trim();
                if (val) {
                    ss.add(val);
                    sizeCounts[val] = (sizeCounts[val] || 0) + 1;
                }
            });
        }
        if (p.colors) {
            p.colors.forEach(c => {
                const val = c.trim();
                if (val) {
                    cc.add(val);
                    colorCounts[val] = (colorCounts[val] || 0) + 1;
                }
            });
        }
    });

    const renderChips = (set, container, type, counts) => {
        container.innerHTML = '';
        // Ordena alfabeticamente
        Array.from(set).sort().forEach(val => {
            const isSelected = filters[type].includes(val);
            const count = counts[val] || 0;
            const d = document.createElement('div');
            
            // Estilo visual do bot√£o com contador
            d.className = `px-3 py-2 border rounded-lg text-[11px] chip-common flex items-center justify-between gap-3 transition-all ${
                isSelected 
                ? 'border-primary bg-primary text-white font-bold shadow-md' 
                : 'border-slate-200 bg-white text-slate-600 hover:border-primary'
            }`;

            d.innerHTML = `
                <span>${val}</span>
                <span class="${isSelected ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-400'} px-1.5 py-0.5 rounded text-[9px]">
                    ${count}
                </span>
            `;

            d.onclick = () => {
                if(isSelected) filters[type] = filters[type].filter(x => x !== val);
                else filters[type].push(val);
                populateFilterOptions(); 
                renderCatalog();
            };
            container.appendChild(d);
        });
    };

    renderChips(ss, document.getElementById('filterSizesContainer'), 'sizes', sizeCounts);
    renderChips(cc, document.getElementById('filterColorsContainer'), 'colors', colorCounts);
}


        function renderRelatedProducts(curr) {
            const s = document.getElementById('relatedProductsSection'), g = document.getElementById('relatedGrid'); g.innerHTML = ''; 
            const rel = allProducts.filter(p => p.category === curr.category && p.id !== curr.id).slice(0, 10); 
            if (!rel.length) { s.classList.add('hidden'); return; } 
            s.classList.remove('hidden');
            rel.forEach(p => {
                const pr = (p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value;
                g.innerHTML += `<div onclick="openProductModal('${p.id}')" class="min-w-[110px] w-28 bg-white border border-slate-100 rounded-lg overflow-hidden cursor-pointer shrink-0"><img src="${p.images?.[0] || 'https://placehold.co/200'}" class="w-full h-20 object-cover" loading="lazy"><div class="p-2"><h5 class="text-[10px] font-medium truncate">${p.name}</h5><span class="text-xs font-bold block mt-0.5">R$ ${pr.toFixed(2).replace('.', ',')}</span></div></div>`;
            });
        }

        function setupSwipes() {
    const el = document.getElementById('mainImageContainer');
    let ts = 0;
    let ty = 0;

    // In√≠cio do toque
    el.addEventListener('touchstart', (e) => {
        ts = e.changedTouches[0].screenX;
        ty = e.changedTouches[0].screenY;
    }, { passive: true });

    // Movimento do toque (Crucial para evitar que a tela role enquanto voc√™ arrasta a foto)
    el.addEventListener('touchmove', (e) => {
        const dx = Math.abs(e.changedTouches[0].screenX - ts);
        const dy = Math.abs(e.changedTouches[0].screenY - ty);
        
        // Se o movimento for mais horizontal que vertical, cancela a rolagem da p√°gina
        if (dx > dy) {
            if (e.cancelable) e.preventDefault();
        }
    }, { passive: false });

    // Fim do toque
    el.addEventListener('touchend', (e) => {
        let te = e.changedTouches[0].screenX;
        let deltaX = ts - te;

        // Sensibilidade: 50 pixels de movimento
        if (Math.abs(deltaX) > 50) {
            const direcao = deltaX > 0 ? 1 : -1; // 1 para direita (pr√≥xima), -1 para esquerda (anterior)
            if (currentDetailImages.length > 1) {
                currentDetailImageIndex = (currentDetailImageIndex + direcao + currentDetailImages.length) % currentDetailImages.length;
                updateDetailImageDisplay();
            }
        }
    }, { passive: true });
}

        window.shareProduct = () => { 
            const p = allProducts.find(x=>x.id===currentDetailId); if(!p) return;
            const text = `Olha esse ${p.name} que encontrei na ${document.getElementById('storeNameDisplay').textContent}!`;
            if(navigator.share) navigator.share({title: p.name, text, url: window.location.href});
            else { navigator.clipboard.writeText(`${text} ${window.location.href}`); showToast("Link copiado!"); }
        };

        window.openDeliveryModal = () => document.getElementById('modalDelivery').classList.remove('hidden');

    </script>
</body>
</html>
