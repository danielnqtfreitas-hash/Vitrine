<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="facebook-domain-verification" content="iwnyy7sgy9l6coj4nnqge630wn2wis" />
    <meta name="color-scheme" content="light">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Carregando Loja...</title>
    
    <!-- SEO & Compartilhamento -->
    <meta name="description" id="meta-desc" content="Confira nossa vitrine online!">
    <meta property="og:title" id="og-title" content="Loja Online">
    <meta property="og:description" id="og-desc" content="Qualidade e confian√ßa em cada detalhe.">
    <meta property="og:image" id="og-img" content="">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
    <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { 
                    sans: ['Inter', 'sans-serif'], 
                    display: ['Outfit', 'sans-serif'] 
                },
                colors: { 
                    primary: 'var(--color-primary)', 
                    primaryDark: 'var(--color-primary-dark)' 
                },
                animation: { 
                    'fade-in': 'fadeIn 0.5s ease-out', 
                    'slide-up': 'slideUp 0.4s ease-out forwards',
                    'bounce-short': 'bounceShort 0.5s ease-in-out 1',
                    'zoom-in': 'zoomIn 0.3s ease-out forwards',
                    'heart-beat': 'heartBeat 0.3s ease-in-out',
                    // --- NOVAS ANIMA√á√ïES ESTILO IFOOD ---
                    'floating': 'floating 3s ease-in-out infinite',
                    'fade-in-right': 'fadeInRight 0.6s ease-out forwards'
                },
                keyframes: {
                    fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                    slideUp: { from: { opacity: 0, transform: 'translateY(20px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                    bounceShort: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' } },
                    heartBeat: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.3)' }, '100%': { transform: 'scale(1)' } },
                    zoomIn: { from: { transform: 'scale(0.95)', opacity: 0 }, to: { transform: 'scale(1)', opacity: 1 } },
                    // --- REGRAS DAS NOVAS ANIMA√á√ïES ---
                    floating: {
                        '0%, 100%': { transform: 'translateY(0) rotate(3deg)' },
                        '50%': { transform: 'translateY(-8px) rotate(5deg)' },
                    },
                    fadeInRight: {
                        from: { opacity: 0, transform: 'translateX(-20px)' },
                        to: { opacity: 1, transform: 'translateX(0)' }
                    }
                }
            }
        }
    }
    </script>
    <style>

        .countdown-text {
    font-variant-numeric: tabular-nums; /* Mant√©m os n√∫meros com a mesma largura */
    min-width: 80px; /* Garante que o espa√ßo seja reservado */
    display: inline-block;
}

.timer-accent {
    /* Cor "pele/nude" elegante que voc√™ mencionou */
    background-color: #fdf2f0; 
    color: #d48377;
    border: 1px solid #f9e4e0;
    font-weight: 700;
}
        /* Garante que o modal nunca esconda os bot√µes no topo */
#modalDetails .bg-white {
    margin-top: env(safe-area-inset-top, 20px);
    max-height: calc(100vh - 80px) !important;
}

/* For√ßa os bot√µes de fechar a ficarem sempre vis√≠veis e clic√°veis */
.modal-close-btn {
    pointer-events: auto !important;
    z-index: 9999 !important;
}
        
        :root { --color-primary: #EA1D2C; --color-primary-dark: #b91c29; }
        body { 
    background-color: #F3F4F6 !important; /* Cor base */
    color: #334155; 
    -webkit-font-smoothing: antialiased;
    /* Cria o degrad√™ que mistura a cor da marca (10%) com o fundo */
    background-image: linear-gradient(180deg, 
        color-mix(in srgb, var(--color-primary), transparent 100%) 0%, 
        #F3F4F6 500px) !important;
    background-attachment: fixed;
}

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .chip-common { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; user-select: none; }
        .active-scale:active { transform: scale(0.95); }
        .product-card { 
            background: white; border-radius: 12px; overflow: hidden; transition: all 0.3s ease; border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: var(--color-primary); }
        .heart-active { fill: var(--color-primary); color: var(--color-primary); animation: heartBeat 0.4s forwards; }
        .thumb-active { border-color: var(--color-primary); opacity: 1; }
        .thumb-inactive { border-color: transparent; opacity: 0.6; }
        .chip-disabled { opacity: 0.25; pointer-events: none; background: #f1f5f9; border-color: #e2e8f0; text-decoration: line-through; color: #94a3b8; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
         /* Localize o final do seu <style> e cole isto: */

#modalImageZoom {
    touch-action: pinch-zoom; /* Permite zoom nativo com os dedos */
    user-select: none;
    -webkit-user-select: none;
    background-color: rgba(0, 0, 0, 0.95);
}

#zoomedImg {
    transition: opacity 0.2s ease-in-out;
    max-width: 100%;
    max-height: 100%;
    object-contain: contain;
}


/* Bloqueia a invers√£o de cores em navegadores que ignoram o sistema */
@media (prefers-color-scheme: dark) {
    body {
        background-color: #F3F4F6 !important; /* Seu fundo cinza claro */
        color: #334155 !important;           /* Seu texto slate */
    }

    /* For√ßa os elementos brancos a continuarem brancos */
    .glass-header, 
    .product-card, 
    footer, 
    #modalDetails .bg-white,
    #modalCart .bg-white,
    #filterDrawer,
    #modalDelivery .bg-white {
        background-color: #FFFFFF !important;
        color: #334155 !important;
    }

    /* Impede que o navegador mude as cores das imagens/logos */
    img {
        filter: none !important;
    }

    /* Garante que os inputs n√£o fiquem com fundo preto e texto branco */
    input, select, textarea {
        background-color: #FFFFFF !important;
        color: #334155 !important;
    }
}
        #heroGridContainer {
    background-color: transparent !important;
    padding-left: 1vw;   /* Espa√ßo na esquerda */
    padding-right: 1vw;  /* Espa√ßo na direita */
    scroll-padding: 0 4vw; 
}

.hero-card {
    box-shadow: none !important;
    border: none !important;
}

        /* Garante que o Drawer do filtro fique sempre por cima de tudo */
#filterModalDrawer {
    z-index: 1000;
}
#filterOverlay {
    z-index: 990;
}
        
    </style>
</head>
<body class="flex flex-col min-h-screen relative bg-[#F3F4F6] text-[#334155]">

    <!-- ERROR SCREEN -->
    <div id="errorScreen" class="fixed inset-0 z-[10000] bg-slate-900 hidden flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-slate-800 p-6 rounded-full mb-6 shadow-2xl">
            <i data-lucide="store" class="w-16 h-16 text-slate-400"></i>
        </div>
        <h1 id="errorTitle" class="text-3xl font-bold text-white mb-3">Loja Indispon√≠vel</h1>
        <p id="errorMsg" class="text-slate-400 max-w-md">N√£o foi poss√≠vel carregar as informa√ß√µes.</p>
        <button onclick="window.location.reload()" class="mt-8 px-6 py-2 bg-primary text-white rounded-full font-bold">Tentar novamente</button>
    </div>

    <div id="modalConfirmFinal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
    <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm relative z-10 shadow-2xl text-center animate-slide-up">
        <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="message-circle" class="w-8 h-8"></i>
        </div>
        <h3 class="font-bold text-lg text-slate-900 mb-2">Quase l√°!</h3>
        <p class="text-sm text-slate-500 leading-relaxed mb-6">
            Envie a mensagem sem alterar nada. <br>
            <b>Aguarde nossa confirma√ß√£o antes de pagar.</b>
        </p>
        <a id="btnFinalWhatsapp" href="#" target="_blank" onclick="window.closeConfirmFinal()" class="block w-full py-4 bg-primary text-white font-bold rounded-2xl shadow-lg active-scale uppercase tracking-widest text-xs">
            Entendi, Ir para WhatsApp
        </a>
    </div>
</div>

    
    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed bottom-6 left-0 right-0 z-[9999] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

    <!-- INITIAL LOADER -->
    <div id="initialLoader" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-primary rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-bold text-slate-400 animate-pulse uppercase tracking-widest">Sincronizando Vitrine...</p>
    </div>

    <!-- HEADER -->
    
<header class="sticky top-0 z-50 glass-header">
    <div class="container mx-auto px-4 lg:px-8 max-w-7xl h-20 md:h-24 flex items-center justify-between gap-4">
        
        <div class="flex items-center gap-4 cursor-pointer active-scale shrink-0" onclick="resetAllFilters(); window.scrollTo({top:0, behavior:'smooth'})">
            <div id="logoContainer" class="hidden w-12 h-12 md:w-14 md:h-14 rounded-full overflow-hidden bg-white border border-slate-200 shadow-sm flex-shrink-0">
                <img id="storeLogoImg" src="" class="w-full h-full object-cover" alt="Logo">
            </div>
            <div class="flex flex-col justify-center">
                <h1 id="storeNameDisplay" class="font-display font-bold text-lg md:text-2xl text-slate-800 leading-tight truncate max-w-[220px] md:max-w-md">Carregando...</h1>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter md:hidden">Vitrine Online</span>
            </div>
        </div>

        <div class="flex-1 max-w-2xl hidden md:flex items-center bg-slate-100 rounded-full px-1 border border-transparent focus-within:border-primary/20 focus-within:bg-white focus-within:ring-1 focus-within:ring-primary/50 transition-all">
            <div class="relative flex-grow">
               <input type="text" id="desktopSearch" autocomplete="off" oninput="handleSearchInput(this.value)" placeholder="O que voc√™ procura?" class="w-full bg-transparent border-none py-2.5 pl-10 pr-2 text-sm focus:ring-0">
                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
            </div>
            <button onclick="openFilterDrawer()" class="relative p-2 m-1 rounded-full hover:bg-slate-200 bg-white shadow-sm border border-slate-200 text-slate-600">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                <span id="filterBadgeDesktop" class="absolute -top-1 -right-1 bg-primary text-white text-[9px] font-black h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
            </button>
        </div>

        <div class="flex items-center gap-1 md:gap-3 shrink-0">
            <button onclick="toggleFavoritesView()" id="headerFavBtn" class="flex items-center justify-center p-2.5 rounded-full hover:bg-slate-50 active-scale bg-white border border-slate-200 relative transition-colors">
                <i data-lucide="heart" class="w-5 h-5 text-slate-700" id="headerHeartIcon"></i>
                <span id="favBadgeDesktop" class="absolute -top-1 -right-1 bg-primary text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
            </button>
            <button onclick="openCartModal()" class="flex items-center gap-2 p-2.5 rounded-full bg-primary hover:brightness-90 active-scale group relative border border-primary shadow-md transition-all">
    <i data-lucide="shopping-cart" class="w-5 h-5 text-white"></i>
    <span id="cartBadge" class="absolute -top-1 -right-1 bg-white text-primary text-[10px] font-black h-4 w-4 flex items-center justify-center rounded-full border-2 border-primary transform scale-0 transition-transform duration-300 shadow-sm">0</span>
            </button>
        </div>
    </div>
    
    <div class="md:hidden px-4 pb-4">
        <div class="flex items-center w-full bg-slate-100 rounded-xl pr-1 border border-transparent focus-within:bg-white focus-within:border-primary/20 transition-all">
            <div class="relative flex-1">
              <input type="text" id="mobileSearch" autocomplete="off" oninput="handleSearchInput(this.value)" placeholder="Buscar produtos..." class="w-full bg-transparent border-none py-3 pl-10 pr-2 text-sm focus:ring-0">
                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
            </div>
            <button onclick="openFilterDrawer()" class="relative p-2 m-1 rounded-lg bg-white shadow-sm border border-slate-200 text-slate-600">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                <span id="filterBadgeMobile" class="absolute -top-1 -right-1 bg-primary text-white text-[9px] font-black h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
            </button>
        </div>
    </div>
</header>

    <!-- MAIN APP -->
    <main id="app" class="flex-grow container mx-auto px-2 md:px-8 max-w-7xl pt-4 hidden opacity-0 transition-opacity duration-700">
        
        <!-- BANNERS -->
        <div class="relative w-full pt-0 overflow-hidden px-2 md:px-0">
    <div id="heroGridContainer" class="flex overflow-x-auto snap-x snap-mandatory gap-6 mb-0 hide-scroll h-52 md:h-64 scroll-smooth bg-transparent">
    </div>
    
    <div id="carouselDots" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-30 flex justify-center gap-1.5 px-3 py-1.5 bg-black/20 backdrop-blur-md rounded-full">
    </div>
        </div>

        <!-- CATEGORIES -->
        <nav class="sticky top-[140px] md:top-[96px] z-30 mb-6 -mx-2 px-2 md:mx-0 md:px-0 bg-[#F3F4F6]/95 backdrop-blur-sm">
    <div id="categoryContainer" class="flex items-center gap-2 overflow-x-auto hide-scroll py-3 pl-1">
        </div>
</nav>
         
        <!-- CATALOGO -->
        <div id="magicSections" class="pb-4 space-y-10"></div> <div id="catalogContainer" class="pb-20 space-y-10 min-h-[50vh]"></div>
        
        
        <!-- EMPTY STATES -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center animate-fade-in">
            <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-slate-400"><i data-lucide="search-x" class="w-8 h-8"></i></div>
            <h3 class="font-bold text-slate-800">Nenhum produto encontrado</h3>
            <button onclick="resetAllFilters()" class="mt-4 text-primary text-sm font-bold">Limpar filtros</button>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-slate-200 py-10 mt-auto">
        <div class="container mx-auto px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <h5 class="font-display font-bold text-xl text-slate-900 mb-1" id="footerStoreName">Loja</h5>
                <p id="footerDescription" class="text-slate-500 text-sm">Qualidade e confian√ßa.</p>
            </div>
            <div class="flex gap-4 text-sm font-semibold text-slate-600">
                <button onclick="openDeliveryModal()" class="hover:text-primary flex items-center gap-1"><i data-lucide="truck" class="w-4 h-4"></i> Entrega</button>
                <a id="footerWaLink" href="#" target="_blank" class="hover:text-primary flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp</a>
            </div>
        </div>
    </footer>

    <!-- MODAL: DETALHES -->
            <div id="modalDetails" class="fixed inset-0 z-[60] hidden flex items-end md:items-center justify-center pointer-events-none p-0 md:p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm pointer-events-auto" onclick="closeModalDetails()"></div>
    
    <div class="bg-white w-full max-w-2xl md:rounded-2xl rounded-t-[2.5rem] shadow-2xl pointer-events-auto relative flex flex-col max-h-[92vh] md:max-h-[85vh] overflow-hidden animate-slide-up">
        
        <div class="sticky top-0 right-0 z-50 flex justify-end gap-2 p-4 h-0 overflow-visible">
            <button onclick="shareProduct()" class="bg-white/90 hover:bg-white p-2 rounded-full shadow-lg backdrop-blur-sm border border-slate-100 active-scale">
                <i data-lucide="share-2" class="w-5 h-5 text-slate-700"></i>
            </button>
            <button onclick="closeModalDetails()" class="bg-white/90 hover:bg-white p-2 rounded-full shadow-lg backdrop-blur-sm border border-slate-100 active-scale">
                <i data-lucide="x" class="w-5 h-5 text-slate-700"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar pt-2">
            <div class="relative bg-white pb-4">
                <div id="mainImageContainer" style="touch-action: pan-y;" class="h-72 md:h-96 w-full flex items-center justify-center p-4 relative group cursor-zoom-in overflow-hidden touch-pan-y" onclick="openImageZoom()">
                    <img id="detailImg" class="max-w-full max-h-full object-contain transition-all duration-300 select-none" src="">
                    <div id="imageCounter" class="absolute bottom-4 left-4 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full font-bold">1 / 1</div>
                </div>
                <div id="detailThumbnails" class="flex gap-3 px-6 py-2 overflow-x-auto items-center hide-scroll snap-x scroll-smooth outline-none min-h-[60px]"></div>
            </div>
<div class="px-6 pb-32"> 
                <div class="flex justify-between items-start mb-2">
                    <span id="detailCat" class="text-[10px] font-extrabold text-primary uppercase tracking-widest pt-1"></span>
                    <button id="modalHeartBtn" onclick="toggleFavoriteCurrentDetail()" class="p-2 -mr-2 -mt-2 rounded-full hover:bg-slate-50 active-scale">
                        <i data-lucide="heart" class="w-6 h-6 text-slate-300"></i>
                    </button>
                </div>

                <div id="modalTimer" class="hidden timer-accent p-2 rounded-lg mb-4 flex items-center gap-2">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span id="modalTimerText" class="text-xs font-bold"></span>
                </div>

                <h2 id="detailName" class="font-display text-2xl md:text-3xl font-bold text-slate-900 mb-1"></h2>

                <div class="flex flex-col space-y-6 mt-4"> 
                    <div>
                        <div id="detailSkuContainer" class="mb-3">
                            <span class="text-[10px] font-mono bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase tracking-wider">SKU: <span id="detailSku"></span></span>
                        </div>
                        <p id="detailDesc" class="text-slate-500 text-sm leading-relaxed"></p>
                    </div>

                    <div id="sizesWrapper" class="hidden border-t border-slate-50 pt-6">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">Escolha o Tamanho</label>
                        <div id="detailSizesContainer" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div id="colorsWrapper" class="hidden border-t border-slate-50 pt-6">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">Escolha a Cor</label>
                        <div id="detailColorsContainer" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div id="relatedProductsSection" class="border-t border-slate-50 pt-8 hidden">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 block">Quem viu tamb√©m viu</label>
                        <div id="relatedGrid" class="flex overflow-x-auto gap-3 pb-4 hide-scroll -mx-2 px-2"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t flex items-center justify-between bg-white/95 backdrop-blur-md z-20 absolute bottom-0 w-full shadow-[0_-4px_10px_-1px_rgba(0,0,0,0.08)]">
                <div class="flex flex-col min-w-0 flex-1">
                    <span id="detailOldPrice" class="text-xs text-slate-400 line-through"></span>
                    <div id="detailPrice" class="leading-tight"></div> 
                </div>
                <div class="flex items-center gap-2 ml-2">
                    <div class="flex items-center bg-slate-100 rounded-xl px-1 h-12">
                        <button onclick="adjustDetailQty(-1)" class="w-8 h-full font-bold text-lg text-slate-500">-</button>
                        <span id="detailQtyDisplay" class="font-bold w-6 text-center text-sm">1</span>
                        <button onclick="adjustDetailQty(1)" class="w-8 h-full font-bold text-lg text-slate-500">+</button>
                    </div>
                    <button id="detailAddBtn" class="bg-primary hover:bg-primaryDark text-white font-bold px-4 md:px-6 h-12 rounded-xl active-scale shadow-lg disabled:opacity-40 transition-all text-sm whitespace-nowrap">
                        Adicionar
                    </button>
                </div>
            </div>
    </div>
</div>


    <!-- MODAL: ZOOM -->
    <div id="modalImageZoom" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-md opacity-0 transition-opacity duration-300 cursor-zoom-out" onclick="closeImageZoom()">
        <button class="absolute top-4 right-4 text-white/80 p-3"><i data-lucide="x" class="w-10 h-10"></i></button>
        <img id="zoomedImg" class="max-w-full max-h-full object-contain transform scale-95 transition-transform duration-300">
    </div>

    <!-- MODAL: CARRINHO -->
        <div id="modalCart" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeCartModal()"></div>
    
    <div id="cartDrawer" class="absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl flex flex-col transform translate-x-full transition-transform duration-300">
        
        <div class="p-5 border-b flex justify-between items-center bg-white z-10">
            <div class="flex items-center gap-2">
                <button id="btnBackStep" onclick="goToStep1()" class="hidden p-2 -ml-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i>
                </button>
                <h3 id="cartTitle" class="font-bold text-lg">Minha Sacola</h3>
            </div>
            <button onclick="closeCartModal()"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
        </div>

        <div id="step1" class="flex-1 overflow-y-auto flex flex-col">
            <div id="cartList" class="p-4 space-y-3 bg-slate-50 flex-1"></div>
            
            <div id="cartEmptyMsg" class="hidden text-center text-slate-400 py-10 px-6">
                <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
                <p>Sua sacola est√° vazia.</p>
            </div>

            <div id="footerStep1" class="p-5 border-t bg-white shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between text-xl font-display font-black text-slate-900 mb-4">
                    <span>Subtotal</span>
                    <span class="subtotal-display">R$ 0,00</span>
                </div>
                <button onclick="goToStep2()" class="w-full bg-primary hover:brightness-90 text-white font-bold py-4 rounded-2xl shadow-lg active-scale flex justify-center items-center gap-2 transition-all">
                    Continuar para Entrega <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="step2" class="hidden flex-1 overflow-y-auto bg-slate-50 flex flex-col">
            <div class="p-5 space-y-4 flex-1">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-3">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Dados do Pedido</h4>
                    
                    <input type="text" id="checkName" placeholder="Seu Nome Completo" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                    
                    <input type="tel" id="checkPhone" placeholder="Seu WhatsApp com DDD" oninput="this.value = this.value.replace(/\D/g,'')" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                    
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <select id="checkPayment" onchange="toggleChangeField(this.value)" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                                <option value="" disabled selected>Pagamento</option>
                                <option value="Pix">Pix</option>
                                <option value="Cart√£o">Cart√£o</option>
                                <option value="Dinheiro">Dinheiro</option>
                            </select>
                            <select id="cartDeliverySelect" onchange="toggleAddressFields()" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></select>
                        </div>

                        <div id="changeField" class="hidden animate-fade-in bg-amber-50 p-3 rounded-xl border border-amber-100">
    <label class="text-[9px] font-black text-amber-600 uppercase tracking-widest ml-1">Troco para quanto?</label>
    <div class="relative mt-1">
        <span class="absolute left-3 top-2.5 text-amber-600 text-sm font-bold">R$</span>
        <input type="number" id="checkChange" placeholder="Ex: 100,00" 
               class="w-full bg-white border border-amber-200 rounded-lg p-2 pl-10 text-sm outline-none focus:ring-2 focus:ring-amber-400/20">
    </div>
</div>

<div id="cardInstallmentsField" class="hidden animate-fade-in bg-blue-50 p-3 rounded-xl border border-blue-100 mt-2">
    <label class="text-[9px] font-black text-blue-600 uppercase tracking-widest ml-1">Parcelamento</label>
    <select id="checkInstallments" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm outline-none mt-1">
        </select>
</div>

                    <div id="addressFields" class="space-y-3 animate-fade-in hidden">
                        <input type="text" id="checkStreet" placeholder="Nome da Rua / Avenida" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                        
                        <div class="flex gap-2">
                            <input type="text" id="checkNumber" placeholder="N¬∫" class="w-20 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                            <input type="text" id="checkNeighborhood" placeholder="Bairro" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                        
                        <input type="text" id="checkReference" placeholder="Ponto de Refer√™ncia" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
                    </div>
                </div>
            </div>
            
            <div class="p-5 border-t bg-white mt-auto">
                <div class="flex justify-between text-xl font-display font-black text-slate-900 mb-4">
                    <span>Total</span>
                    <span id="cartFinalTotal">R$ 0,00</span>
                </div>
                <button onclick="checkoutWhatsApp()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-4 rounded-2xl shadow-lg active-scale flex justify-center items-center gap-3 transition-all">
                    Finalizar Pedido <i data-lucide="message-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        </div> </div>
    
    <div id="filterModal" class="fixed inset-0 z-[150] hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeFilterDrawer()"></div>
    
    <div id="filterDrawer" class="absolute inset-y-0 right-0 max-w-xs w-full bg-white flex flex-col transform translate-x-full transition-transform duration-300 shadow-2xl">
        <div class="p-5 border-b flex justify-between items-center">
            <h3 class="font-bold text-slate-800">Filtrar</h3>
            <button onclick="closeFilterDrawer()" class="p-2 hover:bg-slate-100 rounded-full">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div class="p-5 space-y-8 flex-1 overflow-y-auto custom-scrollbar">
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Pre√ßo M√°ximo</label>
                <input id="filterMaxPrice" type="number" placeholder="At√© R$..." 
                       oninput="filters.maxPrice = this.value ? parseFloat(this.value) : null; renderCatalog(); updateFilterBadge();" 
                       class="w-full border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-primary/20">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Tamanhos</label>
                <div id="filterSizesContainer" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Cores</label>
                <div id="filterColorsContainer" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
        
        <div class="p-5 border-t bg-slate-50 flex flex-col gap-2">
            <button onclick="closeFilterDrawer()" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg active-scale">
                Ver Resultados
            </button>
            <button onclick="resetAllFilters(); closeFilterDrawer();" class="w-full text-slate-500 font-bold py-2 text-sm">
                Limpar Filtros
            </button>
        </div>
    </div>
         </div>
    

    <!-- MODAL: TAXAS -->
    <div id="modalDelivery" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="document.getElementById('modalDelivery').classList.add('hidden')"></div>
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-lg mb-4 text-slate-900">Taxas de Entrega</h3>
            <div id="deliveryList" class="space-y-2 max-h-[50vh] overflow-y-auto mb-6"></div>
            <button onclick="document.getElementById('modalDelivery').classList.add('hidden')" class="w-full py-3 bg-slate-100 font-bold text-slate-600 rounded-xl font-display">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            initializeFirestore, 
            persistentLocalCache, 
            persistentMultipleTabManager, 
            doc, 
            getDoc, 
            getDocFromCache, 
            getDocFromServer,
            getDocs, 
            getDocsFromCache,
            getDocsFromServer,
            collection, 
            query, 
            where, 
            increment, 
            setDoc, 
            updateDoc, 
            Timestamp,
            writeBatch,
            addDoc,
    serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

                // --- CONFIGURA√á√ÉO & ESTADO ---
        const FIREBASE_CONFIG = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.firebasestorage.app", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };
        const app = initializeApp(FIREBASE_CONFIG);
        const db = initializeFirestore(app, { localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() }) });
        const auth = getAuth(app);
        
        let STORE_ID = null;
        let FAV_KEY = ""; 
        let favorites = []; // Declarado apenas uma vez aqui
        let allProducts=[], categories=[], cart=[], lojaZapDestino = "" , storeOpen=true;
        let productViewBuffer = new Set();
        let failedSearchBuffer = new Set();
        let analyticsTimer = null;
        let searchDebounceTimer = null;
        let storeConfigGlobal = {};
        let deliveryAreas=[], currentDetailId=null, currentDetailQty=1, currentDetailSelection = { size: null, color: null };
        let currentDetailImages = [], currentDetailImageIndex = 0;
        let filters = { search: "", category: null, maxPrice: null, sizes: [], colors: [] };
        let isFavoritesView = false;

// --- CONFIGURA√á√ÉO ANTIBOT ---
const BOT_CONFIG = {
    minSearchLength: 3,
    maxSearchLength: 30,
    searchCooldown: 2500, // 2.5 segundos entre registros
    forbiddenChars: /[<>{}\[\]\\/|]/g, // Caracteres usados em ataques/bots
};

// Vari√°vel para controle de tempo local
let lastSearchRecordedAt = 0;

function isBotLikely() {
    // Detecta se √© um navegador automatizado simples (Headless Chrome, etc)
    return navigator.webdriver === true;
}

function sanitizeTerm(term) {
    // Remove espa√ßos extras e caracteres proibidos
    return term.trim()
               .toLowerCase()
               .replace(BOT_CONFIG.forbiddenChars, '')
               .substring(0, BOT_CONFIG.maxSearchLength);
}

        
                // --- DATA SERVICE OTIMIZADO ---
const DataService = {
    async getStoreConfig() {
        const configRef = doc(db, `stores/${STORE_ID}/config/store`);
        const snap = await getDocFromServer(configRef); 
        return snap.data();
    },

    async getProducts(forceServer = false) {
        const colRef = collection(db, `stores/${STORE_ID}/products`);
        try {
            const snap = forceServer 
                ? await getDocsFromServer(colRef) 
                : await getDocs(colRef);
            return snap.docs.map(d => ({id: d.id, ...d.data()})).filter(p => p.status === 'active');
        } catch (e) {
            console.error("Erro ao buscar produtos:", e);
            return [];
        }
    },

    async getBanners(forceServer = false) {
    // Trocamos 'banners' por 'hero_cards' para bater com o Painel Admin
    const colRef = collection(db, `stores/${STORE_ID}/hero_cards`); 
    try {
        const snap = forceServer 
            ? await getDocsFromServer(colRef) 
            : await getDocs(colRef);
        return snap.docs.map(d => ({id: d.id, ...d.data()}));
    } catch (e) {
        console.error("Erro ao buscar banners:", e);
        return [];
    }
}
};


        // --- APP INITIALIZATION (VERS√ÉO MULTILOJA PROFISSIONAL) ---
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    
    // 1. CAPTURA O NOME DA LOJA PELA BARRA (Ex: /loja-da-barbara)
    const pathSegments = window.location.pathname.split('/');
    // O split cria um array, onde o √≠ndice [1] √© o que vem ap√≥s a primeira barra
    const slugDaUrl = pathSegments[1];

    // 2. DEFINE O STORE_ID (Prioridade para a URL amig√°vel)
    // Se n√£o houver nada na barra, ele tenta o antigo ?id=, sen√£o usa 'admin'
    STORE_ID = slugDaUrl || urlParams.get('id') || 'admin';
    
    // 3. FILTRO DE SEGURAN√áA
    // Impede que nomes de arquivos t√©cnicos sejam lidos como nomes de lojas
    if (STORE_ID === "" || STORE_ID === "index.html" || STORE_ID === "index") {
        STORE_ID = "admin"; 
    }

    // Define a chave √∫nica para favoritos desta loja
    FAV_KEY = `favs_v2_${STORE_ID}`;
    
    try {
        const saved = localStorage.getItem(FAV_KEY);
        favorites = saved ? JSON.parse(saved) : [];
    } catch (e) {
        favorites = [];
    }
    
    await signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => { if(user) initFlow(); });
    setupSwipes();
});


                   async function initFlow() {
    try {
        // 1. LER CONFIGURA√á√ÉO DO SERVIDOR (Custo: 1 leitura)
        const config = await DataService.getStoreConfig();
        if(!config) {
            showFatalError("Loja n√£o encontrada", "Verifique o ID da loja.");
            return;
        }

        if(config.subscriptionStatus === 'suspended') { 
            showFatalError("Indispon√≠vel", "Assinatura suspensa."); 
            return; 
        }

        storeConfigGlobal = config;
        applyStoreConfig(config);

        // 2. GERENCIAMENTO DE CACHE
        const CACHE_KEY = `app_cache_v4_${STORE_ID}`;
        const cachedRaw = localStorage.getItem(CACHE_KEY);
        const cached = cachedRaw ? JSON.parse(cachedRaw) : null;
        
        const serverLastUpdate = config.lastUpdate || "initial";
        const needsUpdate = !cached || serverLastUpdate !== cached.lastUpdate;

        if (needsUpdate) {
            console.log("üîÑ Vers√£o nova. Sincronizando com servidor...");
            
            const [products, banners] = await Promise.all([
                DataService.getProducts(true), 
                DataService.getBanners(true)
            ]);
            
            allProducts = products;
            categories = Array.from(new Set(products.map(p => p.category).filter(Boolean))).sort();
            
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                products, 
                banners: banners || [], 
                categories: categories, 
                lastUpdate: serverLastUpdate
            }));
            
            renderHeroCarousel(banners || []);
        } else {
            console.log("üöÄ Vers√£o id√™ntica. Usando Cache Local.");
            allProducts = cached.products;
            categories = cached.categories;
            renderHeroCarousel(cached.banners || []);
        }

        // 3. RENDERIZA√á√ÉO DA INTERFACE
        renderCategoryTabs();
        await renderCatalog();
        populateFilterOptions();
        updateFavoritesUI();
        checkDeepLink();
        registerVisit();
        
        hideLoader();

    } catch (error) {
        console.error("Erro cr√≠tico:", error);
        showFatalError("Erro de Conex√£o", "N√£o foi poss√≠vel carregar os dados.");
        hideLoader();
    }
                   }     
        
        
        // --- RENDERERS ---
                       window.renderCatalog = async () => {
            // Chamamos a renderiza√ß√£o m√°gica usando a global segura
           await renderMagicCategories(allProducts, storeConfigGlobal);

            const container = document.getElementById('catalogContainer'), 
                  empty = document.getElementById('emptyState');
            
            if (!container) return; // Prote√ß√£o extra
            
            empty.classList.add('hidden');
            container.innerHTML = '';

    let filtered = allProducts.filter(p => {
        if(isFavoritesView) return favorites.includes(p.id);
        if(filters.search) {
            const searchLower = filters.search.toLowerCase();
            const nameMatch = p.name.toLowerCase().includes(searchLower);
            const skuMatch = p.sku && p.sku.toLowerCase().includes(searchLower);
            if (!nameMatch && !skuMatch) return false;
        }
        if(filters.category === 'offers') { 
            if(!(p.promoValue && p.promoValue < p.value)) return false; 
        } else if(filters.category && p.category !== filters.category) return false;
        const price = (p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value;
        if(filters.maxPrice && price > filters.maxPrice) return false;
        if(filters.sizes.length > 0 || filters.colors.length > 0) {
            if (p.variations && p.variations.length > 0) {
                const hasMatch = p.variations.some(v => {
                    if (!v.active) return false;
                    const sizeMatch = filters.sizes.length === 0 || filters.sizes.includes(v.size);
                    const colorMatch = filters.colors.length === 0 || filters.colors.includes(v.color);
                    return sizeMatch && colorMatch;
                });
                if (!hasMatch) return false;
            } else {
                const sizeMatchBase = filters.sizes.length === 0 || p.sizes?.some(s => filters.sizes.includes(s));
                const colorMatchBase = filters.colors.length === 0 || p.colors?.some(c => filters.colors.includes(c));
                if (!sizeMatchBase || !colorMatchBase) return false;
            }
        }
        return true;
    });

    if (filtered.length === 0) {
        empty.classList.remove('hidden');
        if (filters.search) {
            trackFailedSearch(filters.search);
        }
        return;
    }

    const groups = {};
    if(isFavoritesView || filters.search || (filters.category && filters.category !== 'offers') || filters.maxPrice) {
        groups['Resultados Encontrados'] = filtered;
    } else {
        filtered.forEach(p => { 
            const k = p.category || 'Geral'; 
            if(!groups[k]) groups[k]=[]; 
            groups[k].push(p); 
        });
    }

    Object.keys(groups).sort().forEach(key => {
        const section = document.createElement('section');
        section.className = "animate-fade-in mb-8";
        section.innerHTML = `<h3 class="font-bold text-slate-800 mb-4 px-1 text-lg flex items-center gap-2"><div class="w-1 h-5 bg-primary rounded-full"></div> ${key}</h3>`;
        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-5";
        groups[key].forEach(p => grid.innerHTML += mkProductCard(p));
        section.appendChild(grid); 
        container.appendChild(section);
    });
    
    lucide.createIcons();

             initGlobalCountdowns();              
}; 

        // Fun√ß√£o cir√∫rgica para determinar o pre√ßo atual baseado no m√©todo de pagamento
function getActivePrice(p, method) {
    if (!p) return 0;
    
    const agora = Date.now();
    const isPromoValid = p.promoValue && p.promoValue < p.value && (p.promoUntil ? p.promoUntil > agora : true);
    
    // Pre√ßos base para c√°lculo da diferen√ßa
    const precoPixBase = p.priceCash || p.value;
    const precoCardBase = p.priceCard || p.value;
    const diferencaCartao = precoCardBase - precoPixBase;

    if (method === 'Cart√£o') {
        // Se houver oferta, o pre√ßo do cart√£o √© a Oferta + a diferen√ßa do cart√£o
        if (isPromoValid) {
            return p.promoValue + diferencaCartao;
        }
        return precoCardBase;
    }

    // L√≥gica para PIX/Dinheiro
    if (isPromoValid) return p.promoValue; 
    return precoPixBase;          
}

        function mkProductCard(p) {
    const agora = Date.now();
    const isPromoValid = p.promoValue && p.promoValue < p.value && (p.promoUntil ? p.promoUntil > agora : true);
    const hasPromo = !!isPromoValid;
    
    // 1. Defini√ß√£o dos Pre√ßos Base para calcular a diferen√ßa
    const precoPixBase = p.priceCash || p.value;
    const precoCardBase = p.priceCard || p.value;
    const diferencaCartao = precoCardBase - precoPixBase;

    // 2. Pre√ßo Principal (Pix/Dinheiro)
    const bestPrice = hasPromo ? p.promoValue : precoPixBase;
    
    // 3. Pre√ßo do Cart√£o Adaptado (Oferta + Diferen√ßa ou Pre√ßo Cheio + Diferen√ßa)
    const cardPriceAdaptado = hasPromo ? (p.promoValue + diferencaCartao) : precoCardBase;

    const img = p.images?.[0] || 'https://placehold.co/600?text=Sem+Imagem';
    const isFav = favorites.includes(p.id);
    const outOfStock = (parseInt(p.stock) || 0) <= 0;
    
    const disc = hasPromo && !outOfStock ? `<span class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded-bl-lg z-10">-${Math.round(((p.value - p.promoValue) / p.value) * 100)}%</span>` : '';
    const stockBadge = outOfStock ? `<span class="absolute inset-0 bg-white/60 flex items-center justify-center text-red-600 font-black text-xs uppercase z-20">Esgotado</span>` : '';

    return `<div onclick="${outOfStock ? '' : `openProductModal('${p.id}')`}" class="product-card cursor-pointer group flex flex-col h-full relative ${outOfStock ? 'opacity-70 grayscale' : ''}">
        <div class="aspect-square bg-white relative overflow-hidden border-b border-slate-50">
            ${stockBadge}
            <img src="${img}" class="w-full h-full object-cover transition-transform duration-500 ${outOfStock ? '' : 'group-hover:scale-105'}" loading="lazy">
            ${disc}
            <button onclick="event.stopPropagation(); toggleFavorite('${p.id}')" class="absolute top-2 left-2 p-1.5 rounded-full bg-white/80 backdrop-blur-sm z-20">
                <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'heart-active' : 'text-slate-400'}"></i>
            </button>
        </div>
        <div class="p-3 md:p-4 flex flex-col flex-grow bg-white">
            <div class="product-timer hidden mb-2 py-1 px-2 rounded-lg flex items-center gap-1.5 timer-accent animate-pulse" data-pid="${p.id}">
                <i data-lucide="clock" class="w-3 h-3"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter countdown-text">Carregando...</span>
            </div>
            <h4 class="text-sm font-semibold text-slate-700 leading-snug line-clamp-2 mb-2">${p.name}</h4>
            <div class="mt-auto pt-1">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">
                        ${hasPromo ? 'Oferta Especial' : '√Ä vista no Pix'}
                    </span>
                    <div class="flex items-center justify-between">
                        <span class="text-lg md:text-xl font-display font-black text-slate-900 tracking-tight">
                            R$ ${bestPrice.toFixed(2).replace('.',',')}
                        </span>
                        ${outOfStock ? '' : `
                        <button onclick="event.stopPropagation(); quickAdd('${p.id}')" class="w-8 h-8 rounded-full bg-primary/10 hover:bg-primary text-primary hover:text-white flex items-center justify-center transition-colors active-scale">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>`}
                    </div>
                    
                    <div class="flex flex-col mt-1 pt-1 border-t border-slate-50">
                        <span class="text-[9px] font-bold text-blue-600">
                            Ou R$ ${cardPriceAdaptado.toFixed(2).replace('.',',')} no cart√£o
                        </span>
                        ${(p.maxInstallments > 1) ? `
                            <span class="text-[9px] text-slate-400 font-medium">
                                Em at√© ${p.maxInstallments}x de R$ ${(cardPriceAdaptado / p.maxInstallments).toFixed(2).replace('.', ',')}
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}
        // --- LOGICA DE DETALHES DO PRODUTO (VERS√ÉO COMPLETA E CORRIGIDA) ---
window.openProductModal = (id) => { 
    document.getElementById('modalTimer')?.classList.add('hidden');
    const p = allProducts.find(x => x.id === id); 
    if(!p) return; 

    const productUrl = window.location.origin + window.location.pathname + '?id=' + p.id;

const metaUpdates = {
    'og:title': p.name,
    'og:description': p.description || "Confira em nossa vitrine!",
    'og:image': p.images?.[0] || '',
    'og:url': productUrl,
    'product:price:amount': p.promoValue || p.value,
    'product:price:currency': 'BRL',
    'product:availability': (parseInt(p.stock) > 0) ? 'in stock' : 'out of stock',
    'product:condition': 'new',
    'product:brand': storeConfigGlobal.storeName || 'Vitrine'
};

// Aplica as atualiza√ß√µes no cabe√ßalho da p√°gina em tempo real
Object.keys(metaUpdates).forEach(prop => {
    let el = document.querySelector(`meta[property="${prop}"]`);
    if (!el) {
        el = document.createElement('meta');
        el.setAttribute('property', prop);
        document.head.appendChild(el);
    }
    el.setAttribute('content', metaUpdates[prop]);
});

    // 1. Atualiza a URL na barra de endere√ßos sem recarregar a p√°gina
    const newURL = window.location.pathname + `?id=${p.id}`;
    window.history.pushState({ path: newURL }, '', newURL);

    // 2. Atualiza o T√≠tulo da Aba e as Meta Tags para o "rob√¥" do WhatsApp/Instagram
    document.title = `${p.name} | ${storeConfigGlobal.storeName || 'Vitrine'}`;
    const metaTitle = document.getElementById('og-title');
    const metaDesc = document.getElementById('og-desc');
    const metaImg = document.getElementById('og-img');
    
    if(metaTitle) metaTitle.content = p.name;
    if(metaDesc) metaDesc.content = p.description || "Confira esse produto incr√≠vel!";
    if(metaImg) metaImg.content = p.images?.[0] || '';

    // --- FIM DO BLOCO DE DEEP LINKING ---

    // CORRE√á√ÉO: Chama o rastreio com prote√ß√£o para n√£o travar o modal
    try { 
        if (typeof trackProductView === 'function') trackProductView(p.id); 
    } catch(e) { console.error("Erro no analytics"); }

    currentDetailId = id; 
    currentDetailQty = 1; 
    
    currentDetailSelection = { 
        size: null, 
        color: null, 
        image: p.images?.[0] || 'https://placehold.co/600?text=Sem+Imagem' 
    }; 

    
    const mainImages = (p.images?.length) ? p.images : ['https://placehold.co/600?text=Sem+Imagem'];
    const variationImages = (p.variations || [])
        .map(v => v.image)
        .filter(img => img && !mainImages.includes(img));
    
    currentDetailImages = [...mainImages, ...variationImages];
    currentDetailImageIndex = 0;
    
    // Renderiza a estrutura b√°sica
    if(typeof renderThumbnails === 'function') renderThumbnails();
    if(typeof updateDetailImageDisplay === 'function') updateDetailImageDisplay();
    
    document.getElementById('detailCat').textContent = p.category || "Geral"; 
    document.getElementById('detailName').textContent = p.name; 
    document.getElementById('detailSku').textContent = p.sku || 'N/A';
    document.getElementById('detailDesc').textContent = p.description || ''; 

    // --- SUA L√ìGICA DE VARIA√á√ïES COMPLETA ---
    const renderVariationUI = () => {
        const matrix = p.variations || [];
        const hasS = p.sizes?.length > 0, hasC = p.colors?.length > 0;
  
     const updatePrices = () => {
    const agora = Date.now();
    const isPromoAtiva = p.promoValue && p.promoValue < p.value && (!p.promoUntil || p.promoUntil > agora);
    const fatorDesconto = isPromoAtiva ? (p.promoValue / p.value) : 1;
    
    let basePrice = p.value; // Pre√ßo base (Cart√£o) vindo do produto principal
    let skuDinamico = p.sku || 'N/A'; 
    let isComplete = (!hasS || currentDetailSelection.size) && (!hasC || currentDetailSelection.color);
    let outOfStockVariation = false;

    // 1. L√≥gica de Varia√ß√£o (Tamanho/Cor)
    if(isComplete && matrix.length) {
        const comb = matrix.find(v => 
            (!hasS || v.size.trim().toLowerCase() === (currentDetailSelection.size||"").trim().toLowerCase()) && 
            (!hasC || v.color.trim().toLowerCase() === (currentDetailSelection.color||"").trim().toLowerCase())
        );

        if(comb && comb.active) { 
            const vStock = parseInt(comb.stock) || 0;
            if(vStock <= 0) {
                outOfStockVariation = true;
                isComplete = false; 
            }
            basePrice = comb.price; // Pre√ßo base vindo da varia√ß√£o
            skuDinamico = comb.sku || skuDinamico;
            currentDetailSelection.image = comb.image || p.images[0]; 

            if (comb.image) {
                const imgIdx = currentDetailImages.indexOf(comb.image);
                if (imgIdx !== -1) setDetailImage(imgIdx);
            }
        } else if(hasS || hasC) {
            isComplete = false;
        }
    }

    // 2. C√°lculo da Hierarquia de Pre√ßos (PIX vs Cart√£o)
    // 1. Calcula a diferen√ßa fixa do cart√£o em rela√ß√£o ao pre√ßo base (Pix)
    const precoPixBase = p.priceCash || basePrice;
    const precoCardBase = p.priceCard || basePrice;
    const diferencaCartao = precoCardBase - precoPixBase;

    // 2. Define o pre√ßo final do Pix (com ou sem promo√ß√£o)
    const finalPricePix = isPromoAtiva ? (basePrice * fatorDesconto) : precoPixBase;

// 1. C√ÅLCULO DA L√ìGICA (Permanece como voc√™ postou)
const finalPriceCard = isPromoAtiva ? (finalPricePix + diferencaCartao) : precoCardBase;
const oldP = isPromoAtiva ? basePrice : null;

// 2. ATUALIZA√á√ÉO VISUAL (Foco em quem tem dificuldade visual)
const priceDisplay = document.getElementById('detailPrice');
if (priceDisplay) {
    priceDisplay.innerHTML = `
        <div class="flex flex-col min-w-0 py-1">
            <div class="mb-1">
                <span class="text-[11px] font-black ${isPromoAtiva ? 'text-primary' : 'text-slate-500'} uppercase tracking-tighter">
                    ${isPromoAtiva ? 'Pre√ßo de Oferta' : '√Ä vista'}
                </span>
            </div>
            
            <div class="flex items-baseline mb-1">
                <span class="text-3xl md:text-4xl font-display font-black text-slate-900 leading-[0.9] tracking-tight">
                    R$ ${finalPricePix.toFixed(2).replace('.',',')}
                </span>
            </div>

            <div class="flex flex-col mt-1 space-y-0.5">
                <span class="text-[13px] font-black text-blue-800 leading-none">
                    Cart√£o: R$ ${finalPriceCard.toFixed(2).replace('.',',')}
                </span>
                ${(p.maxInstallments > 1) ? `
                    <span class="text-[11px] text-slate-700 font-bold leading-none">
                        At√© ${p.maxInstallments}x de R$ ${(finalPriceCard / p.maxInstallments).toFixed(2).replace('.', ',')}
                    </span>
                ` : ''}
            </div>
        </div>
    `;
}

// 3. ATUALIZA√á√ÉO DO PRE√áO RISCADO (Fora da div principal)
const oldPriceEl = document.getElementById('detailOldPrice');
if (oldPriceEl) {
    oldPriceEl.textContent = oldP ? `R$ ${oldP.toFixed(2).replace('.',',')}` : '';
}

if(typeof lucide !== 'undefined') lucide.createIcons();
   
    // 4. Atualiza SKU e Pre√ßo Antigo
    document.getElementById('detailOldPrice').textContent = oldP ? `R$ ${oldP.toFixed(2).replace('.',',')}` : '';
    document.getElementById('detailSku').textContent = skuDinamico; 
    
    // 5. Controle do Bot√£o de Adicionar
    const btnAdd = document.getElementById('detailAddBtn');
    if (outOfStockVariation) {
        btnAdd.textContent = "Esgotado";
        btnAdd.disabled = true;
        btnAdd.className = "bg-slate-400 text-white font-bold px-4 md:px-8 h-12 rounded-xl opacity-50 cursor-not-allowed text-sm md:text-base";
    } else {
        btnAdd.textContent = "Adicionar";
        btnAdd.disabled = !isComplete;
        // Aplica opacidade apenas se a sele√ß√£o estiver incompleta
        btnAdd.className = `bg-primary hover:bg-primaryDark text-white font-bold px-4 md:px-8 h-12 rounded-xl active-scale shadow-lg transition-all text-sm md:text-base ${!isComplete ? 'opacity-40' : ''}`;
    }
    
    // 6. Salva o estado atual para o carrinho
    p.currentFinalPrice = finalPricePix; 
    p.currentSKU = skuDinamico; 
};

        const renderChips = (list, type, container, wrapper) => {
            container.innerHTML = '';
            if(!list?.length) { wrapper.classList.add('hidden'); return; }
            wrapper.classList.remove('hidden');
            const otherType = type === 'size' ? 'color' : 'size';
            const otherVal = currentDetailSelection[otherType];

            list.forEach(val => {
                const chip = document.createElement('div');
                const normVal = val.trim().toLowerCase();
                const isSelected = currentDetailSelection[type] && currentDetailSelection[type].trim().toLowerCase() === normVal;
                
                let isPossible = true;
                if(matrix.length) {
                    isPossible = matrix.some(v => 
                        v.active && 
                        (parseInt(v.stock) > 0) && 
                        v[type].trim().toLowerCase() === normVal && 
                        (!otherVal || v[otherType].trim().toLowerCase() === otherVal.trim().toLowerCase())
                    );
                }

                const CHIP_S = "border-primary bg-primary text-white font-bold ring-2 ring-primary/20 shadow-md";
                const CHIP_D = "border-slate-200 bg-slate-50 text-slate-600 hover:bg-slate-100";
                
                chip.className = `px-4 py-2 border rounded-lg text-xs chip-common ${isSelected ? CHIP_S : (isPossible ? CHIP_D : 'chip-disabled')}`;
                chip.textContent = val;
                chip.onclick = () => { 
                    if(!isPossible) return; 
                    currentDetailSelection[type] = isSelected ? null : val; 
                    renderVariationUI(); 
                };
                container.appendChild(chip);
            });
        };

        renderChips(p.sizes, 'size', document.getElementById('detailSizesContainer'), document.getElementById('sizesWrapper'));
        renderChips(p.colors, 'color', document.getElementById('detailColorsContainer'), document.getElementById('colorsWrapper'));
        updatePrices();
    };

    renderVariationUI();
    document.getElementById('detailQtyDisplay').textContent = "1"; 
    
    // CORRE√á√ÉO: Chama fun√ß√µes de apoio com seguran√ßa
    if(typeof updateModalHeartBtn === 'function') updateModalHeartBtn(); 
    if(typeof renderRelatedProducts === 'function') renderRelatedProducts(p);
    
    document.getElementById('detailAddBtn').onclick = () => { addToCart(p, currentDetailQty, currentDetailSelection); }; 
    
    document.getElementById('modalDetails').classList.remove('hidden'); 
    if(window.lucide) lucide.createIcons();
};
        
            
                         
       // --- NOVA L√ìGICA DE RASTREIO COM CACHE DE 2 MINUTOS ---
function trackFailedSearch(term) {
    if (isBotLikely()) return; 

    const cleanTerm = sanitizeTerm(term);
    const now = Date.now();

    // Valida√ß√µes Antibot:
    if (cleanTerm.length < BOT_CONFIG.minSearchLength) return;
    if (now - lastSearchRecordedAt < BOT_CONFIG.searchCooldown) return;

    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
        failedSearchBuffer.add(cleanTerm);
        lastSearchRecordedAt = Date.now(); 
        startAnalyticsTimer();
    }, 1500); 
}

function startAnalyticsTimer() {
    if (!analyticsTimer) {
        analyticsTimer = setTimeout(async () => {
            await flushAnalyticsBuffer();
            analyticsTimer = null;
        }, 60000);
    }
}

async function flushAnalyticsBuffer() {
    if (productViewBuffer.size === 0 && failedSearchBuffer.size === 0) return;
    const analyticsRef = doc(db, `stores/${STORE_ID}/analytics`, "product_views");
    const updates = { lastUpdate: Timestamp.now() };

    productViewBuffer.forEach(id => {
        updates[`stats.${id}.views`] = increment(1);
        const p = allProducts.find(x => x.id === id);
        if (p) updates[`stats.${id}.name`] = p.name;
    });
    productViewBuffer.clear();

    failedSearchBuffer.forEach(term => {
        updates[`searches.${term}`] = increment(1);
    });
    failedSearchBuffer.clear();

    try {
        await updateDoc(analyticsRef, updates);
    } catch (e) {
        if (e.code === 'not-found') await setDoc(analyticsRef, updates);
    }
}

window.addEventListener('beforeunload', () => {
    if (productViewBuffer.size > 0 || failedSearchBuffer.size > 0) {
        flushAnalyticsBuffer();
    }
});


// --- UTILS ---
        window.handleSearchInput = (v) => { filters.search=v; renderCatalog(); };
        window.resetAllFilters = () => {
    // Reseta as vari√°veis
    filters = { search: "", category: null, maxPrice: null, sizes: [], colors: [] };
    isFavoritesView = false;
    
    // Limpa fisicamente TODOS os inputs da p√°gina
    const inputs = document.querySelectorAll('input');
    inputs.forEach(i => {
        i.value = '';
        i.checked = false;
    });

    // Atualiza a tela
    renderCategoryTabs();
    renderCatalog();
    updateFilterBadge();
    
    // Garante que o cat√°logo volte ao topo
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

        window.toggleFavorite = (id) => { 
    // 1. "Fotografa" a posi√ß√£o de scroll de todos os carross√©is antes de resetar
    const containers = document.querySelectorAll('.hide-scroll');
    const positions = Array.from(containers).map(el => ({
        element: el,
        scrollLeft: el.scrollLeft
    }));

    const idx = favorites.indexOf(id); 
    if(idx > -1) {
        favorites.splice(idx, 1); 
    } else {
        favorites.push(id); 
    }
    
    // Salva localmente
    localStorage.setItem(FAV_KEY, JSON.stringify(favorites)); 
    
    // 2. Renderiza novamente (isso normalmente resetaria o scroll)
    renderCatalog(); 
    updateFavoritesUI(); 
    if(currentDetailId === id) updateModalHeartBtn(); 

    // 3. Devolve o scroll para onde estava instantaneamente
    // Usamos um pequeno timeout de 0ms para garantir que o DOM j√° foi redesenhado
    setTimeout(() => {
        const newContainers = document.querySelectorAll('.hide-scroll');
        newContainers.forEach((el, i) => {
            if(positions[i]) el.scrollLeft = positions[i].scrollLeft;
        });
    }, 0);
};
            
        window.toggleFavoritesView = () => { isFavoritesView = !isFavoritesView; renderCategoryTabs(); renderCatalog(); window.scrollTo({top:0, behavior:'smooth'}); };
        window.updateFavoritesUI = () => {
    const count = favorites.length;
    const badge = document.getElementById('favBadgeDesktop');
    const heartIcon = document.getElementById('headerHeartIcon');
    const favBtn = document.getElementById('headerFavBtn');

    if (!badge || !heartIcon || !favBtn) return;

    // Atualiza o contador (Badge)
    badge.textContent = count;
    badge.classList.toggle('scale-0', count === 0);

    // L√≥gica de cores baseada no tema
    if (count > 0) {
        // Ativa a cor do tema
        heartIcon.style.fill = 'var(--color-primary)';
        heartIcon.style.color = 'var(--color-primary)';
        favBtn.style.borderColor = 'var(--color-primary)';
        // Nota: O fallback acima √© a cor padr√£o, mas o navegador usar√° a vari√°vel do tema.
    } else {
        // Volta ao estado neutro
        heartIcon.style.fill = 'none';
        heartIcon.style.color = '#334155'; // Slate 700
        favBtn.style.borderColor = '#e2e8f0'; // Slate 200
        favBtn.style.backgroundColor = '#ffffff';
    }
};

        

        window.modQty=(u,d)=>{const i=cart.find(x=>x.uid===u);if(i){i.q+=d;if(i.q<=0)cart=cart.filter(x=>x.uid!==u);updateCartUI();}};

        // FUN√á√ÉO PARA BLOQUEIO DE ESTOQUE ESGOTADO
window.alertaEstoquePreso = (nomeItem) => {
    Swal.fire({
        title: 'Item em Processamento',
        html: `Ops! O item <b>${nomeItem}</b> acabou de ser reservado por outro cliente.<br><br>Se a compra dele n√£o for conclu√≠da, o produto voltar√° a ficar dispon√≠vel.`,
        icon: 'info',
        confirmButtonText: 'ENTENDIDO, ATUALIZAR LOJA',
        confirmButtonColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#000000',
        allowOutsideClick: false,
        customClass: {
            container: 'z-[10000]',
            popup: 'rounded-[2rem]',
            confirmButton: 'rounded-xl px-10 py-4 font-bold text-xs uppercase tracking-widest'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.removeItem(`app_cache_v4_${STORE_ID}`);
            // Adicionamos um "timestamp" no final da URL para for√ßar o navegador a baixar tudo novo
            const urlLimpa = window.location.origin + window.location.pathname + '?t=' + Date.now();
            window.location.href = urlLimpa;
        }
    });
};

            window.checkoutWhatsApp = async () => { 
    if(!cart.length) return; 

    // 1. Captura e Valida√ß√£o de Identidade
    const nome = document.getElementById('checkName').value.trim();
    const telefone = document.getElementById('checkPhone') ? document.getElementById('checkPhone').value.trim() : "";
    const pagamento = document.getElementById('checkPayment').value;
    const trocoPara = document.getElementById('checkChange').value;
    const deliverySelect = document.getElementById('cartDeliverySelect');
    const isRetirada = deliverySelect.value === "0";
    
    if(!nome || !pagamento || !telefone || telefone.length < 10) {
        showToast("‚ö†Ô∏è Preencha nome, WhatsApp e pagamento.");
        return;
    }

    // 2. Valida√ß√£o de Endere√ßo
    let enderecoCompleto = "Retirada na Loja";
    let dadosEndereco = {};
    
    if(!isRetirada) {
        const rua = document.getElementById('checkStreet').value.trim();
        const numero = document.getElementById('checkNumber').value.trim();
        const bairro = document.getElementById('checkNeighborhood').value.trim();
        const ref = document.getElementById('checkReference').value.trim();
        
        if(!rua || !numero || !bairro) {
            showToast("‚ö†Ô∏è Preencha o endere√ßo completo para entrega.");
            return;
        }
        enderecoCompleto = `${rua}, ${numero} - ${bairro}${ref ? ' ('+ref+')' : ''}`;
        dadosEndereco = { street: rua, number: numero, neighborhood: bairro, reference: ref };
    }

    // 3. Feedback visual (Spinner e desabilitar bot√£o)
    const btn = document.querySelector('button[onclick="checkoutWhatsApp()"]');
    const oldBtnContent = btn.innerHTML;
    btn.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white/20 border-t-white rounded-full mr-2"></span> Validando estoque...`;
    btn.disabled = true;

    try {
        // --- NOVO: VALIDA√á√ÉO DE ESTOQUE REAL (PAINEL - RESERVAS FANTASMAS) ---
        for (const item of cart) {
            const productRef = doc(db, `stores/${STORE_ID}/products/${item.id}`);
            const pSnap = await getDocFromServer(productRef);
            
            if (pSnap.exists()) {
                const pData = pSnap.data();
                let estoquePainel = parseInt(pData.stock) || 0;

                // Ajusta estoque se for varia√ß√£o
                if (item.v.size || item.v.color) {
                    const v = pData.variations?.find(v => 
                        (v.size || "").trim().toLowerCase() === (item.v.size || "").trim().toLowerCase() && 
                        (v.color || "").trim().toLowerCase() === (item.v.color || "").trim().toLowerCase()
                    );
                    if (v) estoquePainel = parseInt(v.stock) || 0;
                }

                                // BUSCA RESERVAS PENDENTES NO BANCO (Estoque Fantasma)
                const resRef = collection(db, `stores/${STORE_ID}/stock_reserves`);
                const q = query(resRef, where("productId", "==", item.id), where("status", "==", "pending"));
                const resSnap = await getDocsFromServer(q);

                let totalReservado = 0;
                resSnap.forEach(rdoc => {
                    const r = rdoc.data();
                    
                    // --- COMPARA√á√ÉO BLINDADA ---
                    // Comparamos transformando tudo em string e tratando null/undefined como vazio
                    const rSize = (r.variation?.size || "").toString().toLowerCase().trim();
                    const rColor = (r.variation?.color || "").toString().toLowerCase().trim();
                    
                    const itemSize = (item.v?.size || "").toString().toLowerCase().trim();
                    const itemColor = (item.v?.color || "").toString().toLowerCase().trim();

                    // Se os tamanhos e cores batem (mesmo que ambos sejam vazios/null), somamos a reserva
                    if (rSize === itemSize && rColor === itemColor) {
                        totalReservado += (parseInt(r.qty) || 0);
                    }
                });

                
                const estoqueDisponivelReal = estoquePainel - totalReservado;

if (estoqueDisponivelReal < item.q) {
    // 1. Volta o bot√£o de finalizar ao estado normal (tira o loading)
    if (btn) {
        btn.innerHTML = oldBtnContent;
        btn.disabled = false;
    }
    
    // 2. CHAMA O ALERTA QUE VOC√ä COLOU NO PASSO 2
    window.alertaEstoquePreso(item.name);
    
    // 3. PARA TUDO (n√£o envia para o WhatsApp)
    return; 
}
            }
        }

      // 4. C√ÅLCULOS FINANCEIROS (BLINDADOS)
        const subtotal = cart.reduce((total, item) => {
            const pOriginal = allProducts.find(x => x.id === item.id);
            if (!pOriginal) return total; // Evita erro se o produto sumir da lista
            
            const precoDinamico = getActivePrice(pOriginal, pagamento);
            return total + (precoDinamico * item.q);
        }, 0);

        const taxaEntrega = isRetirada ? 0 : (parseFloat(deliverySelect.value) || 0);
        const totalFinal = subtotal + taxaEntrega;

        let infoPagamento = pagamento;
        if(pagamento === 'Dinheiro' && trocoPara) {
            const valorTrocoDigitado = parseFloat(trocoPara);
            if(valorTrocoDigitado > totalFinal) {
                infoPagamento += ` (Troco para R$ ${valorTrocoDigitado.toFixed(2).replace('.',',')})`;
            }
        }

        // 5. REGISTRO DO PEDIDO (Firebase)
        const orderData = {
            customer: {
                name: nome,
                phone: telefone, 
                addressString: enderecoCompleto,
                addressDetails: isRetirada ? null : dadosEndereco
            },
            items: cart.map(item => {
                const pOrig = allProducts.find(x => x.id === item.id);
                const precoReal = getActivePrice(pOrig, pagamento);
                return {
                    id: item.id,
                    name: item.name,
                    sku: item.sku || "N/A", 
                    qty: item.q,
                    price: precoReal, 
                    variationDetails: {
                        color: item.v.color || null,
                        size: item.v.size || null,
                        image: item.img,
                        sku: item.sku || "N/A"
                    }
                };
            }),
            paymentMethod: infoPagamento,
            deliveryFee: taxaEntrega,
            total: totalFinal,
            status: 'pending_whatsapp', 
            createdAt: serverTimestamp(),
            platform: 'web_catalog',
            stockDeducted: false 
        };

        const docRef = await addDoc(collection(db, `stores/${STORE_ID}/orders`), orderData);
        const shortId = docRef.id.slice(-5).toUpperCase();

        // --- NOVO: CRIA√á√ÉO DA RESERVA FANTASMA (Shadow Stock) ---
        const reserveBatch = writeBatch(db);
        const sID = shortId.toUpperCase(); 

        cart.forEach(item => {
            const s = (item.v.size && item.v.size !== "null") ? item.v.size.toString().toLowerCase().replace(/\s/g,'') : "";
            const c = (item.v.color && item.v.color !== "null") ? item.v.color.toString().toLowerCase().replace(/\s/g,'') : "";
            
            const resId = `res_${sID}_${item.id}_${s}_${c}`;
            const resRef = doc(db, `stores/${STORE_ID}/stock_reserves`, resId);

            reserveBatch.set(resRef, {
                productId: item.id,
                qty: item.q,
                variation: {
                    size: item.v.size || null,
                    color: item.v.color || null
                },
                createdAt: serverTimestamp(),
                orderId: sID,
                status: 'pending'
            });
        });
        await reserveBatch.commit();

        // 6. Montagem da Mensagem para WhatsApp
let msg = `üõçÔ∏è *PEDIDO: #${shortId}*\n`;
msg += `---------------------------\n\n`;
msg += `üë§ *Cliente:* ${nome}\n`;

msg += `üì¶ *ITENS DO PEDIDO:*\n`;
cart.forEach(item => {
    const pOriginal = allProducts.find(x => x.id === item.id);
    const precoDin√¢mico = getActivePrice(pOriginal, pagamento);
    const vars = [item.v.size, item.v.color].filter(Boolean).join('/');
    
    msg += `‚Ä¢ ${item.q}x ${item.name} ${vars ? '('+vars+')' : ''}\n`;
    msg += `  Unit: R$ ${precoDin√¢mico.toFixed(2).replace('.',',')} | Sub: R$ ${(precoDin√¢mico * item.q).toFixed(2).replace('.',',')}\n`;
    if(pagamento === 'Cart√£o' && pOriginal.maxInstallments > 1) {
    msg += `  (Dispon√≠vel em at√© ${pOriginal.maxInstallments}x)\n`;
}
    msg += `  _Ref: ${item.sku}_\n`;
});

        msg += `\nüí∞ *VALORES:*\n`;
        msg += `Subtotal: R$ ${subtotal.toFixed(2).replace('.',',')}\n`;
        if(!isRetirada) msg += `Entrega: R$ ${taxaEntrega.toFixed(2).replace('.',',')}\n`;
        msg += `*Total: R$ ${totalFinal.toFixed(2).replace('.',',')}*\n\n`;

        msg += `üí≥ *PAGAMENTO:* ${infoPagamento}\n`;
        msg += `üìç *ENTREGA:* ${enderecoCompleto}\n\n`;
        msg += `---------------------------\n`;
        msg += `_Pedido gerado via Vitrine Online_`;

        const link = `https://wa.me/${lojaZapDestino}?text=${encodeURIComponent(msg)}`;

        // Limpa Filtros e Interface
        filters.search = ""; 
        if(document.getElementById('desktopSearch')) document.getElementById('desktopSearch').value = "";
        if(document.getElementById('mobileSearch')) document.getElementById('mobileSearch').value = "";

        updateCartUI();
        renderCatalog();

        if(typeof closeCartModal === 'function') closeCartModal();
        if(typeof closeCheckout === 'function') closeCheckout();

        // 7. Limpeza Final e Redirecionamento
        const CART_KEY = `cart_${STORE_ID}`;
        localStorage.removeItem(CART_KEY);
        cart = [];

        const CACHE_KEY = `app_cache_v4_${STORE_ID}`;
        localStorage.removeItem(CACHE_KEY);
        
        window.open(link, '_blank');

        setTimeout(() => {
            window.location.reload();
        }, 1000); 
        
    } catch (error) {
        console.error("Erro no checkout:", error);
        showToast("‚ùå Erro ao processar pedido.");
    } finally {
        btn.innerHTML = oldBtnContent;
        btn.disabled = false;
    }
};

        
window.closeConfirmFinal = () => {
    document.getElementById('modalConfirmFinal').classList.add('hidden');
    // Registro de m√©trica em segundo plano
    const todayId = new Date().toLocaleDateString('en-CA');
    setDoc(doc(db, "stores", STORE_ID, "analytics_history", todayId), { checkoutClicks: increment(1) }, { merge: true });
};
                                               
        function applyStoreConfig(d) {
    // 1. N√∫mero do WhatsApp para destino
    lojaZapDestino = (d.whatsappNumber || "").replace(/\D/g, "");
    
    // --- NOVO: Vincula o n√∫mero ao bot√£o do rodap√© ---
    const footerLink = document.getElementById('footerWaLink');
    if (footerLink && lojaZapDestino) {
        footerLink.href = `https://wa.me/${lojaZapDestino}`;
    }

    // 2. Cor Prim√°ria do Tema
    if(d.primaryColor) { 
        document.documentElement.style.setProperty('--color-primary', d.primaryColor); 
        document.documentElement.style.setProperty('--color-primary-dark', d.primaryColor); 
    }
    
    // 3. Identidade Visual (Aqui j√° aplicamos o ajuste do nome da Gata Attrevida)
    const storeNameElement = document.getElementById('storeNameDisplay');
    if (storeNameElement) {
        storeNameElement.textContent = d.storeName;
        // Ajuste de largura para nomes grandes
        storeNameElement.classList.replace('max-w-[140px]', 'max-w-[220px]');
    }

    document.getElementById('footerStoreName').textContent = d.storeName;
    document.getElementById('footerDescription').textContent = d.footerText || "Qualidade e confian√ßa.";
    
    if (d.logoUrl) { 
        document.getElementById('storeLogoImg').src = d.logoUrl; 
        document.getElementById('logoContainer').classList.remove('hidden'); 
    }
    
    // 4. Taxas e √Åreas de Entrega
    deliveryAreas = d.deliveryAreas || [];
    const deliveryList = document.getElementById('deliveryList');
    if (deliveryList) {
        deliveryList.innerHTML = deliveryAreas.map(a => `
            <div class="flex justify-between p-3 bg-slate-50 rounded-lg text-sm">
                <span class="font-medium">${a.name}</span>
                <span class="font-bold">R$ ${parseFloat(a.fee).toFixed(2).replace('.',',')}</span>
            </div>
        `).join('');
    }
    
    const deliverySelect = document.getElementById('cartDeliverySelect');
    if (deliverySelect) {
        deliverySelect.innerHTML = '<option value="0">Retirar na Loja</option>' + 
            deliveryAreas.map(a => `<option value="${a.fee}">${a.name} (R$ ${parseFloat(a.fee).toFixed(2).replace('.',',')})</option>`).join('');
    }
        }   

        
async function registerVisit() {
    // Bloqueia registros em IDs inv√°lidos ou t√©cnicos
    if (!STORE_ID || ['admin', 'index.html', 'undefined', ''].includes(STORE_ID)) return;

    // Prote√ß√£o b√°sica contra Bots
    try {
        if (typeof isBotLikely === 'function' && isBotLikely()) return;
    } catch(e) {}

    // Impede registro duplo na mesma sess√£o de navegador
    const sessionKey = `vst_${STORE_ID}`;
    if (sessionStorage.getItem(sessionKey)) return;
            
    try {
        const now = new Date();
        const todayId = now.toLocaleDateString('en-CA'); // Formato YYYY-MM-DD
        const hour = now.getHours();
        
        // Rastreio de Origem
        const ref = document.referrer.toLowerCase();
        let source = "Direto";
        if (ref.includes("instagram.com")) source = "Instagram";
        else if (ref.includes("facebook.com") || ref.includes("fb.me")) source = "Facebook";
        else if (ref.includes("google.com")) source = "Google";

        const batch = writeBatch(db);

        // Refer√™ncia para o Hist√≥rico Di√°rio (Gr√°ficos)
        const historyRef = doc(db, `stores/${STORE_ID}/analytics_history`, todayId);
        batch.set(historyRef, {
            visits: increment(1),
            date: serverTimestamp(),
            [`hours.${hour}`]: increment(1),
            [`sources.${source}`]: increment(1)
        }, { merge: true });

        // Refer√™ncia para o Global (Totalizador e Pasta Global)
        const globalRef = doc(db, `stores/${STORE_ID}/analytics`, "global");
        batch.set(globalRef, { 
            totalVisits: increment(1),
            lastUpdate: serverTimestamp()
        }, { merge: true });

        await batch.commit();
        sessionStorage.setItem(sessionKey, "1");
        console.log("üöÄ Analytics: Visita e documento global sincronizados.");

    } catch (err) {
        console.error("‚ùå Erro ao registrar no Firestore:", err.code);
    }
}


        // --- HELPER UI ---
        window.showToast = (msg) => {
            const t=document.createElement('div');
            t.className="bg-slate-900/90 text-white text-sm px-6 py-3 rounded-full shadow-2xl backdrop-blur-md flex items-center gap-3 toast-enter pointer-events-auto transform transition-all duration-300";
            t.innerHTML=`<i data-lucide="shopping-bag" class="w-4 h-4 text-green-400"></i><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            lucide.createIcons();
            requestAnimationFrame(()=>{t.classList.add('toast-enter-active');});
            setTimeout(()=>{t.classList.add('toast-exit-active');setTimeout(()=>t.remove(),300);},3000);
        };

        function hideLoader() { document.getElementById('initialLoader').style.opacity = '0'; setTimeout(() => { document.getElementById('initialLoader').classList.add('hidden'); document.getElementById('app').classList.remove('hidden', 'opacity-0'); }, 500); }
        function showFatalError(title, msg) { document.getElementById('errorScreen').classList.remove('hidden'); document.getElementById('errorTitle').textContent = title; document.getElementById('errorMsg').textContent = msg; hideLoader(); }

        window.closeModalDetails = () => {
    document.getElementById('modalDetails').classList.add('hidden');
    
    // Remove o ?id=... da barra de navega√ß√£o sem recarregar a p√°gina
    window.history.pushState({}, '', window.location.pathname);
};

       // --- FUN√á√ïES DE MODAL (CORRIGIDAS E GLOBAIS) ---

window.openFilterDrawer = () => {
    const modal = document.getElementById('filterModal');
    const drawer = document.getElementById('filterDrawer');
    if (modal && drawer) {
        modal.classList.remove('hidden');
        // Pequeno delay para a anima√ß√£o de deslizar funcionar
        setTimeout(() => drawer.classList.remove('translate-x-full'), 10);
    }
};

window.closeFilterDrawer = () => {
    const modal = document.getElementById('filterModal');
    const drawer = document.getElementById('filterDrawer');
    if (drawer) drawer.classList.add('translate-x-full');
    if (modal) setTimeout(() => modal.classList.add('hidden'), 300);
};

// Se o seu bot√£o de fechar dentro do filtro ainda usar "closeFilterModal", 
// aponte para a fun√ß√£o correta:
window.closeFilterModal = window.closeFilterDrawer;

        window.adjustDetailQty = (d) => {
    const p = allProducts.find(x => x.id === currentDetailId);
    if(!p) return;

    const maxStock = parseInt(p.stock) || 0;
    const novaQuantidade = currentDetailQty + d;

    if (novaQuantidade > maxStock) {
        showToast(`‚ö†Ô∏è Desculpe, temos apenas ${maxStock} unidades em estoque.`);
        return;
    }

    currentDetailQty = Math.max(1, novaQuantidade); 
    document.getElementById('detailQtyDisplay').textContent = currentDetailQty; 
};

        window.setDetailImage = (idx) => { currentDetailImageIndex = idx; updateDetailImageDisplay(); };
        window.updateDetailImageDisplay = () => {
    const img = document.getElementById('detailImg');
    const counter = document.getElementById('imageCounter');
    const thumbContainer = document.getElementById('detailThumbnails');
    
    if (!img || !thumbContainer) return;

    img.src = currentDetailImages[currentDetailImageIndex];
    if (counter) counter.textContent = `${currentDetailImageIndex + 1} / ${currentDetailImages.length}`;
    
    const thumbs = thumbContainer.children;
    Array.from(thumbs).forEach((t, i) => { 
        const isActive = i === currentDetailImageIndex;
        t.classList.toggle('thumb-active', isActive); 
        t.classList.toggle('thumb-inactive', !isActive); 
        
        // Centraliza a miniatura selecionada automaticamente
        if(isActive) {
            t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    });
};

        window.openImageZoom = () => {
    // 1. Pega a imagem atual do carrossel de detalhes
    const currentImg = currentDetailImages[currentDetailImageIndex];
    if(!currentImg || currentImg.includes('placehold')) return;
    
    const m = document.getElementById('modalImageZoom');
    const zoomedImg = document.getElementById('zoomedImg');
    
    // 2. Prepara a imagem e exibe o modal
    zoomedImg.src = currentImg;
    m.classList.remove('hidden');
    
    // Reset de escala para garantir que a imagem comece no tamanho original
    zoomedImg.style.transform = "scale(1)";
    zoomedImg.style.opacity = '1';
    
    setTimeout(() => { m.classList.remove('opacity-0'); }, 10);

    let startX = 0;

    // 3. L√≥gica de toque refinada
    m.ontouchstart = (e) => {
        // REGRA DE OURO: S√≥ inicia l√≥gica de passar foto se houver APENAS 1 DEDO na tela.
        // Se houver 2 dedos, o navegador entende que √© ZOOM e ignora o c√≥digo abaixo.
        if (e.touches.length === 1) {
            startX = e.touches[0].screenX;
        }
    };
    
    m.ontouchend = (e) => {
        // Se ainda houver dedos na tela (gesto de pin√ßa incompleto), n√£o troca a foto.
        if (e.touches.length > 0) return; 

        let endX = e.changedTouches[0].screenX;
        let diff = startX - endX;

        // Troca de foto se o arrasto for maior que 70 pixels
        if (Math.abs(diff) > 70) { 
            const dir = diff > 0 ? 1 : -1;
            if (currentDetailImages.length > 1) {
                zoomedImg.style.opacity = '0.3';
                setTimeout(() => {
                    currentDetailImageIndex = (currentDetailImageIndex + dir + currentDetailImages.length) % currentDetailImages.length;
                    zoomedImg.src = currentDetailImages[currentDetailImageIndex];
                    zoomedImg.style.opacity = '1';
                    updateDetailImageDisplay();
                }, 150);
            }
        }
    };

    // 4. Fecha o modal ao clicar em qualquer lugar que n√£o seja a imagem
    m.onclick = (e) => {
        if (e.target.id !== 'zoomedImg') closeImageZoom();
    };
};


window.closeImageZoom = () => {
    const m = document.getElementById('modalImageZoom');
    m.classList.add('opacity-0');
    document.getElementById('zoomedImg').classList.replace('scale-100','scale-95');
    
    // Limpa os eventos ao fechar
    m.ontouchstart = null;
    m.ontouchend = null;
    
    setTimeout(() => m.classList.add('hidden'), 300);
};

        window.quickAdd = (id) => { 
    const p = allProducts.find(x => x.id === id); 
    // Se tem varia√ß√£o, abre o modal (onde j√° cuidamos do estoque)
    if(p.sizes?.length || p.colors?.length) {
        openProductModal(id); 
    } else {
        // Se n√£o tem varia√ß√£o, tenta adicionar direto. 
        // Aqui ele VAI cair na addToCart que acabamos de blindar!
        addToCart(p, 1, {}); 
    }
};
    
        function renderHeroCarousel(banners) {
    const container = document.getElementById('heroGridContainer');
    const dotsContainer = document.getElementById('carouselDots');
    if (!container || !dotsContainer) return;
    
    container.innerHTML = '';
    dotsContainer.innerHTML = '';
    if (!banners?.length) return;

    banners.forEach((b, index) => {
        const div = document.createElement('div');
        div.className = `hero-card w-full flex-shrink-0 h-full rounded-3xl p-6 md:p-10 flex items-center relative overflow-hidden snap-center cursor-pointer text-white transition-all duration-500`;
        
        // --- L√ìGICA DE FILTRO INTELIGENTE (MULTI-LOJA) ---
        div.onclick = () => {
            // O seu painel salva no campo 'target' (conforme vi no handleBannerSubmit)
            const bannerRef = b.target || b.category; 

            if (bannerRef) {
                // Se for 'offers', limpamos o filtro para mostrar tudo ou apenas promo√ß√µes
                if (bannerRef === 'offers') {
                    filters.category = 'offers';
                } else {
                    // Tenta encontrar a categoria real na lista de categorias da loja
                    const categoriaEncontrada = categories.find(c => 
                        c.toLowerCase().trim() === bannerRef.toLowerCase().trim()
                    );
                    filters.category = categoriaEncontrada || bannerRef;
                }

                isFavoritesView = false;
                renderCategoryTabs();
                renderCatalog();

                // Scroll suave at√© os produtos
                const catContainer = document.getElementById('categoryContainer');
                if(catContainer) catContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        div.style.background = `linear-gradient(135deg, ${b.color1 || '#333'}, ${b.color2 || '#000'})`;
        div.innerHTML = `
            <div class="relative z-10 flex-1 flex flex-col justify-center items-start gap-1 h-full min-w-0">
                <span class="px-2 py-0.5 rounded-full bg-black/20 backdrop-blur-md border border-white/10 text-[7px] font-black uppercase tracking-widest mb-1">
                    ${b.tag || 'Destaque'}
                </span>
                <h3 class="font-display font-bold text-2xl md:text-4xl leading-tight uppercase tracking-tighter w-full break-words">
                    ${b.title}
                </h3>
                ${b.subtitle ? `<p class="opacity-90 text-xs md:text-sm font-medium leading-tight max-w-[90%] break-words line-clamp-2">${b.subtitle}</p>` : ''}
                <div class="mt-4 px-6 py-2 bg-white/10 border border-white/30 rounded-full text-[9px] font-black uppercase tracking-widest">Ver Agora</div>
            </div>
            ${b.imageUrl ? `
                <div class="animate-floating w-32 h-32 md:w-52 md:h-52 rounded-2xl overflow-hidden border-2 border-white/10 shrink-0 ml-4 shadow-[0_20px_50px_rgba(0,0,0,0.3)]">
                    <img src="${b.imageUrl}" class="w-full h-full object-cover scale-110">
                </div>` : ''}
        `;
        container.appendChild(div);

        const dot = document.createElement('div');
        dot.className = `h-1.5 transition-all duration-300 rounded-full ${index === 0 ? 'w-6 bg-white' : 'w-1.5 bg-white/40'}`;
        dotsContainer.appendChild(dot);
    });

    // L√≥gica de atualiza√ß√£o dos pontos (dots) ao rolar
    const updateDots = () => {
        const scrollIndex = Math.round(container.scrollLeft / (container.offsetWidth + 24));
        Array.from(dotsContainer.children).forEach((dot, i) => {
            if (i === scrollIndex) {
                dot.classList.add('w-6', 'bg-white');
                dot.classList.remove('w-1.5', 'bg-white/40');
            } else {
                dot.classList.remove('w-6', 'bg-white');
                dot.classList.add('w-1.5', 'bg-white/40');
            }
        });
    };
    container.onscroll = updateDots;

    // Auto-play do carrossel
    if (window.heroInterval) clearInterval(window.heroInterval);
    window.heroInterval = setInterval(() => {
        const gap = 24; 
        const step = container.offsetWidth + gap;
        const maxScroll = container.scrollWidth - container.offsetWidth;
        if (container.scrollLeft >= maxScroll - 20) {
            container.scrollTo({ left: 0, behavior: 'smooth' });
        } else {
            container.scrollBy({ left: step, behavior: 'smooth' });
        }
    }, 4000);
}

        function renderCategoryTabs() {
            const c = document.getElementById('categoryContainer'); c.innerHTML = '';
            const mk = (id, l, icon) => {
                const active = filters.category === id && !isFavoritesView;
                const b = document.createElement('button');
                b.className = `px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${active ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-primary'}`;
                b.innerHTML = icon ? `${icon} ${l}` : l;
                b.onclick = () => { isFavoritesView = false; filters.category = id; renderCategoryTabs(); renderCatalog(); };
                return b;
            };
            c.appendChild(mk('offers', 'Ofertas', '<i data-lucide="flame" class="w-3.5 h-3.5"></i>'));
            c.appendChild(mk(null, 'Tudo'));
            categories.forEach(cat => c.appendChild(mk(cat, cat)));
            lucide.createIcons();
        }

        function populateFilterOptions() {
    const sizeCounts = {}, colorCounts = {};
    const ss = new Set(), cc = new Set();

    allProducts.forEach(p => {
        // Normaliza e conta tamanhos
        if (p.sizes) {
            p.sizes.forEach(s => {
                // Remove espa√ßos e padroniza: " azul " -> "Azul"
                const val = s.trim().toLowerCase();
                const formatted = val.charAt(0).toUpperCase() + val.slice(1);
                
                if (val) {
                    ss.add(formatted);
                    sizeCounts[formatted] = (sizeCounts[formatted] || 0) + 1;
                }
            });
        }
        // Normaliza e conta cores
        if (p.colors) {
            p.colors.forEach(c => {
                const val = c.trim().toLowerCase();
                const formatted = val.charAt(0).toUpperCase() + val.slice(1);
                
                if (val) {
                    cc.add(formatted);
                    colorCounts[formatted] = (colorCounts[formatted] || 0) + 1;
                }
            });
        }
    });

    const renderChips = (set, container, type, counts) => {
        container.innerHTML = '';
        // Ordena alfabeticamente
        Array.from(set).sort().forEach(val => {
            const isSelected = filters[type].includes(val);
            const count = counts[val] || 0;
            const d = document.createElement('div');
            
            // Estilo visual do bot√£o com contador
            d.className = `px-3 py-2 border rounded-lg text-[11px] chip-common flex items-center justify-between gap-3 transition-all ${
                isSelected 
                ? 'border-primary bg-primary text-white font-bold shadow-md' 
                : 'border-slate-200 bg-white text-slate-600 hover:border-primary'
            }`;

            d.innerHTML = `
                <span>${val}</span>
                <span class="${isSelected ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-400'} px-1.5 py-0.5 rounded text-[9px]">
                    ${count}
                </span>
            `;

            d.onclick = () => {
                if(isSelected) filters[type] = filters[type].filter(x => x !== val);
                else filters[type].push(val);
                populateFilterOptions(); 
                renderCatalog();
                updateFilterBadge();
            };
            container.appendChild(d);
        });
    };

    renderChips(ss, document.getElementById('filterSizesContainer'), 'sizes', sizeCounts);
    renderChips(cc, document.getElementById('filterColorsContainer'), 'colors', colorCounts);
}


        function renderRelatedProducts(curr) {
            const s = document.getElementById('relatedProductsSection'), g = document.getElementById('relatedGrid'); g.innerHTML = ''; 
            const rel = allProducts.filter(p => p.category === curr.category && p.id !== curr.id).slice(0, 10); 
            if (!rel.length) { s.classList.add('hidden'); return; } 
            s.classList.remove('hidden');
            rel.forEach(p => {
                const pr = (p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value;
                g.innerHTML += `<div onclick="openProductModal('${p.id}')" class="min-w-[110px] w-28 bg-white border border-slate-100 rounded-lg overflow-hidden cursor-pointer shrink-0"><img src="${p.images?.[0] || 'https://placehold.co/200'}" class="w-full h-20 object-cover" loading="lazy"><div class="p-2"><h5 class="text-[10px] font-medium truncate">${p.name}</h5><span class="text-xs font-bold block mt-0.5">R$ ${pr.toFixed(2).replace('.', ',')}</span></div></div>`;
            });
        }

        function setupSwipes() {
    const el = document.getElementById('mainImageContainer');
    let startX = 0;
    let startY = 0;
    let startTime = 0;

    el.addEventListener('touchstart', (e) => {
        startX = e.changedTouches[0].screenX;
        startY = e.changedTouches[0].screenY;
        startTime = Date.now();
    }, { passive: true });

    el.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].screenX;
        const endY = e.changedTouches[0].screenY;
        const deltaTime = Date.now() - startTime;
        
        const diffX = startX - endX;
        const diffY = startY - endY;

        // Se o movimento foi pequeno e r√°pido, √© um CLIQUE
        if (Math.abs(diffX) < 10 && Math.abs(diffY) < 10 && deltaTime < 250) {
            window.openImageZoom();
            return;
        }

        // Se o movimento foi horizontal e longo, √© um SWIPE
        if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
            const direcao = diffX > 0 ? 1 : -1;
            if (currentDetailImages.length > 1) {
                currentDetailImageIndex = (currentDetailImageIndex + direcao + currentDetailImages.length) % currentDetailImages.length;
                updateDetailImageDisplay();
            }
        }
    }, { passive: true });
        }

        window.shareProduct = () => { 
    const p = allProducts.find(x => x.id === currentDetailId); 
    if(!p) return;

    const shareTitle = p.name;
    const shareText = `Olha o que encontrei na ${storeConfigGlobal.storeName || 'loja'}: ${p.name}`;
    const shareUrl = window.location.href; // Isso agora j√° pega a URL com o ?id=...

    if(navigator.share) {
        navigator.share({
            title: shareTitle,
            text: shareText,
            url: shareUrl
        }).catch(err => console.log('Erro ao compartilhar', err));
    } else {
        // Fallback para computadores ou navegadores antigos
        navigator.clipboard.writeText(`${shareText} ${shareUrl}`);
        showToast("Link copiado! Cole no WhatsApp.");
    }
};


        window.openDeliveryModal = () => document.getElementById('modalDelivery').classList.remove('hidden');

// --- CONTROLE DE ETAPAS DO CARRINHO (FINAL) ---
// --- CONTROLE DE ETAPAS DO CARRINHO ---
window.goToStep1 = () => {
    document.getElementById('step1')?.classList.remove('hidden');
    document.getElementById('step2')?.classList.add('hidden');
    document.getElementById('btnBackStep')?.classList.add('hidden');
    document.getElementById('cartTitle').textContent = "Minha Sacola";
};

window.goToStep2 = () => {
    if (cart.length === 0) {
        showToast("Sua sacola est√° vazia!");
        return;
    }
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    document.getElementById('btnBackStep').classList.remove('hidden');
    document.getElementById('cartTitle').textContent = "Dados de Entrega";
    
    // FOR√áA A VERIFICA√á√ÉO IMEDIATA
    // Usamos um pequeno delay (50ms) para garantir que o DOM terminou de carregar
    setTimeout(() => {
        window.toggleAddressFields();
    }, 50);

    if(window.lucide) lucide.createIcons();
};

// --- FUN√á√ïES DE MODAL ---
window.closeModalDetails = () => {
    document.getElementById('modalDetails').classList.add('hidden');
};

window.openCartModal = () => {
    window.goToStep1(); // Garante que sempre abre na lista de produtos
    document.getElementById('modalCart').classList.remove('hidden'); 
    setTimeout(() => document.getElementById('cartDrawer').classList.remove('translate-x-full'), 10); 
};

window.closeCartModal = () => { 
    document.getElementById('cartDrawer').classList.add('translate-x-full'); 
    setTimeout(() => document.getElementById('modalCart').classList.add('hidden'), 300); 
};

        // Fun√ß√£o para saber quanto estoque sobra de verdade AGORA
async function getRealStockAvailable(productId, variation = null) {
    try {
        const productRef = doc(db, `stores/${STORE_ID}/products/${productId}`);
        const pSnap = await getDocFromServer(productRef); // Busca oficial
        
        if (!pSnap.exists()) return 0;
        const pData = pSnap.data();
        
        let estoquePainel = parseInt(pData.stock) || 0;

        // Se for varia√ß√£o, pega o estoque espec√≠fico dela
        if (variation && (variation.size || variation.color)) {
            const v = pData.variations?.find(v => 
                (v.size || "").trim().toUpperCase() === (variation.size || "").trim().toUpperCase() && 
                (v.color || "").trim().toLowerCase() === (variation.color || "").trim().toLowerCase()
            );
            estoquePainel = v ? (parseInt(v.stock) || 0) : 0;
        }

        // Busca as Reservas Fantasmas no banco
        const resRef = collection(db, `stores/${STORE_ID}/stock_reserves`);
        const q = query(resRef, where("productId", "==", productId), where("status", "==", "pending"));
        const resSnap = await getDocsFromServer(q);

        let totalReservado = 0;
        resSnap.forEach(rdoc => {
            const r = rdoc.data();
            const isSameVar = (!variation.size || r.variation?.size === variation.size) && 
                              (!variation.color || r.variation?.color === variation.color);
            if (isSameVar) totalReservado += r.qty;
        });

        return estoquePainel - totalReservado;
    } catch (e) {
        return 0;
    }
}


// --- L√ìGICA DO CARRINHO ATUALIZADA ---
window.addToCart = async (p, q, v) => {
    // 1. FOR√áA O DOWNLOAD DOS DADOS REAIS DO PRODUTO (Ignora cache de disco)
    // Isso garante que se o lojista cancelou um pedido, o estoque apare√ßa liberado na hora
    let pAtualizado = p;
    try {
        const productRef = doc(db, `stores/${STORE_ID}/products/${p.id}`);
        const snapAtual = await getDocFromServer(productRef); 
        if (snapAtual.exists()) {
            pAtualizado = snapAtual.data();
            pAtualizado.id = p.id; // Mant√©m o ID original para consist√™ncia
        }
    } catch (e) {
        console.warn("Falha ao buscar estoque em tempo real, usando dados locais.", e);
    }

    const matrix = pAtualizado.variations || [];
    let stockPainel = parseInt(pAtualizado.stock) || 0;

    // --- 2. BUSCA RESERVAS FANTASMAS ATUAIS (Shadow Stock) ---
    let totalReservado = 0;
    try {
        const resRef = collection(db, `stores/${STORE_ID}/stock_reserves`);
        const qRes = query(resRef, where("productId", "==", p.id), where("status", "==", "pending"));
        const resSnap = await getDocsFromServer(qRes); 

        resSnap.forEach(rdoc => {
            const r = rdoc.data();
            // Verifica se a reserva no banco √© para a mesma varia√ß√£o
            const isSameVar = (!v.size || (r.variation?.size || "").trim().toLowerCase() === (v.size || "").trim().toLowerCase()) && 
                              (!v.color || (r.variation?.color || "").trim().toLowerCase() === (v.color || "").trim().toLowerCase());
            if (isSameVar) totalReservado += r.qty;
        });
    } catch (e) { 
        console.warn("Erro ao buscar reservas:", e); 
    }

    // --- 3. L√ìGICA DE PRE√áO COM DESCONTO (Atualizada com Diferen√ßa do Cart√£o) ---
const agora = Date.now();
const isPromoAtiva = pAtualizado.promoValue && pAtualizado.promoValue < pAtualizado.value && (!pAtualizado.promoUntil || pAtualizado.promoUntil > agora);
const fatorDesconto = isPromoAtiva ? (pAtualizado.promoValue / pAtualizado.value) : 1;

// Calculamos a diferen√ßa fixa do cart√£o configurada no produto
const precoPixBase = pAtualizado.priceCash || pAtualizado.value;
const precoCardBase = pAtualizado.priceCard || pAtualizado.value;
const diferencaCartao = precoCardBase - precoPixBase;

// Definimos o pre√ßo inicial (vers√£o Pix)
let price = isPromoAtiva ? pAtualizado.promoValue : precoPixBase; 
let skuFinal = pAtualizado.sku || 'N/A'; 

// Ajuste de estoque e pre√ßo se houver varia√ß√£o
let stockEspecifico = stockPainel;
if(matrix.length && (v.size || v.color)) {
    const comb = matrix.find(varItem => 
        (!pAtualizado.sizes?.length || (varItem.size || "").trim().toLowerCase() === (v.size || "").trim().toLowerCase()) &&
        (!pAtualizado.colors?.length || (varItem.color || "").trim().toLowerCase() === (v.color || "").trim().toLowerCase())
    );
    if (comb) {
        stockEspecifico = parseInt(comb.stock) || 0;
        // Se houver varia√ß√£o, o pre√ßo base vira o da varia√ß√£o
        // Aplicamos o fator de desconto se houver promo√ß√£o ativa
        price = isPromoAtiva ? (comb.price * fatorDesconto) : comb.price;
        skuFinal = comb.sku || skuFinal;
    }
}

    // --- 4. C√ÅLCULO FINAL DO ESTOQUE DISPON√çVEL ---
    const stockDisponivelReal = stockEspecifico - totalReservado;
    const uid = `${p.id}-${(v.size || '').trim()}-${(v.color || '').trim()}`;
    const naSacola = cart.find(x => x.uid === uid);
    const totalDesejado = (naSacola ? naSacola.q : 0) + q;

            // --- 5. TRAVA DE SEGURAN√áA UNIFICADA E BLINDADA ---
    if (totalDesejado > stockDisponivelReal) {
        // Removemos o showToast daqui para garantir que nunca mais apare√ßa
        if (window.alertaEstoquePreso) {
            window.alertaEstoquePreso(pAtualizado.name);
        } else {
            // Caso a fun√ß√£o global falhe, usamos um fallback limpo
            Swal.fire({
                title: 'Indispon√≠vel',
                text: `O item ${pAtualizado.name} est√° reservado ou sem estoque.`,
                icon: 'info',
                confirmButtonText: 'OK'
            }).then(() => window.location.reload());
        }
        return;
    }


    // --- 6. ADI√á√ÉO √Ä SACOLA (Original preservada) ---
    const CART_KEY = `cart_${STORE_ID}`;
    const imagemFinal = v.image || (pAtualizado.images && pAtualizado.images[0]) || 'https://placehold.co/100';

    if(naSacola) {
        naSacola.q += q; 
        naSacola.sku = skuFinal;
        naSacola.img = imagemFinal;
        naSacola.price = price; 
    } else {
        cart.push({
            uid, 
            id: p.id, 
            sku: skuFinal,
            name: pAtualizado.name, 
            price: price, 
            q, 
            img: imagemFinal, 
            variationDetails: { 
                size: v.size || null,
                color: v.color || null,
                image: imagemFinal,
                sku: skuFinal
            },
            v: {...v}
        }); 
    }

    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartUI(); 
    showToast(`<b>${pAtualizado.name}</b> na sacola!`); 
    if(window.closeModalDetails) window.closeModalDetails(); 
};

// 1. FUN√á√ÉO DE C√ÅLCULO UNIFICADA
window.updateCartTotals = () => { 
    const method = document.getElementById('checkPayment')?.value || "";
    const deliveryFee = parseFloat(document.getElementById('cartDeliverySelect')?.value) || 0; 
    
    let subtotalCalculado = 0;

    cart.forEach(item => {
        const pOriginal = allProducts.find(x => x.id === item.id);
        if (pOriginal) {
            // Recalcula o pre√ßo em tempo real com base no pagamento
            const precoCerto = getActivePrice(pOriginal, method);
            const valorLinha = precoCerto * item.q;
            subtotalCalculado += valorLinha;

            // Atualiza o pre√ßo individual na linha do carrinho
            const priceEl = document.getElementById(`cart-item-price-${item.uid}`);
            if(priceEl) {
                priceEl.textContent = `R$ ${valorLinha.toFixed(2).replace('.', ',')}`;
            }
        }
    });

    // Atualiza os displays de Subtotal (aqueles que t√™m a classe .subtotal-display)
    document.querySelectorAll('.subtotal-display').forEach(d => {
        d.textContent = `R$ ${subtotalCalculado.toFixed(2).replace('.', ',')}`;
    });
    
    // Atualiza o Total Final (Subtotal + Entrega)
    const totalDisplay = document.getElementById('cartFinalTotal');
    if(totalDisplay) {
        totalDisplay.textContent = `R$ ${(subtotalCalculado + deliveryFee).toFixed(2).replace('.', ',')}`; 
    }
};

// 2. FUN√á√ÉO DE RENDERIZA√á√ÉO DA SACOLA
window.updateCartUI = () => {
    const cnt = cart.reduce((a, b) => a + b.q, 0); 
    const b = document.getElementById('cartBadge'); 
    if(b) {
        b.textContent = cnt; 
        b.classList.toggle('scale-0', cnt === 0);
    }

    const l = document.getElementById('cartList');
    const empty = document.getElementById('cartEmptyMsg');
    const step1Footer = document.getElementById('footerStep1');
    const currentMethod = document.getElementById('checkPayment')?.value || "";

    if(!cart.length) { 
        if(l) l.innerHTML = ''; 
        if(empty) empty.classList.remove('hidden'); 
        if(step1Footer) step1Footer.classList.add('hidden');
    } else {
        if(empty) empty.classList.add('hidden'); 
        if(step1Footer) step1Footer.classList.remove('hidden');

        l.innerHTML = cart.map(i => {
            const pOriginal = allProducts.find(x => x.id === i.id);
            const precoDinamico = getActivePrice(pOriginal, currentMethod);
            
            return `
            <div class="flex gap-3 bg-white p-3 rounded-xl border border-slate-200">
                <img src="${i.img}" class="w-16 h-16 rounded-lg object-cover bg-slate-50">
                <div class="flex-1">
                    <div class="flex justify-between font-bold text-xs text-slate-800">
                        <span class="truncate pr-2">${i.name}</span>
                        <span class="shrink-0" id="cart-item-price-${i.uid}">
                            R$ ${(precoDinamico * i.q).toFixed(2).replace('.', ',')}
                        </span>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 uppercase italic">
                        ${[i.v.size, i.v.color].filter(Boolean).join(' / ')}
                    </div>
                    <div class="flex items-center gap-4 mt-2">
                        <div class="flex items-center bg-slate-100 rounded h-7 border border-slate-200">
                            <button onclick="modQty('${i.uid}', -1)" class="w-7 h-full flex items-center justify-center text-slate-500 font-bold">-</button>
                            <span class="w-8 text-center text-xs font-black text-slate-700">${i.q}</span>
                            <button onclick="modQty('${i.uid}', 1)" class="w-7 h-full flex items-center justify-center text-slate-500 font-bold">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }
    window.updateCartTotals(); // Chama o c√°lculo logo ap√≥s desenhar a tela
};


window.modQty = (u, d) => {
    const item = cart.find(x => x.uid === u);
    if (!item) return;

    // Se a inten√ß√£o for aumentar a quantidade
    if (d > 0) {
        const produtoOriginal = allProducts.find(p => p.id === item.id);
        if (!produtoOriginal) return;

        let estoqueDisponivel = parseInt(produtoOriginal.stock) || 0;

        // Se o produto tiver varia√ß√µes, precisamos checar o estoque da varia√ß√£o espec√≠fica
        if (produtoOriginal.variations && produtoOriginal.variations.length > 0) {
            const variacao = produtoOriginal.variations.find(v => 
                v.size === item.v.size && v.color === item.v.color
            );
            if (variacao) {
                estoqueDisponivel = parseInt(variacao.stock) || 0;
            }
        }

        // Verifica se o aumento ultrapassa o estoque
        if (item.q + d > estoqueDisponivel) {
            showToast(`‚ö†Ô∏è Limite atingido! Temos apenas ${estoqueDisponivel} unidades em estoque.`);
            return; // Interrompe a fun√ß√£o aqui
        }
    }

    // Se passou na verifica√ß√£o (ou se for diminui√ß√£o), atualiza a quantidade
    item.q += d;

    // Se a quantidade chegar a 0 ou menos, remove do carrinho
    if (item.q <= 0) {
        cart = cart.filter(x => x.uid !== u);
    }

    // Salva e atualiza a interface
    const CART_KEY = `cart_${STORE_ID}`;
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartUI();
};

   window.toggleAddressFields = () => {
    const deliverySelect = document.getElementById('cartDeliverySelect');
    const addressFields = document.getElementById('addressFields');
    
    if (!deliverySelect || !addressFields) return;

    // "0" √© o valor padr√£o da op√ß√£o "Retirar na Loja"
    if (deliverySelect.value === "0" || deliverySelect.value === "") {
        addressFields.classList.add('hidden');
    } else {
        addressFields.classList.remove('hidden');
    }
    
    // Atualiza os pre√ßos (taxa de entrega)
    if (typeof updateCartTotals === "function") {
        updateCartTotals();
    }
};

        // Fun√ß√£o para gerar o HTML de cada se√ß√£o m√°gica
function generateMagicSection(title, products, colorClass) {
    if (products.length === 0) return '';
    return `
        <section class="animate-fade-in mb-8 px-4">
            <h3 class="font-bold text-slate-800 mb-4 text-lg flex items-center gap-2">
                <div class="w-1.5 h-6 ${colorClass} rounded-full"></div> ${title}
            </h3>
            <div class="flex overflow-x-auto gap-4 pb-4 hide-scroll snap-x snap-mandatory -mx-4 px-4">
                ${products.map(p => `
                    <div class="min-w-[155px] md:min-w-[205px] snap-start">
                        ${mkProductCard(p)}
                    </div>
                `).join('')}
            </div>
        </section>
    `;
        }
                              

// Fun√ß√£o que processa e exibe as se√ß√µes m√°gicas (Novidades/Vistos)
async function renderMagicCategories(products, config) {
    const magicContainer = document.getElementById('magicSections');
    if (!magicContainer) return;
    
    // L√ìGICA DE OCULTAR: 
    // Se houver busca OU categoria selecionada OU favoritos OU filtros de pre√ßo/tamanho/cor ativos
    const hasActiveFilters = 
        filters.search.length > 0 || 
        filters.category !== null || 
        isFavoritesView || 
        filters.maxPrice !== null || 
        filters.sizes.length > 0 || 
        filters.colors.length > 0;

    if (hasActiveFilters) {
        magicContainer.innerHTML = '';
        magicContainer.classList.add('hidden');
        return;
    }

    // Se n√£o houver filtros, renderiza as se√ß√µes
    magicContainer.classList.remove('hidden');
    magicContainer.innerHTML = '';

        // 1. NOVIDADES ‚ú®
if (config.magicCategories?.showNew) {
    const news = [...products]
        .filter(p => p.status === 'active')
        .sort((a, b) => {
            const getTime = (p) => {
                // 1. Verifica se j√° √© um N√∫mero (O Painel salva assim com Date.now())
                if (typeof p.createdAt === 'number') return p.createdAt;
                
                // 2. Verifica formatos do Firebase (Timestamp)
                if (p.createdAt?.toMillis) return p.createdAt.toMillis();
                if (p.createdAt?.seconds) return p.createdAt.seconds * 1000;
                
                // 3. Verifica se √© um objeto Date
                if (p.createdAt instanceof Date) return p.createdAt.getTime();
                
                // 4. Fallback final
                return p.lastUpdate || 0;
            };

            return getTime(b) - getTime(a); // Do mais novo para o mais velho
        })
        .slice(0, 15); // Aumentei para 15 para dar mais volume ao carrossel

    if (news.length > 0) {
        magicContainer.innerHTML += generateMagicSection("Novidades ‚ú®", news, "bg-purple-600");
    }
}

        // 2. MAIS VISTOS üî•
    if (config.magicCategories?.showTop) {
        try {
            const analyticsRef = doc(db, `stores/${STORE_ID}/analytics`, "product_views");
            
            // MUDAN√áA AQUI: Trocamos getDoc por getDocFromServer
            const snap = await getDocFromServer(analyticsRef).catch(() => null);
            
            if (snap && snap.exists()) {
                const stats = snap.data().stats || {};
                const top = [...products]
                    .filter(p => stats[p.id] && stats[p.id].views > 0)
                    .sort((a, b) => (stats[b.id]?.views || 0) - (stats[a.id]?.views || 0))
                    .slice(0, 10);
                
                // S√≥ adiciona ao HTML se encontrar produtos com visualiza√ß√µes
                if (top.length > 0) {
                    magicContainer.innerHTML += generateMagicSection("Mais Vistos üî•", top, "bg-orange-500");
                }
            }
        } catch (e) { 
            console.warn("Analytics ainda n√£o dispon√≠vel ou sem dados de cliques."); 
        }
    }

    
    if (window.lucide) lucide.createIcons();
}

        window.updateFilterBadge = () => {
    let count = 0;

    // Conta se o pre√ßo m√°ximo foi definido
    if (filters.maxPrice !== null && filters.maxPrice !== "") count++;
    
    // Soma a quantidade de tamanhos selecionados
    count += filters.sizes.length;
    
    // Soma a quantidade de cores selecionadas
    count += filters.colors.length;

    // Atualiza os elementos visualmente
    const badges = [document.getElementById('filterBadgeDesktop'), document.getElementById('filterBadgeMobile')];
    
    badges.forEach(badge => {
        if (badge) {
            badge.textContent = count;
            // Se count > 0, mostra o badge (scale-100), se n√£o, esconde (scale-0)
            badge.classList.toggle('scale-100', count > 0);
            badge.classList.toggle('scale-0', count === 0);
        }
    });
};
// Monitora a sele√ß√£o de pagamento para mostrar o campo de troco
document.addEventListener('change', (e) => {
    if(e.target.id === 'checkPayment') {
        const method = e.target.value;
        const changeField = document.getElementById('changeField');
        const installmentsField = document.getElementById('cardInstallmentsField'); // A div azul
        const installmentsSelect = document.getElementById('checkInstallments');   // O select dentro dela
        
        // 1. L√≥gica para DINHEIRO (Troco)
        if(method === 'Dinheiro') {
            changeField.classList.remove('hidden');
        } else {
            changeField.classList.add('hidden');
            const inputChange = document.getElementById('checkChange');
            if(inputChange) inputChange.value = ''; 
        }

        // 2. L√≥gica para CART√ÉO (Parcelas Din√¢micas)
        if(method === 'Cart√£o') {
            installmentsField.classList.remove('hidden');
            
            // Descobre o maior parcelamento permitido entre os produtos que est√£o no carrinho
            const maxAllowed = cart.reduce((max, item) => {
                const pOrig = allProducts.find(x => x.id === item.id);
                // Usa o maxInstallments salvo no produto ou padr√£o 1
                return Math.max(max, (pOrig?.maxInstallments || 1));
            }, 1);

            // Preenche o select de 1x at√© o limite permitido (m√°ximo 6x)
            let options = '';
            for(let i = 1; i <= maxAllowed; i++) {
                options += `<option value="${i}">${i}x no Cart√£o</option>`;
            }
            installmentsSelect.innerHTML = options;
        } else {
            // Se n√£o for cart√£o, esconde o campo
            if(installmentsField) installmentsField.classList.add('hidden');
        }

        // --- A M√ÅGICA ACONTECE AQUI ---
        window.updateCartTotals();

        // Feedback visual
        const totalEl = document.getElementById('cartFinalTotal');
        if(totalEl) {
            totalEl.classList.add('animate-bounce-short', 'text-green-600');
            setTimeout(() => totalEl.classList.remove('animate-bounce-short', 'text-green-600'), 500);
        }
    }
});

        function renderThumbnails() {
    const thumbContainer = document.getElementById('detailThumbnails');
    if (!thumbContainer) return;

    thumbContainer.innerHTML = '';
    currentDetailImages.forEach((url, idx) => {
        const img = document.createElement('img');
        img.src = url;
        // Miniaturas consistentes em 44px
        img.className = "min-w-[44px] w-11 h-11 rounded-lg border-2 object-cover cursor-pointer transition-all snap-center thumb-inactive shrink-0";
        img.onclick = () => setDetailImage(idx);
        thumbContainer.appendChild(img);
    });
        }

function trackProductView(productId, productName = "") {
    if (typeof isBotLikely === 'function' && isBotLikely()) return;
    productViewBuffer.add(productId);
    // Se o nome foi passado, podemos salvar no buffer tamb√©m
    startAnalyticsTimer();
}

function updateModalHeartBtn() { 
    const btn = document.querySelector('#modalHeartBtn i');
    if(btn) btn.classList.toggle('heart-active', favorites.includes(currentDetailId));
}

// Resolve o erro do bot√£o de cora√ß√£o no modal
window.toggleFavoriteCurrentDetail = () => {
    if (currentDetailId) {
        window.toggleFavorite(currentDetailId);
        // Atualiza o visual do cora√ß√£o no modal imediatamente
        updateModalHeartBtn();
    }
};
// Esta fun√ß√£o deve rodar ap√≥s os produtos serem baixados do Firestore
function checkDeepLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (productId && allProducts.length > 0) {
        const product = allProducts.find(p => p.id === productId);
        if (product) {
            // Aguarda 300ms para o layout do site estabilizar no celular
            setTimeout(() => {
                console.log("Abrindo produto via link direto:", product.name);
                window.openProductModal(product.id);
                
                // For√ßa o scroll do modal para o topo ao abrir via link
                const modalBody = document.querySelector('#modalDetails .overflow-y-auto');
                if(modalBody) modalBody.scrollTop = 0;
            }, 300);
        }
    }
}

 // --- L√ìGICA DO REL√ìGIO REGRESSIVO CORRIGIDA ---
function formatarTempo(ms) {
    const dias = Math.floor(ms / (1000 * 60 * 60 * 24));
    const horas = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutos = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
    const segundos = Math.floor((ms % (1000 * 60)) / 1000);

    if (dias > 0) return `Expira em: ${dias}d ${horas}h`;
    return `Oferta termina em: ${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
}

function initGlobalCountdowns() {
    if (window.timerInterval) clearInterval(window.timerInterval);

    window.timerInterval = setInterval(() => {
        const agora = Date.now();
        
        // 1. Atualiza Vitrine
        const allTimers = document.querySelectorAll('.product-timer');
        allTimers.forEach(timerEl => {
            const pid = timerEl.getAttribute('data-pid');
            const p = allProducts.find(x => x.id === pid);
            
            if (p && p.promoUntil) {
                const restante = p.promoUntil - agora;
                if (restante > 0) {
                    timerEl.classList.remove('hidden');
                    const span = timerEl.querySelector('.countdown-text');
                    if (span) span.innerText = formatarTempo(restante);
                } else {
                    timerEl.classList.add('hidden');
                }
            }
        });

        // 2. Atualiza Modal
        if (currentDetailId) {
            const pModal = allProducts.find(x => x.id === currentDetailId);
            const mTimer = document.getElementById('modalTimer');
            const mText = document.getElementById('modalTimerText');

            if (pModal && pModal.promoUntil && mTimer && mText) {
                const rest = pModal.promoUntil - agora;
                if (rest > 0) {
                    mTimer.classList.remove('hidden');
                    mText.innerText = formatarTempo(rest);
                } else {
                    mTimer.classList.add('hidden');
                }
            }
        }
    }, 1000);
}

    </script>
</body>
        </html>
