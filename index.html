<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando Loja...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { primary: 'var(--color-primary)', primaryDark: 'var(--color-primary-dark)' },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out', 
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'bounce-short': 'bounceShort 0.5s ease-in-out 1'
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        slideUp: { from: { opacity: 0, transform: 'translateY(20px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        bounceShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.2)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --color-primary: #EA1D2C; --color-primary-dark: #b91c29; }
        body { background-color: #F3F4F6; color: #334155; -webkit-font-smoothing: antialiased; }
        .glass-header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .chip-common { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; user-select: none; }
        .active-scale:active { transform: scale(0.95); }
        .hero-card { transition: transform 0.3s ease; }
        .hero-card:active { transform: scale(0.98); }
        .pattern-dots { background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px); background-size: 20px 20px; }
        
        .product-card { 
            background: white; 
            border-radius: 12px; 
            overflow: hidden; 
            transition: all 0.3s ease; 
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .product-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); 
            border-color: var(--color-primary);
        }

        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed bottom-6 left-0 right-0 z-[9999] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

    <div id="initialLoader" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-primary rounded-full animate-spin"></div>
    </div>

    <!-- STATUS BAR -->
    <div id="topStatusBar" class="bg-slate-900 text-white text-[10px] py-1.5 transition-colors duration-300">
        <div class="container mx-auto px-4 max-w-7xl flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="flex h-2 w-2 relative">
                    <span id="statusPing" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span id="statusDot" class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span id="storeStatusText" class="font-bold tracking-wide uppercase">Carregando...</span>
            </div>
            <div class="hidden md:block opacity-70">Horário de funcionamento na descrição</div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 glass-header transition-all duration-300">
        <div class="container mx-auto px-4 lg:px-8 max-w-7xl h-16 md:h-20 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2 cursor-pointer active-scale" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <h1 id="storeNameDisplay" class="font-display font-bold text-xl md:text-2xl text-slate-800 leading-none">ShopWave</h1>
            </div>

            <div class="flex-1 max-w-lg mx-4 hidden md:block">
                <div class="relative group">
                    <input type="text" oninput="handleSearchInput(this.value)" placeholder="O que você procura?" class="w-full bg-slate-100 border-none rounded-full py-2.5 pl-10 pr-4 text-sm focus:bg-white focus:ring-1 focus:ring-primary/50 transition-all border border-transparent focus:border-primary/20">
                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2 group-focus-within:text-primary"></i>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="openFilterDrawer()" class="p-2.5 rounded-full hover:bg-slate-50 relative active-scale bg-white border border-slate-200">
                    <i data-lucide="sliders-horizontal" class="w-5 h-5 text-slate-600"></i>
                    <span id="activeFiltersBadge" class="absolute -top-1 -right-1 bg-primary text-white text-[9px] font-bold h-4 w-4 rounded-full flex items-center justify-center hidden border-2 border-white"></span>
                </button>
                <button onclick="openCartModal()" class="flex items-center gap-2 p-2.5 rounded-full hover:bg-slate-50 active-scale group relative bg-white border border-slate-200" id="cartButtonHeader">
                    <i data-lucide="shopping-cart" class="w-5 h-5 text-slate-700 group-hover:text-primary transition-colors"></i>
                    <span id="cartBadge" class="absolute -top-1 -right-1 bg-primary text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
                </button>
            </div>
        </div>
        <!-- Mobile Search -->
        <div class="md:hidden px-4 pb-3">
            <div class="relative">
                <input type="text" oninput="handleSearchInput(this.value)" placeholder="Buscar produtos..." class="w-full bg-slate-100 border-none rounded-lg py-3 pl-10 pr-4 text-sm focus:ring-1 focus:ring-primary">
                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
            </div>
        </div>
    </header>

    <!-- MAIN APP -->
    <main id="app" class="flex-grow container mx-auto px-2 md:px-8 max-w-7xl pt-4 hidden opacity-0 transition-opacity duration-700">
        
        <!-- BANNERS -->
        <div id="heroGridContainer" class="flex overflow-x-auto snap-x snap-mandatory gap-3 mb-6 pb-2 hide-scroll -mx-2 px-2 md:mx-0 md:px-0">
            <div class="min-w-[85vw] md:min-w-[400px] h-36 md:h-48 rounded-2xl bg-slate-200 animate-pulse flex-shrink-0 snap-center"></div>
        </div>

        <!-- Categories -->
        <nav class="sticky top-[115px] md:top-[80px] z-30 mb-6 -mx-2 px-2 md:mx-0 md:px-0">
            <div id="categoryContainer" class="flex items-center gap-2 overflow-x-auto hide-scroll py-2"></div>
        </nav>

        <!-- CATALOGO -->
        <div id="catalogContainer" class="pb-20 space-y-10"></div>
        
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
            <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-slate-400"><i data-lucide="search-x" class="w-8 h-8"></i></div>
            <h3 class="font-bold text-slate-800">Nenhum produto encontrado</h3>
            <button onclick="resetAllFilters()" class="mt-4 text-primary text-sm font-bold">Limpar filtros</button>
        </div>
    </main>

    <!-- RODAPÉ -->
    <footer class="bg-white border-t border-slate-200 py-10">
        <div class="container mx-auto px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <h5 class="font-display font-bold text-xl text-slate-900 mb-1" id="footerStoreName">Loja</h5>
                <p id="footerDescription" class="text-slate-500 text-sm">Qualidade e confiança.</p>
            </div>
            <div class="flex gap-4 text-sm font-semibold text-slate-600">
                <button onclick="openDeliveryModal()" class="hover:text-primary flex items-center gap-1"><i data-lucide="truck" class="w-4 h-4"></i> Entrega</button>
                <a id="footerWaLink" href="#" target="_blank" class="hover:text-primary flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> Ajuda</a>
            </div>
        </div>
    </footer>

    <!-- MODAL: DETALHES -->
    <div id="modalDetails" class="fixed inset-0 z-[60] hidden flex items-end md:items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm pointer-events-auto" onclick="closeModalDetails()"></div>
        <div class="bg-white w-full max-w-2xl md:rounded-2xl rounded-t-2xl shadow-2xl pointer-events-auto relative flex flex-col max-h-[92vh] overflow-hidden animate-slide-up">
            <button onclick="closeModalDetails()" class="absolute top-4 right-4 z-10 bg-slate-100 hover:bg-slate-200 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-600"></i></button>
            <div class="h-64 md:h-80 bg-slate-50 flex-shrink-0 flex items-center justify-center p-4">
                <img id="detailImg" class="max-w-full max-h-full object-contain mix-blend-multiply">
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <span id="detailCat" class="text-[10px] font-extrabold text-primary uppercase tracking-widest mb-1 block"></span>
                <h2 id="detailName" class="font-display text-2xl md:text-3xl font-bold text-slate-900 mb-2 leading-tight"></h2>
                <p id="detailDesc" class="text-slate-500 text-sm leading-relaxed mb-6"></p>
                <div class="space-y-6">
                    <div id="sizesWrapper" class="hidden"><span class="text-xs font-bold text-slate-800 uppercase mb-3 block">Tamanho</span><div id="detailSizesContainer" class="flex flex-wrap gap-2"></div></div>
                    <div id="colorsWrapper" class="hidden"><span class="text-xs font-bold text-slate-800 uppercase mb-3 block">Cor</span><div id="detailColorsContainer" class="flex flex-wrap gap-2"></div></div>
                </div>
            </div>
            <div class="p-4 border-t flex items-center justify-between bg-white shadow-lg z-20">
                <div><span id="detailOldPrice" class="text-sm text-slate-400 line-through"></span><span id="detailPrice" class="text-3xl font-display font-black text-slate-900 block tracking-tight"></span></div>
                <div class="flex gap-3">
                    <div class="flex items-center bg-slate-100 rounded-xl px-2 h-12"><button onclick="adjustDetailQty(-1)" class="w-8 h-full font-bold text-lg text-slate-500">-</button><span id="detailQtyDisplay" class="font-bold w-6 text-center text-lg">1</span><button onclick="adjustDetailQty(1)" class="w-8 h-full font-bold text-lg text-slate-500">+</button></div>
                    <button id="detailAddBtn" class="bg-primary hover:bg-primaryDark text-white font-bold px-6 h-12 rounded-xl active-scale shadow-lg transition-all duration-200 text-sm md:text-base">Adicionar ao carrinho</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CARRINHO -->
    <div id="modalCart" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeCartModal()"></div>
        <div id="cartDrawer" class="absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="p-5 border-b flex justify-between items-center"><h3 class="font-bold text-lg">Minha Sacola</h3><button onclick="closeCartModal()"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div id="cartList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"></div>
            <div class="p-5 border-t bg-white space-y-4">
                <div id="cartEmptyMsg" class="hidden text-center text-slate-400 py-6">Vazio por enquanto...</div>
                <div id="cartSummary" class="space-y-2">
                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border text-sm"><span class="font-bold flex items-center gap-1"><i data-lucide="truck" class="w-4 h-4"></i> Entrega</span><select id="cartDeliverySelect" onchange="updateCartTotals()" class="bg-transparent font-bold outline-none text-right cursor-pointer"></select></div>
                    <div class="flex gap-2"><input id="cartCouponInput" placeholder="CUPOM" class="w-full border rounded-lg p-2.5 text-sm uppercase"><button onclick="applyCoupon()" class="bg-slate-800 text-white px-4 rounded-lg text-xs font-bold">OK</button></div>
                    <div id="cartCouponMsg" class="hidden text-xs font-bold text-center"></div>
                    <div class="flex justify-between text-lg font-bold text-slate-900 pt-3 border-t"><span>Total</span><span id="cartFinalTotal"></span></div>
                    <button onclick="checkoutWhatsApp()" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg mt-4 active-scale flex justify-center items-center gap-2">Finalizar Pedido <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: FILTROS (AUTOMÁTICOS) -->
    <div id="filterModal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeFilterDrawer()"></div>
        <div id="filterDrawer" class="absolute inset-y-0 right-0 max-w-xs w-full bg-white flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="font-bold">Filtrar Produtos</h3>
                <button onclick="closeFilterDrawer()"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-5 space-y-8 flex-1 overflow-y-auto">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Preço</label>
                    <div class="flex gap-2">
                        <input id="filterMinPrice" type="number" placeholder="Min" oninput="handlePriceInput()" class="w-full border rounded-lg p-2.5 text-sm">
                        <input id="filterMaxPrice" type="number" placeholder="Max" oninput="handlePriceInput()" class="w-full border rounded-lg p-2.5 text-sm">
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-slate-400 uppercase block">Tamanhos</label>
                        <span id="sizeBadge" class="hidden text-[10px] bg-primary text-white px-1.5 rounded-full">0</span>
                    </div>
                    <div id="filterSizesContainer" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-slate-400 uppercase block">Cores</label>
                        <span id="colorBadge" class="hidden text-[10px] bg-primary text-white px-1.5 rounded-full">0</span>
                    </div>
                    <div id="filterColorsContainer" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="p-5 border-t bg-slate-50 flex flex-col gap-2">
                 <button onclick="closeFilterDrawer()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg active-scale">Ver Resultados</button>
                 <button onclick="resetAllFilters()" class="w-full text-slate-500 font-bold py-2 text-sm">Limpar Filtros</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ENTREGA -->
    <div id="modalDelivery" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="document.getElementById('modalDelivery').classList.add('hidden')"></div>
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-lg mb-4 text-slate-900">Taxas de Entrega</h3>
            <div id="deliveryList" class="space-y-2 max-h-[50vh] overflow-y-auto custom-scrollbar mb-6"></div>
            <button onclick="document.getElementById('modalDelivery').classList.add('hidden')" class="w-full py-3 bg-slate-100 font-bold text-slate-600 rounded-xl">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const APP_ID = "1:730003067834:web:b205f1ea59053345960383";
        const FIREBASE_CONFIG = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.firebasestorage.app", messagingSenderId: "730003067834", appId: APP_ID };

        let db, allProducts=[], categories=[], cart=[], whatsappNumber="5511999999999", storeOpen=true;
        let activeCoupons=[], deliveryAreas=[], currentCoupon=null;
        let currentDetailId=null, currentDetailQty=1;
        let currentDetailSelection = { size: null, color: null };
        let filters = { search: "", category: null, minPrice: null, maxPrice: null, sizes: [], colors: [] };

        const CHIP_DEFAULT = "border-slate-200 bg-slate-50 text-slate-600 hover:bg-slate-100";
        const CHIP_SELECTED = "border-primary bg-primary text-white font-bold ring-2 ring-primary/20 shadow-md";

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(console.error);
            onAuthStateChanged(auth, () => {
                document.getElementById('initialLoader').style.opacity = '0';
                setTimeout(() => { document.getElementById('initialLoader').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); document.getElementById('app').classList.remove('opacity-0'); }, 500);
                setupDataListeners();
            });
        });

        function setupDataListeners() {
            onSnapshot(doc(db, `artifacts/${APP_ID}/public/data/config/store`), s => { if(s.exists()) applyStoreConfig(s.data()); });
            onSnapshot(collection(db, `artifacts/${APP_ID}/public/data/products`), s => {
                allProducts = s.docs.map(d => ({id: d.id, ...d.data()})).filter(p => p.status === 'active' && p.stock !== 0);
                const cs = new Set(allProducts.map(p => p.category).filter(Boolean));
                categories = Array.from(cs).sort();
                populateFilterOptions();
                renderCategoryTabs();
                renderCatalog();
            });
            onSnapshot(collection(db, `artifacts/${APP_ID}/public/data/hero_cards`), s => {
                const banners = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderHeroCarousel(banners);
            });
            onSnapshot(query(collection(db, `artifacts/${APP_ID}/public/data/coupons`), where("status", "==", "active")), s => { activeCoupons = s.docs.map(d => d.data()); });
        }

        // --- CARROSSEL HERO ---
        function renderHeroCarousel(banners) {
            const container = document.getElementById('heroGridContainer');
            container.innerHTML = '';
            if (!banners.length) { container.innerHTML = '<div class="min-w-full h-32 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400">Sem destaques</div>'; return; }
            banners.forEach(b => {
                const card = document.createElement('div');
                card.className = "hero-card min-w-[85vw] md:min-w-[420px] h-36 md:h-44 rounded-2xl p-6 flex flex-col justify-center relative overflow-hidden snap-center cursor-pointer flex-shrink-0 text-white shadow-sm";
                card.style.background = `linear-gradient(135deg, ${b.color1 || '#333'}, ${b.color2 || '#000'})`;
                card.onclick = () => selectCategory(b.target);
                card.innerHTML = `
                    <div class="absolute inset-0 pattern-dots opacity-20"></div>
                    <div class="relative z-10"><span class="inline-block py-1 px-3 rounded-full bg-white/20 backdrop-blur-md border border-white/20 text-[10px] font-bold uppercase tracking-wider mb-2">${b.tag || 'Destaque'}</span><h3 class="font-display font-bold text-xl md:text-2xl leading-tight w-2/3">${b.title || 'Novidade'}</h3></div>
                    <div class="absolute bottom-5 right-5 w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i data-lucide="arrow-right" class="w-4 h-4 text-white"></i></div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- CATALOGO ---
        function renderCategoryTabs() {
            const c = document.getElementById('categoryContainer'); c.innerHTML = '';
            const mk = (id, l, icon) => {
                const active = filters.category === id;
                const b = document.createElement('button');
                b.className = `px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border flex items-center gap-2 ${active ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-primary'}`;
                b.innerHTML = icon ? `${icon} ${l}` : l;
                b.onclick = () => { filters.category = id; renderCategoryTabs(); renderCatalog(); };
                return b;
            };
            c.appendChild(mk('offers', 'Ofertas', '<i data-lucide="flame" class="w-3.5 h-3.5"></i>'));
            c.appendChild(mk(null, 'Ver Tudo'));
            categories.forEach(cat => c.appendChild(mk(cat, cat)));
            lucide.createIcons();
        }

        window.renderCatalog = () => {
            const c = document.getElementById('catalogContainer'); const empty = document.getElementById('emptyState');
            let f = allProducts.filter(p => {
                if(filters.search && !p.name.toLowerCase().includes(filters.search)) return false;
                if(filters.category === 'offers') { if(!(p.promoValue && p.promoValue < p.value)) return false; }
                else if(filters.category && p.category !== filters.category) return false;
                const price = (p.promoValue && p.promoValue < p.value) ? p.promoValue : p.value;
                if(filters.minPrice && price < filters.minPrice) return false;
                if(filters.maxPrice && price > filters.maxPrice) return false;
                if(filters.sizes.length && !p.sizes?.some(s=>filters.sizes.includes(s))) return false;
                if(filters.colors.length && !p.colors?.some(co=>filters.colors.includes(co))) return false;
                return true;
            });

            if(!f.length) { c.innerHTML=''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden'); c.innerHTML='';

            let g = {};
            if(filters.search || (filters.category && filters.category !== 'offers') || filters.minPrice || filters.maxPrice || filters.sizes.length || filters.colors.length) g['Resultados'] = f;
            else f.forEach(p => { const k = p.category || 'Outros'; if(!g[k]) g[k]=[]; g[k].push(p); });

            Object.keys(g).sort().forEach(key => {
                const sec = document.createElement('section');
                sec.innerHTML = `<h3 class="font-bold text-slate-800 mb-4 px-1 text-lg flex items-center gap-2"><div class="w-1 h-5 bg-primary rounded-full"></div> ${key}</h3>`;
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-5";
                g[key].forEach(p => grid.innerHTML += mkProductCard(p));
                sec.appendChild(grid);
                c.appendChild(sec);
            });
            lucide.createIcons();
        }

        function mkProductCard(p) {
            const hasPromo = p.promoValue && p.promoValue < p.value;
            const price = hasPromo ? p.promoValue : p.value;
            const img = p.images?.[0] || 'https://placehold.co/300';
            
            let discountBadge = '';
            if (hasPromo) {
                const discount = Math.round(((p.value - p.promoValue) / p.value) * 100);
                discountBadge = `<span class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded-bl-lg z-10 shadow-sm">-${discount}%</span>`;
            }
            
            return `
            <div onclick="openProductModal('${p.id}')" class="product-card cursor-pointer group flex flex-col h-full animate-fade-in relative">
                <div class="aspect-square bg-white relative overflow-hidden border-b border-slate-50">
                    <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500 mix-blend-multiply">
                    ${discountBadge}
                </div>
                <div class="p-3 md:p-4 flex flex-col flex-grow bg-white">
                    <h4 class="text-sm font-semibold text-slate-700 leading-snug line-clamp-2 mb-2 group-hover:text-primary transition-colors">${p.name}</h4>
                    <div class="mt-auto pt-1">
                        ${hasPromo ? `<span class="text-[11px] text-slate-400 line-through block mb-0.5 font-medium">R$ ${p.value.toFixed(2).replace('.',',')}</span>` : '<span class="block h-4"></span>'}
                        <div class="flex items-center justify-between">
                            <span class="text-lg md:text-xl font-display font-black text-slate-900 tracking-tight">R$ ${price.toFixed(2).replace('.',',')}</span>
                            <button onclick="event.stopPropagation(); quickAdd('${p.id}')" class="w-8 h-8 rounded-full bg-primary/10 hover:bg-primary text-primary hover:text-white flex items-center justify-center transition-colors active-scale">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- FILTROS AUTOMÁTICOS ---
        window.populateFilterOptions = () => {
            const ss=new Set(), cc=new Set(); allProducts.forEach(p=>{ p.sizes?.forEach(s=>ss.add(s.trim())); p.colors?.forEach(c=>cc.add(c.trim())); });
            const sc=document.getElementById('filterSizesContainer'); sc.innerHTML=''; 
            ss.forEach(s=>{ const d=document.createElement('div'); d.className=`px-4 py-2 border rounded-lg text-xs chip-common ${filters.sizes.includes(s) ? CHIP_SELECTED : CHIP_DEFAULT}`; d.textContent=s; d.onclick=()=>toggleFilter('sizes',s,d); sc.appendChild(d); });
            const cco=document.getElementById('filterColorsContainer'); cco.innerHTML=''; 
            cc.forEach(c=>{ const d=document.createElement('div'); d.className=`px-4 py-2 border rounded-lg text-xs chip-common ${filters.colors.includes(c) ? CHIP_SELECTED : CHIP_DEFAULT}`; d.textContent=c; d.onclick=()=>toggleFilter('colors',c,d); cco.appendChild(d); });
            updateFilterBadges();
        };

        const toggleFilter = (t,v,e) => { 
            const idx=filters[t].indexOf(v); 
            if(idx>-1){ filters[t].splice(idx,1); e.className=`px-4 py-2 border rounded-lg text-xs chip-common ${CHIP_DEFAULT}`; }
            else{ filters[t].push(v); e.className=`px-4 py-2 border rounded-lg text-xs chip-common ${CHIP_SELECTED}`; }
            updateLiveFilters();
        };

        window.handlePriceInput = () => {
             filters.minPrice = parseFloat(document.getElementById('filterMinPrice').value) || null;
             filters.maxPrice = parseFloat(document.getElementById('filterMaxPrice').value) || null;
             updateLiveFilters();
        };

        function updateLiveFilters() {
            renderCatalog();
            updateFilterBadges();
            let count = filters.sizes.length + filters.colors.length + (filters.minPrice ? 1 : 0) + (filters.maxPrice ? 1 : 0);
            const b = document.getElementById('activeFiltersBadge');
            b.textContent = count;
            if(count > 0) b.classList.remove('hidden'); else b.classList.add('hidden');
        }

        function updateFilterBadges() {
            const sb = document.getElementById('sizeBadge'); const cb = document.getElementById('colorBadge');
            if(filters.sizes.length > 0) { sb.textContent = filters.sizes.length; sb.classList.remove('hidden'); } else { sb.classList.add('hidden'); }
            if(filters.colors.length > 0) { cb.textContent = filters.colors.length; cb.classList.remove('hidden'); } else { cb.classList.add('hidden'); }
        }

        window.resetAllFilters = () => { 
            filters={search:"",category:null,minPrice:null,maxPrice:null,sizes:[],colors:[]}; 
            document.querySelectorAll('input').forEach(i=>i.value=''); 
            populateFilterOptions(); 
            updateLiveFilters();
        };

        // --- DETALHES ---
        window.openProductModal = (id) => {
            const p=allProducts.find(x=>x.id===id); if(!p)return; 
            currentDetailId=id; currentDetailQty=1; currentDetailSelection={size:null,color:null};
            const promo=p.promoValue&&p.promoValue<p.value;
            document.getElementById('detailImg').src=p.images?.[0]||''; 
            document.getElementById('detailCat').textContent=p.category; 
            document.getElementById('detailName').textContent=p.name; 
            document.getElementById('detailDesc').textContent=p.description||'Sem descrição disponível.';
            document.getElementById('detailPrice').textContent=`R$ ${(promo?p.promoValue:p.value).toFixed(2).replace('.',',')}`; 
            document.getElementById('detailOldPrice').textContent=promo?`R$ ${p.value.toFixed(2).replace('.',',')}`:'';
            document.getElementById('detailQtyDisplay').textContent="1";
            
            // Texto do botão
            document.getElementById('detailAddBtn').textContent = "Adicionar ao carrinho";
            
            const renderChips = (list, type, container, wrapper) => { 
                container.innerHTML=''; if(!list?.length){ wrapper.classList.add('hidden'); return; } wrapper.classList.remove('hidden'); 
                list.forEach(item => { 
                    const d=document.createElement('div'); d.className=`px-4 py-2 border rounded-lg text-xs chip-common ${CHIP_DEFAULT}`; d.textContent=item; 
                    d.onclick = () => { Array.from(container.children).forEach(sib => sib.className = `px-4 py-2 border rounded-lg text-xs chip-common ${CHIP_DEFAULT}`); d.className = `px-4 py-2 border rounded-lg text-xs chip-common ${CHIP_SELECTED}`; currentDetailSelection[type] = item; }; 
                    container.appendChild(d); 
                }); 
            };
            renderChips(p.sizes, 'size', document.getElementById('detailSizesContainer'), document.getElementById('sizesWrapper'));
            renderChips(p.colors, 'color', document.getElementById('detailColorsContainer'), document.getElementById('colorsWrapper'));
            
            // Configurar o clique do botão com validação e fechamento
            const btn = document.getElementById('detailAddBtn');
            btn.onclick = function() {
                // Validação de variantes
                if(p.sizes && p.sizes.length && !currentDetailSelection.size) { showToast('Selecione um tamanho!'); return; }
                if(p.colors && p.colors.length && !currentDetailSelection.color) { showToast('Selecione uma cor!'); return; }
                
                // Adiciona e fecha
                addToCart(p, currentDetailQty, currentDetailSelection); 
                closeModalDetails();
            };
            
            document.getElementById('modalDetails').classList.remove('hidden');
        };

        // --- CARRINHO & TOAST ---
        window.addToCart = (p,q,v) => { 
            const price=(p.promoValue&&p.promoValue<p.value)?p.promoValue:p.value; 
            const uid=`${p.id}-${v.size||''}-${v.color||''}`; 
            const ex=cart.find(x=>x.uid===uid); 
            if(ex) ex.q+=q; else cart.push({uid,id:p.id,name:p.name,price,q,img:p.images?.[0],v}); 
            
            updateCartUI(); 
            showToast(`<b>${p.name}</b> adicionado à sacola!`);
        };

        function updateCartUI() {
            const cnt=cart.reduce((a,b)=>a+b.q,0); 
            document.getElementById('cartBadge').textContent=cnt; 
            document.getElementById('cartBadge').classList.toggle('scale-0',cnt===0);
            
            const cartBtn = document.getElementById('cartButtonHeader');
            cartBtn.classList.remove('animate-bounce-short');
            void cartBtn.offsetWidth; 
            cartBtn.classList.add('animate-bounce-short');

            const l=document.getElementById('cartList');
            if(!cart.length){ l.innerHTML=''; document.getElementById('cartEmptyMsg').classList.remove('hidden'); document.getElementById('cartSummary').classList.add('hidden'); }
            else {
                document.getElementById('cartEmptyMsg').classList.add('hidden'); document.getElementById('cartSummary').classList.remove('hidden');
                l.innerHTML=cart.map(i=>`<div class="flex gap-3 bg-white p-3 rounded-xl border border-slate-200"><img src="${i.img}" class="w-16 h-16 rounded-lg object-cover bg-slate-50"><div class="flex-1"><div class="flex justify-between font-bold text-xs"><span>${i.name}</span><span>R$ ${(i.price*i.q).toFixed(2).replace('.',',')}</span></div><div class="text-[10px] text-slate-400 mt-1">${[i.v.size,i.v.color].filter(Boolean).join(' • ')}</div><div class="flex items-center gap-4 mt-2"><div class="flex items-center bg-slate-100 rounded h-6"><button onclick="modQty('${i.uid}',-1)" class="w-6 text-slate-500">-</button><span class="w-6 text-center text-xs font-bold">${i.q}</span><button onclick="modQty('${i.uid}',1)" class="w-6 text-primary">+</button></div><button onclick="modQty('${i.uid}',-${i.q})" class="text-[10px] text-red-500 font-bold uppercase">Remover</button></div></div></div>`).join('');
            }
            updateCartTotals();
        }

        // --- HELPERS GERAIS ---
        window.modQty=(u,d)=>{ const i=cart.find(x=>x.uid===u); if(i){ i.q+=d; if(i.q<=0)cart=cart.filter(x=>x.uid!==u); updateCartUI(); } };
        window.handleSearchInput = (v) => { filters.search = v.toLowerCase(); updateLiveFilters(); }; 
        window.openFilterDrawer = () => { document.getElementById('filterModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('filterDrawer').classList.remove('translate-x-full'),10); };
        window.closeFilterDrawer = () => { document.getElementById('filterDrawer').classList.add('translate-x-full'); setTimeout(()=>document.getElementById('filterModal').classList.add('hidden'),300); };
        window.openCartModal = () => { document.getElementById('modalCart').classList.remove('hidden'); setTimeout(()=>document.getElementById('cartDrawer').classList.remove('translate-x-full'),10); };
        window.closeCartModal = () => { document.getElementById('cartDrawer').classList.add('translate-x-full'); setTimeout(()=>document.getElementById('modalCart').classList.add('hidden'),300); };
        window.closeModalDetails = () => document.getElementById('modalDetails').classList.add('hidden');
        window.adjustDetailQty = (d) => { currentDetailQty+=d; if(currentDetailQty<1)currentDetailQty=1; document.getElementById('detailQtyDisplay').textContent=currentDetailQty; };
        window.quickAdd = (id) => { const p=allProducts.find(x=>x.id===id); if(p.sizes?.length||p.colors?.length) openProductModal(id); else addToCart(p,1,{}); };
        window.selectCategory = (catId) => { filters.category = (catId === 'offers' || catId === 'Ofertas') ? 'offers' : catId; renderCategoryTabs(); renderCatalog(); const el = document.getElementById('catalogContainer'); if(el) { const offset = 140; const top = el.getBoundingClientRect().top + window.scrollY - offset; window.scrollTo({ top: top, behavior: 'smooth' }); } };
        window.openDeliveryModal = () => document.getElementById('modalDelivery').classList.remove('hidden');

        function applyStoreConfig(d) {
            whatsappNumber = (d.whatsappNumber||"").replace(/\D/g,"") || "5511999999999";
            if(d.primaryColor) { document.documentElement.style.setProperty('--color-primary', d.primaryColor); document.documentElement.style.setProperty('--color-primary-dark', d.primaryColor); }
            const name = d.storeName || "ShopWave";
            document.getElementById('storeNameDisplay').textContent = name;
            document.getElementById('footerStoreName').textContent = name; 
            document.getElementById('footerDescription').textContent = d.footerText || "Sua melhor opção.";
            document.getElementById('footerWaLink').href = `https://wa.me/${whatsappNumber}`;
            deliveryAreas = d.deliveryAreas || [];
            document.getElementById('deliveryList').innerHTML = deliveryAreas.map(a => `<div class="flex justify-between p-3 bg-slate-50 rounded-lg"><span class="text-sm font-medium">${a.name}</span><span class="text-sm font-bold">R$ ${parseFloat(a.fee).toFixed(2).replace('.',',')}</span></div>`).join('');
            document.getElementById('cartDeliverySelect').innerHTML='<option value="0">Retirar</option>' + deliveryAreas.map(a=>`<option value="${a.fee}">${a.name} (R$ ${parseFloat(a.fee).toFixed(2).replace('.',',')})</option>`).join('');

            storeOpen = checkStoreStatus(d.operatingHours, d.isStoreOpen);
            const stTxt = document.getElementById('storeStatusText');
            const stDot = document.getElementById('statusDot');
            const stPing = document.getElementById('statusPing');
            const topBar = document.getElementById('topStatusBar');
            if (storeOpen) { stTxt.textContent = "Loja Aberta Agora"; stDot.className = "relative inline-flex rounded-full h-2 w-2 bg-green-500"; stPing.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"; topBar.className = "bg-slate-900 text-white text-[10px] py-1.5 transition-colors duration-300"; } 
            else { stTxt.textContent = "Loja Fechada"; stDot.className = "relative inline-flex rounded-full h-2 w-2 bg-red-500"; stPing.className = "hidden"; topBar.className = "bg-red-900 text-white text-[10px] py-1.5 transition-colors duration-300"; }
        }

        function checkStoreStatus(h, m) { if (m === false) return false; if (!h) return true; const now = new Date(); const d = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday']; const t = h[d[now.getDay()]]; if (!t || !t.isActive) return false; const cur = now.getHours()*60 + now.getMinutes(); const [sh,sm] = t.startTime.split(':').map(Number); const [eh,em] = t.endTime.split(':').map(Number); const s = sh*60 + sm; const e = eh*60 + em; return s > e ? (cur >= s || cur < e) : (cur >= s && cur < e); }
        
        window.updateCartTotals = () => {
             const df = parseFloat(document.getElementById('cartDeliverySelect').value) || 0;
             let sub = cart.reduce((a,b)=>a+(b.price*b.q), 0);
             let disc = 0;
             if(currentCoupon) { if(currentCoupon.type === 'percentage') disc = sub * (currentCoupon.value/100); else disc = currentCoupon.value; if(disc > sub) disc = sub; }
             const tot = sub + df - disc;
             document.getElementById('cartFinalTotal').textContent = `R$ ${tot.toFixed(2).replace('.',',')}`;
             if(disc>0){ document.getElementById('cartDiscountRow').classList.remove('hidden'); document.getElementById('cartDiscountDisplay').textContent=`- R$ ${disc.toFixed(2).replace('.',',')}`; } else document.getElementById('cartDiscountRow').classList.add('hidden');
        }
        
        window.checkoutWhatsApp = () => {
             if(!cart.length) return;
             const m = document.getElementById('cartDeliverySelect'); const method = m.options[m.selectedIndex].text;
             let msg = `*PEDIDO - ${document.getElementById('storeNameDisplay').textContent}*\n--------------------------------\n`;
             cart.forEach(i => { msg += `${i.q}x ${i.name} ${[i.v.size, i.v.color].filter(Boolean).join('/') ? `(${[i.v.size, i.v.color].filter(Boolean).join('/')})` : ''}\n`; });
             msg += `--------------------------------\n*Entrega:* ${method}\n*Total:* ${document.getElementById('cartFinalTotal').textContent}`;
             window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        window.showToast = (msg) => { 
            const t = document.createElement('div'); 
            t.className = "bg-slate-900/90 text-white text-sm px-6 py-3 rounded-full shadow-2xl backdrop-blur-md flex items-center gap-3 toast-enter pointer-events-auto transform transition-all duration-300"; 
            t.innerHTML = `<i data-lucide="shopping-bag" class="w-4 h-4 text-green-400"></i> <span>${msg}</span>`; 
            
            const container = document.getElementById('toastContainer');
            container.appendChild(t); 
            lucide.createIcons(); 
            
            requestAnimationFrame(() => { t.classList.remove('toast-enter'); t.classList.add('toast-enter-active'); });
            setTimeout(() => { t.classList.remove('toast-enter-active'); t.classList.add('toast-exit-active'); setTimeout(() => t.remove(), 300); }, 3000); 
        }
    </script>
</body>
</html>

