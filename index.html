<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando Loja...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { primary: 'var(--color-primary)', primaryDark: 'var(--color-primary-dark)' },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out', 
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'zoom-in': 'zoomIn 0.3s ease-out forwards'
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        slideUp: { from: { opacity: 0, transform: 'translateY(20px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        zoomIn: { from: { transform: 'scale(0.95)', opacity: 0 }, to: { transform: 'scale(1)', opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --color-primary: #EA1D2C; --color-primary-dark: #b91c29; }
        body { background-color: #F3F4F6; color: #334155; -webkit-font-smoothing: antialiased; }
        .glass-header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .product-card { 
            background: white; border-radius: 12px; overflow: hidden; 
            transition: all 0.3s ease; border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: var(--color-primary); }

        /* Carousel Styles */
        .carousel-container { position: relative; width: 100%; overflow: hidden; }
        .carousel-track { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; }
        .carousel-slide { min-width: 100%; display: flex; align-items: center; justify-content: center; background: white; height: 100%; }
        
        .dot { height: 6px; width: 6px; border-radius: 50%; background: #cbd5e1; transition: all 0.3s; }
        .dot.active { width: 20px; border-radius: 10px; background: var(--color-primary); }

        .active-scale:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col min-h-screen relative">

    <!-- ERROR SCREEN -->
    <div id="errorScreen" class="fixed inset-0 z-[10000] bg-slate-900 hidden flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-slate-800 p-6 rounded-full mb-6 shadow-2xl"><i id="errorIcon" data-lucide="store" class="w-16 h-16 text-slate-400"></i></div>
        <h1 id="errorTitle" class="text-3xl font-bold text-white mb-3">Loja Indispon√≠vel</h1>
        <p id="errorMsg" class="text-slate-400 max-w-md">...</p>
    </div>

    <!-- INITIAL LOADER -->
    <div id="initialLoader" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-primary rounded-full animate-spin"></div>
        <p class="mt-4 text-xs font-bold text-slate-400 animate-pulse uppercase tracking-widest">Carregando Vitrine...</p>
    </div>

    <!-- STATUS BAR -->
    <div id="topStatusBar" class="bg-slate-900 text-white text-[10px] py-1.5 z-[51]">
        <div class="container mx-auto px-4 max-w-7xl flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="flex h-2 w-2 relative">
                    <span id="statusPing" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span id="statusDot" class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span id="storeStatusText" class="font-bold tracking-wide uppercase">Verificando...</span>
            </div>
            <div class="hidden md:block opacity-70">Pre√ßos e prazos podem variar</div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 glass-header">
        <div class="container mx-auto px-4 lg:px-8 max-w-7xl h-16 md:h-20 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2 cursor-pointer active-scale" onclick="resetAllFilters(); window.scrollTo({top:0, behavior:'smooth'})">
                <h1 id="storeNameDisplay" class="font-display font-bold text-xl md:text-2xl text-slate-800 leading-none">...</h1>
            </div>
            <div class="flex-1 max-w-lg mx-4 hidden md:flex items-center gap-2">
                <div class="flex items-center w-full bg-slate-100 rounded-full px-1 border border-transparent focus-within:border-primary/20 transition-all">
                    <div class="relative flex-grow">
                        <input type="text" oninput="handleSearchInput(this.value)" placeholder="O que voc√™ procura?" class="w-full bg-transparent border-none py-2.5 pl-10 pr-2 text-sm focus:ring-0">
                        <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <button onclick="openFilterDrawer()" class="p-2 m-1 rounded-full hover:bg-slate-200 bg-white border border-slate-200 text-slate-600 relative">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                        <span class="filter-badge-indicator absolute -top-1 -right-1 bg-primary text-white text-[9px] font-bold h-3.5 w-3.5 rounded-full flex items-center justify-center hidden border-2 border-white"></span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="toggleFavoritesView()" class="hidden md:flex p-2.5 rounded-full border border-slate-200 active-scale" title="Favoritos">
                    <i data-lucide="heart" class="w-5 h-5" id="headerHeartIcon"></i>
                </button>
                <button onclick="openCartModal()" class="flex items-center gap-2 p-2.5 rounded-full border border-slate-200 active-scale relative" id="cartButtonHeader">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span id="cartBadge" class="absolute -top-1 -right-1 bg-primary text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform duration-300">0</span>
                </button>
            </div>
        </div>
        <div class="md:hidden px-4 pb-3">
            <div class="flex items-center gap-2">
                <div class="flex-1 flex items-center bg-slate-100 rounded-lg pr-1">
                    <div class="relative flex-1">
                        <input type="text" oninput="handleSearchInput(this.value)" placeholder="Buscar..." class="w-full bg-transparent border-none py-3 pl-10 pr-2 text-sm focus:ring-0">
                        <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <button onclick="openFilterDrawer()" class="p-2.5 my-1 rounded-md bg-white border border-slate-200 text-slate-600 relative">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                        <span class="filter-badge-indicator absolute -top-1 -right-1 bg-primary text-white text-[9px] font-bold h-3.5 w-3.5 rounded-full flex items-center justify-center hidden border-2 border-white"></span>
                    </button>
                </div>
                <button onclick="toggleFavoritesView()" class="p-3 rounded-lg border border-slate-200 text-slate-600 active-scale">
                    <i data-lucide="heart" class="w-5 h-5" id="mobileHeartIcon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN APP -->
    <main id="app" class="flex-grow container mx-auto px-2 md:px-8 max-w-7xl pt-4 hidden opacity-0 transition-opacity duration-700">
        <div id="heroGridContainer" class="flex overflow-x-auto snap-x snap-mandatory gap-3 mb-6 pb-2 hide-scroll -mx-2 px-2 md:mx-0"></div>
        <nav class="sticky top-[115px] md:top-[80px] z-30 mb-6 -mx-2 px-2 md:mx-0"><div id="categoryContainer" class="flex items-center gap-2 overflow-x-auto hide-scroll py-2"></div></nav>
        <div id="catalogContainer" class="pb-20 space-y-10 min-h-[50vh]"></div>
        
        <!-- Empty States -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center animate-fade-in">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-400"><i data-lucide="search-x" class="w-8 h-8"></i></div>
            <h3 class="font-bold text-slate-800">Nenhum produto encontrado</h3>
            <button onclick="resetAllFilters()" class="mt-4 text-primary text-sm font-bold">Limpar filtros</button>
        </div>
        <div id="favoritesEmptyState" class="hidden flex flex-col items-center justify-center py-20 text-center animate-fade-in">
            <h3 class="font-bold text-slate-800">Sua lista est√° vazia ‚ù§Ô∏è</h3>
            <button onclick="resetAllFilters()" class="bg-slate-900 text-white px-6 py-3 rounded-xl mt-6">Ver Vitrine</button>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-slate-200 py-10 mt-auto">
        <div class="container mx-auto px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left"><h5 class="font-display font-bold text-xl text-slate-900 mb-1" id="footerStoreName">...</h5><p id="footerDescription" class="text-slate-500 text-sm">...</p></div>
            <div class="flex gap-4 text-sm font-semibold text-slate-600"><button onclick="openDeliveryModal()" class="flex items-center gap-1"><i data-lucide="truck" class="w-4 h-4"></i> Entrega</button><a id="footerWaLink" href="#" target="_blank" class="flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> Ajuda</a></div>
        </div>
    </footer>

    <!-- MODAL: DETALHES COM CARROSSEL -->
    <div id="modalDetails" class="fixed inset-0 z-[60] hidden flex items-end md:items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm pointer-events-auto" onclick="closeModalDetails()"></div>
        <div class="bg-white w-full max-w-2xl md:rounded-2xl rounded-t-2xl shadow-2xl pointer-events-auto relative flex flex-col max-h-[92vh] overflow-hidden animate-slide-up">
            
            <div class="absolute top-4 right-4 z-30 flex gap-2">
                <button onclick="shareProduct()" class="bg-white/90 p-2 rounded-full shadow-md backdrop-blur-sm transition-transform active:scale-90"><i data-lucide="share-2" class="w-5 h-5 text-slate-700"></i></button>
                <button onclick="closeModalDetails()" class="bg-white/90 p-2 rounded-full shadow-md backdrop-blur-sm transition-transform active:scale-90"><i data-lucide="x" class="w-5 h-5 text-slate-700"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <!-- CARROSSEL -->
                <div class="carousel-container h-72 md:h-96 group">
                    <div id="detailCarouselTrack" class="carousel-track h-full" 
                         ontouchstart="handleCarouselTouchStart(event)" 
                         ontouchend="handleCarouselTouchEnd(event)">
                        <!-- Slides ser√£o inseridos aqui -->
                    </div>
                    
                    <!-- Bot√µes Laterais (Desktop) -->
                    <button id="btnPrevSlide" onclick="prevSlide()" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-lg hidden md:opacity-0 md:group-hover:opacity-100 transition-opacity z-20">
                        <i data-lucide="chevron-left" class="w-6 h-6 text-slate-800"></i>
                    </button>
                    <button id="btnNextSlide" onclick="nextSlide()" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-lg hidden md:opacity-0 md:group-hover:opacity-100 transition-opacity z-20">
                        <i data-lucide="chevron-right" class="w-6 h-6 text-slate-800"></i>
                    </button>

                    <!-- Indicadores (Dots) -->
                    <div id="carouselDots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5 z-20"></div>
                </div>

                <div class="p-6 pb-24">
                    <div class="flex justify-between items-start mb-2">
                         <span id="detailCat" class="text-[10px] font-extrabold text-primary uppercase tracking-widest block pt-1"></span>
                         <button id="modalHeartBtn" onclick="toggleFavoriteCurrentDetail()" class="p-2 -mr-2 -mt-2 active-scale"><i data-lucide="heart" class="w-6 h-6 text-slate-300"></i></button>
                    </div>
                    <h2 id="detailName" class="font-display text-2xl md:text-3xl font-bold text-slate-900 mb-3 leading-tight"></h2>
                    <p id="detailDesc" class="text-slate-500 text-sm leading-relaxed mb-8"></p>
                    
                    <div id="sizesWrapper" class="hidden mb-6"><span class="text-xs font-bold text-slate-800 uppercase mb-3 block">Tamanho</span><div id="detailSizesContainer" class="flex flex-wrap gap-2"></div></div>
                    <div id="colorsWrapper" class="hidden mb-6"><span class="text-xs font-bold text-slate-800 uppercase mb-3 block">Cor</span><div id="detailColorsContainer" class="flex flex-wrap gap-2"></div></div>
                </div>
            </div>

            <!-- Footer Action Bar -->
            <div class="p-4 border-t flex items-center justify-between bg-white shadow-lg z-20 absolute bottom-0 w-full">
                <div><span id="detailOldPrice" class="text-xs text-slate-400 line-through"></span><span id="detailPrice" class="text-2xl font-display font-black text-slate-900 block tracking-tight"></span></div>
                <div class="flex gap-3">
                    <div class="flex items-center bg-slate-100 rounded-xl px-2 h-12"><button onclick="adjustDetailQty(-1)" class="w-8 font-bold text-slate-500">-</button><span id="detailQtyDisplay" class="font-bold w-6 text-center">1</span><button onclick="adjustDetailQty(1)" class="w-8 font-bold text-slate-500">+</button></div>
                    <button id="detailAddBtn" class="bg-primary text-white font-bold px-6 h-12 rounded-xl active-scale shadow-lg text-sm">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ZOOM MODAL -->
    <div id="modalImageZoom" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-md transition-opacity duration-300" onclick="closeImageZoom()">
        <button class="absolute top-4 right-4 text-white p-3"><i data-lucide="x" class="w-10 h-10"></i></button>
        <img id="zoomedImg" class="max-w-full max-h-full object-contain shadow-2xl transition-transform duration-300 transform scale-95">
    </div>

    <!-- MODAL: CARRINHO -->
    <div id="modalCart" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeCartModal()"></div>
        <div id="cartDrawer" class="absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="p-5 border-b flex justify-between items-center"><h3 class="font-bold text-lg">Sua Sacola</h3><button onclick="closeCartModal()"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div id="cartList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"></div>
            <div class="p-5 border-t bg-white space-y-4">
                <div id="cartEmptyMsg" class="hidden text-center text-slate-400 py-10">Sua sacola est√° vazia.</div>
                <div id="cartSummary" class="space-y-3">
                    <div class="bg-slate-50 p-3 rounded-lg border text-sm flex justify-between"><span>Entrega</span><select id="cartDeliverySelect" onchange="updateCartTotals()" class="bg-transparent font-bold outline-none text-right"></select></div>
                    <div class="flex justify-between text-lg font-bold"><span>Total</span><span id="cartFinalTotal"></span></div>
                    <button onclick="checkoutWhatsApp()" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2">Finalizar via WhatsApp <i data-lucide="message-circle" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed bottom-6 left-0 right-0 z-[9999] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const FIREBASE_CONFIG = { apiKey: "AIzaSyAdwsGBTApwOwqr37qCv72gdPRbipsZG0Q", authDomain: "meuestoque-1badc.firebaseapp.com", projectId: "meuestoque-1badc", storageBucket: "meuestoque-1badc.appspot.com", messagingSenderId: "730003067834", appId: "1:730003067834:web:b205f1ea59053345960383" };

        let db, STORE_ID = null;
        let allProducts=[], cart=[], whatsappNumber="", currentProductImages=[];
        let currentDetailId=null, currentDetailQty=1, currentImgIndex=0;
        let touchStartX=0, touchEndX=0;
        let filters = { search: "", category: null, sizes: [], colors: [] };
        let favorites = JSON.parse(localStorage.getItem('fav_vit_v1') || "[]");
        let isFavoritesView = false;

        const CHIP_DEFAULT = "border-slate-200 bg-slate-50 text-slate-600";
        const CHIP_SELECTED = "border-primary bg-primary text-white font-bold ring-2 ring-primary/20";

        document.addEventListener('DOMContentLoaded', () => {
            STORE_ID = new URLSearchParams(window.location.search).get('id');
            if (!STORE_ID) return showFatalError("Link Inv√°lido", "Verifique o ID da loja.");
            
            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth);
            onAuthStateChanged(auth, user => user && setupListeners());
        });

        function setupListeners() {
            onSnapshot(doc(db, `stores/${STORE_ID}/config/store`), s => {
                if(!s.exists()) return showFatalError("Loja n√£o encontrada", "ID inexistente.");
                const d = s.data();
                if(d.subscriptionStatus==='suspended') return showFatalError("Loja Suspensa", "Contacte o estabelecimento.");
                applyStoreConfig(d);
                document.getElementById('initialLoader').classList.add('opacity-0');
                setTimeout(()=> { document.getElementById('initialLoader').classList.add('hidden'); document.getElementById('app').classList.remove('hidden', 'opacity-0'); }, 500);
            });
            onSnapshot(collection(db, `stores/${STORE_ID}/products`), s => {
                allProducts = s.docs.map(d=>({id:d.id, ...d.data()})).filter(p=>p.status==='active');
                renderCategoryTabs(); renderCatalog(); populateFilterOptions();
            });
            onSnapshot(collection(db, `stores/${STORE_ID}/hero_cards`), s => renderHeroBanners(s.docs.map(d=>d.data())));
        }

        // --- CARROSSEL LOGIC ---
        window.showSlide = (idx) => {
            const track = document.getElementById('detailCarouselTrack');
            const dots = document.querySelectorAll('.dot');
            if(!track || !currentProductImages.length) return;
            
            if(idx >= currentProductImages.length) currentImgIndex = 0;
            else if(idx < 0) currentImgIndex = currentProductImages.length - 1;
            else currentImgIndex = idx;

            track.style.transform = `translateX(-${currentImgIndex * 100}%)`;
            dots.forEach((d, i) => d.classList.toggle('active', i === currentImgIndex));
        };

        window.nextSlide = () => showSlide(currentImgIndex + 1);
        window.prevSlide = () => showSlide(currentImgIndex - 1);

        window.handleCarouselTouchStart = (e) => touchStartX = e.changedTouches[0].screenX;
        window.handleCarouselTouchEnd = (e) => {
            touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 50) nextSlide();
            if (touchEndX - touchStartX > 50) prevSlide();
        };

        // --- UI RENDER ---
        function applyStoreConfig(d) {
            whatsappNumber = (d.whatsappNumber||"").replace(/\D/g,"");
            if(d.primaryColor) document.documentElement.style.setProperty('--color-primary', d.primaryColor);
            document.getElementById('storeNameDisplay').textContent = d.storeName;
            document.getElementById('footerStoreName').textContent = d.storeName;
            document.getElementById('footerDescription').textContent = d.footerText;
            document.getElementById('storeStatusText').textContent = d.isStoreOpen !== false ? "Loja Aberta Agora" : "Loja Fechada";
            document.getElementById('cartDeliverySelect').innerHTML = '<option value="0">Retirar na Loja</option>' + (d.deliveryAreas||[]).map(a=>`<option value="${a.fee}">${a.name} (R$ ${a.fee.toFixed(2)})</option>`).join('');
            lucide.createIcons();
        }

        function renderHeroBanners(banners) {
            const container = document.getElementById('heroGridContainer');
            container.innerHTML = banners.map(b => `
                <div class="min-w-[85vw] md:min-w-[420px] h-36 md:h-44 rounded-2xl p-6 flex flex-col justify-center relative overflow-hidden snap-center cursor-pointer flex-shrink-0 text-white shadow-sm" style="background:linear-gradient(135deg, ${b.color1}, ${b.color2})" onclick="selectCategory('${b.target}')">
                    <span class="inline-block py-1 px-3 rounded-full bg-white/20 text-[10px] font-bold uppercase mb-2">${b.tag}</span>
                    <h3 class="font-display font-bold text-xl leading-tight">${b.title}</h3>
                </div>`).join('');
        }

        function renderCategoryTabs() {
            const container = document.getElementById('categoryContainer');
            const cats = Array.from(new Set(allProducts.map(p=>p.category).filter(Boolean)));
            const mk = (id, label) => {
                const active = filters.category === id;
                return `<button onclick="selectCategory('${id}')" class="px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${active ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-slate-600 border-slate-200'}">${label}</button>`;
            }
            container.innerHTML = mk(null, 'Tudo') + mk('offers', 'üî• Ofertas') + cats.map(c => mk(c, c)).join('');
        }

        window.renderCatalog = () => {
            const container = document.getElementById('catalogContainer');
            const f = allProducts.filter(p => {
                if(isFavoritesView) return favorites.includes(p.id);
                if(filters.category === 'offers') return (p.promoValue < p.value);
                if(filters.category && p.category !== filters.category) return false;
                if(filters.search && !p.name.toLowerCase().includes(filters.search)) return false;
                return true;
            });

            if(!f.length) { 
                container.innerHTML = ''; 
                document.getElementById(isFavoritesView ? 'favoritesEmptyState' : 'emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('favoritesEmptyState').classList.add('hidden');

            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-5">
                    ${f.map(p => mkCard(p)).join('')}
                </div>`;
            lucide.createIcons();
        }

        function mkCard(p) {
            const hasPromo = p.promoValue < p.value;
            return `
                <div onclick="openProductModal('${p.id}')" class="product-card group flex flex-col h-full animate-fade-in cursor-pointer">
                    <div class="aspect-square bg-white relative overflow-hidden">
                        <img src="${p.images?.[0]||''}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://placehold.co/400?text=Sem+Foto'">
                        ${hasPromo ? `<span class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded-bl-lg">-${Math.round((p.value-p.promoValue)/p.value*100)}%</span>`:''}
                    </div>
                    <div class="p-3 flex flex-col flex-grow">
                        <h4 class="text-sm font-semibold text-slate-700 leading-snug line-clamp-2 mb-2">${p.name}</h4>
                        <div class="mt-auto">
                            ${hasPromo ? `<span class="text-[10px] text-slate-400 line-through block">R$ ${p.value.toFixed(2)}</span>` : '<span class="block h-3"></span>'}
                            <span class="text-lg font-black text-slate-900">R$ ${(hasPromo?p.promoValue:p.value).toFixed(2)}</span>
                        </div>
                    </div>
                </div>`;
        }

        // --- PRODUCT MODAL & CAROUSEL ---
        window.openProductModal = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            
            currentDetailId = id;
            currentDetailQty = 1;
            currentImgIndex = 0;
            currentProductImages = p.images || [];
            
            // Render Carousel Slides
            const track = document.getElementById('detailCarouselTrack');
            const dots = document.getElementById('carouselDots');
            
            track.innerHTML = currentProductImages.map(img => `
                <div class="carousel-slide cursor-zoom-in" onclick="openImageZoom()">
                    <img src="${img}" class="w-full h-full object-contain p-2" onerror="this.src='https://placehold.co/600?text=Produto'">
                </div>`).join('');
                
            dots.innerHTML = currentProductImages.length > 1 ? currentProductImages.map((_, i) => `<div class="dot ${i===0?'active':''}" onclick="showSlide(${i})"></div>`).join('') : '';
            
            // Hide arrows if only one image
            document.getElementById('btnPrevSlide').classList.toggle('hidden', currentProductImages.length <= 1);
            document.getElementById('btnNextSlide').classList.toggle('hidden', currentProductImages.length <= 1);

            document.getElementById('detailName').textContent = p.name;
            document.getElementById('detailCat').textContent = p.category;
            document.getElementById('detailDesc').textContent = p.description;
            document.getElementById('detailPrice').textContent = `R$ ${(p.promoValue < p.value ? p.promoValue : p.value).toFixed(2)}`;
            document.getElementById('detailQtyDisplay').textContent = "1";
            
            const r = (l, t, c, w) => {
                c.innerHTML = '';
                if(!l?.length) return w.classList.add('hidden');
                w.classList.remove('hidden');
                l.forEach(i => {
                    const d = document.createElement('div');
                    d.className = `px-4 py-2 border rounded-lg text-xs cursor-pointer ${CHIP_DEFAULT}`;
                    d.textContent = i;
                    d.onclick = () => {
                        Array.from(c.children).forEach(s => s.className = `px-4 py-2 border rounded-lg text-xs cursor-pointer ${CHIP_DEFAULT}`);
                        d.className = `px-4 py-2 border rounded-lg text-xs cursor-pointer ${CHIP_SELECTED}`;
                    };
                    c.appendChild(d);
                });
            };
            r(p.sizes, 'size', document.getElementById('detailSizesContainer'), document.getElementById('sizesWrapper'));
            r(p.colors, 'color', document.getElementById('detailColorsContainer'), document.getElementById('colorsWrapper'));

            document.getElementById('modalDetails').classList.remove('hidden');
            track.style.transform = `translateX(0)`;
            updateModalHeart();
            lucide.createIcons();
        };

        window.openImageZoom = () => {
            const img = currentProductImages[currentImgIndex];
            if(img) {
                document.getElementById('zoomedImg').src = img;
                document.getElementById('modalImageZoom').classList.remove('hidden');
            }
        };

        window.closeImageZoom = () => document.getElementById('modalImageZoom').classList.add('hidden');
        window.closeModalDetails = () => document.getElementById('modalDetails').classList.add('hidden');

        // --- CART & LOGIC ---
        window.addToCart = (p, q) => {
            const price = p.promoValue < p.value ? p.promoValue : p.value;
            const ex = cart.find(x => x.id === p.id);
            if(ex) ex.q += q; else cart.push({id:p.id, name:p.name, price, q, img:p.images?.[0]});
            updateCartUI(); showToast("Adicionado!");
        };

        function updateCartUI() {
            const cnt = cart.reduce((a,b)=>a+b.q, 0);
            const b = document.getElementById('cartBadge');
            b.textContent = cnt; b.classList.toggle('scale-0', cnt===0);
            updateCartTotals();
        }

        window.updateCartTotals = () => {
            const df = parseFloat(document.getElementById('cartDeliverySelect').value) || 0;
            const sub = cart.reduce((a,b)=>a+(b.price*b.q), 0);
            document.getElementById('cartFinalTotal').textContent = `R$ ${(sub+df).toFixed(2)}`;
        }

        window.checkoutWhatsApp = () => {
            const sub = cart.reduce((a,b)=>a+(b.price*b.q), 0);
            let msg = `*NOVO PEDIDO*\n\n`;
            cart.forEach(i => msg += `‚Ä¢ ${i.q}x ${i.name}\n`);
            msg += `\n*TOTAL:* R$ ${sub.toFixed(2)}`;
            window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`);
        }

        // --- HELPERS ---
        window.showToast = (msg) => {
            const t = document.createElement('div');
            t.className = "bg-slate-900 text-white text-sm px-6 py-3 rounded-full shadow-2xl animate-fade-in";
            t.innerHTML = `üõí ${msg}`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        window.selectCategory = (c) => { 
            filters.category = c === 'null' ? null : c; 
            isFavoritesView = false;
            renderCategoryTabs(); renderCatalog(); 
            window.scrollTo({top: 400, behavior: 'smooth'});
        };

        window.resetAllFilters = () => { filters={search:"", category:null, sizes:[], colors:[]}; isFavoritesView=false; renderCatalog(); renderCategoryTabs(); };
        window.toggleFavoritesView = () => { isFavoritesView = !isFavoritesView; renderCatalog(); };
        window.toggleFavorite = (id) => {
            const idx = favorites.indexOf(id);
            if(idx>-1) favorites.splice(idx,1); else favorites.push(id);
            localStorage.setItem('fav_vit_v1', JSON.stringify(favorites));
            renderCatalog(); updateModalHeart();
        };
        window.toggleFavoriteCurrentDetail = () => toggleFavorite(currentDetailId);
        function updateModalHeart() {
            const b = document.querySelector('#modalHeartBtn svg');
            if(favorites.includes(currentDetailId)) b.classList.add('fill-primary', 'text-primary');
            else b.classList.remove('fill-primary', 'text-primary');
        }

        function showFatalError(title, msg) {
            document.getElementById('initialLoader').classList.add('hidden');
            const e = document.getElementById('errorScreen');
            e.classList.remove('hidden');
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMsg').textContent = msg;
        }

        window.handleSearchInput = (v) => { filters.search = v.toLowerCase(); renderCatalog(); };
        window.openCartModal = () => { 
            document.getElementById('modalCart').classList.remove('hidden');
            setTimeout(() => document.getElementById('cartDrawer').classList.remove('translate-x-full'), 10);
            const l = document.getElementById('cartList');
            if(!cart.length) {
                l.innerHTML = '';
                document.getElementById('cartEmptyMsg').classList.remove('hidden');
                document.getElementById('cartSummary').classList.add('hidden');
            } else {
                document.getElementById('cartEmptyMsg').classList.add('hidden');
                document.getElementById('cartSummary').classList.remove('hidden');
                l.innerHTML = cart.map(i => `
                    <div class="flex gap-3 bg-white p-3 rounded-xl border border-slate-200">
                        <img src="${i.img}" class="w-16 h-16 rounded-lg object-cover bg-slate-50">
                        <div class="flex-1">
                            <div class="flex justify-between font-bold text-xs"><span>${i.name}</span><span>R$ ${i.price.toFixed(2)}</span></div>
                            <p class="text-[10px] text-slate-400 mt-1">${i.q} unidades</p>
                        </div>
                    </div>`).join('');
            }
        };
        window.closeCartModal = () => { document.getElementById('cartDrawer').classList.add('translate-x-full'); setTimeout(()=>document.getElementById('modalCart').classList.add('hidden'), 300); };
        window.adjustDetailQty = (d) => { currentDetailQty += d; if(currentDetailQty<1) currentDetailQty=1; document.getElementById('detailQtyDisplay').textContent = currentDetailQty; };

        lucide.createIcons();
    </script>
</body>
</html>

